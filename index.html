<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Mapas - Drag & Drop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- SweetAlert CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .container-fluid {
            max-width: 1800px;
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.95);
        }

        .card-header {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 15px 20px;
        }

        .drag-container {
            min-height: 150px;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 15px;
            background: #f8f9fa;
            transition: all 0.3s ease;
            max-height: 80dvh;
            overflow-y: auto;
        }

        .drag-container.drag-over {
            border-color: #1a2a6c;
            background: #e3f2fd;
            box-shadow: 0 0 20px rgba(26, 42, 108, 0.2);
        }

        .draggable-item {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: move;
            transition: all 0.3s ease;
            position: relative;
        }

        .draggable-item:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .draggable-item.dragging {
            opacity: 0.6;
            background: #e3f2fd;
            border-color: #1a2a6c;
        }

        .delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .delete-btn:hover {
            opacity: 1;
        }

        .color-badge {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .preview-map {
            height: 400px;
            border-radius: 10px;
            overflow: hidden;
            border: 3px solid #dee2e6;
        }

        .json-output {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            min-height: 400px;
            border-radius: 8px;
            padding: 15px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 13px;
            line-height: 1.4;
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            margin-bottom: 15px;
        }

        .stats-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .route-builder {
            background: #f8f9fa;
            border: 2px dashed #6c757d;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .flight-builder {
            background: #fff3cd;
            border: 2px dashed #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .maritime-builder {
            background: #d1ecf1;
            border: 2px dashed #17a2b8;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .icon-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
        }

        .icon-option {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.2em;
        }

        .icon-option:hover {
            border-color: #1a2a6c;
            transform: scale(1.1);
        }

        .icon-option.selected {
            border-color: #1a2a6c;
            background-color: #e3f2fd;
        }

        .icon-preview-img {
            width: 24px;
            height: 24px;
            margin-right: 8px;
            object-fit: contain;
        }

        .transport-icon {
            width: 20px;
            height: 20px;
            margin-right: 5px;
            object-fit: contain;
        }

        .custom-icon-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .icon-manager {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .emoji-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .emoji-option {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.2em;
        }

        .emoji-option:hover {
            border-color: #1a2a6c;
            transform: scale(1.1);
        }

        .emoji-option.selected {
            border-color: #1a2a6c;
            background-color: #e3f2fd;
        }

        .route-order {
            background: #ff4444;
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            position: absolute;
            top: -10px;
            left: -10px;
            z-index: 1000;
        }

        .popup-title {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 8px;
            padding-left: 10px;
            border-left: 4px solid;
        }

        .popup-country {
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            margin-top: 5px;
            display: inline-block;
        }

        .clean-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .clean-buttons .btn {
            flex: 1;
        }

        .city-in-route {
            border-left: 4px solid #28a745;
        }

        /* Estilos para el sistema de ayuda */
        .help-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: all 0.3s ease;
        }

        .help-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .help-tooltip {
            position: fixed;
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            max-width: 250px;
            z-index: 1050;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            pointer-events: none;
        }

        .help-tooltip::after {
            content: '';
            position: absolute;
            border-width: 5px;
            border-style: solid;
        }

        .help-tooltip.top::after {
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-color: #333 transparent transparent transparent;
        }

        .help-tooltip.bottom::after {
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-color: transparent transparent #333 transparent;
        }

        .help-section {
            margin-bottom: 25px;
        }

        .help-section h5 {
            border-bottom: 2px solid #1a2a6c;
            padding-bottom: 8px;
            margin-bottom: 15px;
        }

        .help-step {
            margin-bottom: 15px;
            padding-left: 20px;
            position: relative;
        }

        .help-step::before {
            content: "‚Ä¢";
            position: absolute;
            left: 0;
            color: #1a2a6c;
            font-weight: bold;
        }

        .routes-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
        }

        .route-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid;
        }

        .route-item.land-route {
            border-left-color: #28a745;
        }

        .route-item.flight-route {
            border-left-color: #ffc107;
        }

        .route-item.maritime-route {
            border-left-color: #17a2b8;
        }

        .route-info {
            flex-grow: 1;
        }

        .route-actions {
            display: flex;
            gap: 5px;
        }

        .tooltip-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            background: #6c757d;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 18px;
            font-size: 12px;
            margin-left: 5px;
            cursor: help;
        }

        .emoji-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            max-height: 200px;
            overflow-y: auto;
            padding: 5px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .emoji-option {
            width: 75px;
            height: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            padding: 5px;
        }

        .emoji-option:hover {
            border-color: #1a2a6c;
            transform: scale(1.05);
        }

        .emoji-option.selected {
            border-color: #1a2a6c;
            background-color: #e3f2fd;
        }

        .emoji-name {
            font-size: 10px;
            text-align: center;
            margin-top: 2px;
            word-break: break-word;
            max-width: 100%;
        }

        .header-gradient {
            background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 50%, #fdbb2d 100%);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .footer-gradient {
            background: linear-gradient(135deg, #343a40 0%, #495057 100%);
        }

        .nav-link {
            position: relative;
            transition: color 0.3s;
        }

        .nav-link::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: 0;
            left: 0;
            background-color: white;
            transition: width 0.3s;
        }

        .nav-link:hover::after {
            width: 100%;
        }

        .modal-content {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            color: white;
        }

        .terms-content {
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .scroll-to-top {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .scroll-to-top:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .editable {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .editable:focus {
            outline: 2px solid #86b7fe;
        }

        .table-container {
            position: relative;
        }

        .table-actions {
            position: absolute;
            right: 0;
            top: -40px;
        }

        .header-bg {
            background-color: #004697;
            color: white;
        }

        .code-container {
            position: relative;
        }

        .copy-btn {
            position: absolute;
            right: 10px;
            top: 10px;
            z-index: 10;
        }

        .sortable-handle {
            cursor: move;
            color: #6c757d;
        }

        /* Estilos para el header y footer */
        .main-header {
            background-color: #004697;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .main-footer {
            background-color: #343a40;
            color: white;
            padding: 20px 0;
            margin-top: 50px;
        }

        .logo {
            font-weight: 700;
            font-size: 1.5rem;
        }

        .nav-link {
            color: rgba(255, 255, 255, .8);
            transition: color 0.3s;
        }

        .nav-link:hover {
            color: white;
        }

        .footer-links a {
            color: rgba(255, 255, 255, .6);
            text-decoration: none;
            transition: color 0.3s;
        }

        .footer-links a:hover {
            color: white;
        }

        .social-icons a {
            color: white;
            margin-right: 15px;
            font-size: 1.2rem;
        }

        /* Estilos para el modal de acerca de */
        .profile-img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid #004697;
            margin: 0 auto 20px;
            display: block;
        }

        .social-link {
            display: inline-block;
            margin: 0 10px;
            font-size: 1.5rem;
            color: #004697;
            transition: transform 0.3s;
        }

        .social-link:hover {
            transform: scale(1.2);
            color: #003366;
        }

        .skill-badge {
            margin-right: 5px;
            margin-bottom: 5px;
        }

        /* Nuevos estilos para acciones de columnas */
        .column-header {
            position: relative;
        }

        .column-actions {
            position: absolute;
            top: 0;
            right: 0;
            display: none;
        }

        th:hover .column-actions {
            display: block;
        }

        .column-actions button {
            padding: 2px 5px;
            margin-left: 3px;
            font-size: 0.7rem;
            line-height: 1;
        }

        /* Nuevos estilos para la funcionalidad de edici√≥n */
        .editable-field {
            cursor: pointer;
            border-bottom: 1px dashed #6c757d;
            transition: all 0.2s ease;
        }

        .editable-field:hover {
            background-color: #f8f9fa;
            border-bottom: 1px solid #0d6efd;
        }

        .editing {
            background-color: #fff3cd !important;
            border: 1px solid #ffc107 !important;
            padding: 2px 4px;
            border-radius: 4px;
        }

        .edit-buttons {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .edit-btn {
            position: absolute;
            top: 8px;
            right: 35px;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .edit-btn:hover {
            opacity: 1;
        }

        .save-btn,
        .cancel-btn {
            font-size: 0.7rem;
            padding: 2px 6px;
        }
    </style>
</head>

<body>
    <header class="main-header header-gradient">
        <div class="container">
            <div class="row align-items-center py-3">
                <div class="col-md-6">
                    <div class="logo d-flex align-items-center">
                        <i class="fas fa-map-marked-alt me-2 fs-3" style="color: white;"></i>
                        <h1 class="h4 mb-0 fw-bold" style="color: white;">Generador de Mapas Interactivos</h1>
                    </div>
                </div>
                <div class="col-md-6">
                    <ul class="nav justify-content-end">
                        <li class="nav-item position-relative">
                            <a class="nav-link text-white" href="#">
                                <i class="fas fa-home me-1"></i> Inicio
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#" data-bs-toggle="modal" data-bs-target="#aboutModal">
                                <i class="fas fa-info-circle me-1"></i> Acerca de
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#" data-bs-toggle="modal"
                                data-bs-target="#contactModal">
                                <i class="fas fa-envelope me-1"></i> Contacto
                            </a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link text-white dropdown-toggle" href="#" id="legalDropdown" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-gavel me-1"></i> Legal
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="legalDropdown">
                                <li><a class="dropdown-item" href="#" data-bs-toggle="modal"
                                        data-bs-target="#termsModal">T√©rminos y Condiciones</a></li>
                                <li><a class="dropdown-item" href="#" data-bs-toggle="modal"
                                        data-bs-target="#privacyModal">Pol√≠tica de Privacidad</a></li>
                                <li><a class="dropdown-item" href="#" data-bs-toggle="modal"
                                        data-bs-target="#cookiesModal">Pol√≠tica de Cookies</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </header>
    <!-- Bot√≥n de ayuda flotante -->
    <button class="help-btn" onclick="showHelpModal()">
        <i class="fas fa-question"></i>
    </button>

    <div class="container-fluid">
        <div class="row">
            <!-- Panel de Control -->
            <div class="col-lg-4">
                <!-- Pa√≠ses -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-flag me-2"></i>Pa√≠ses
                                    <span class="tooltip-icon"
                                        title="Agrega pa√≠ses con sus banderas y colores para organizar tus ciudades">i</span>
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex gap-2 mb-3">
                                    <button class="btn btn-primary btn-sm flex-fill" onclick="showCountryModal()">
                                        <i class="fas fa-plus me-2"></i>Agregar Pa√≠s
                                    </button>
                                    <button class="btn btn-outline-info btn-sm flex-fill"
                                        onclick="loadCountriesFromDB()">
                                        <i class="fas fa-database me-2"></i>Cargar BD
                                    </button>
                                </div>
                                <div class="drag-container" id="countries-container"
                                    ondrop="dropInContainer(event, 'country')" ondragover="allowDrop(event)"
                                    ondragleave="dragLeave(event)">
                                    Arrastra pa√≠ses aqu√≠ o crea nuevos
                                </div>
                            </div>
                        </div>


                    </div>
                    <div class="col-md-6">
                        <!-- Ciudades -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-city me-2"></i>Ciudades
                                    <span class="tooltip-icon"
                                        title="Crea ciudades y as√≠gnalas a pa√≠ses. Las ciudades pueden arrastrarse a las rutas">i</span>
                                </h5>
                            </div>
                            <div class="card-body">
                                <button class="btn btn-primary btn-sm w-100 mb-3" onclick="showCityModal()">
                                    <i class="fas fa-plus me-2"></i>Agregar Ciudad
                                </button>

                                <div class="drag-container" id="cities-container"
                                    ondrop="dropInContainer(event, 'city')" ondragover="allowDrop(event)"
                                    ondragleave="dragLeave(event)">
                                    Arrastra ciudades aqu√≠ o crea nuevas
                                </div>
                            </div>
                        </div>
                    </div>
                </div>




                <!-- Gestor de Emojis -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-smile me-2"></i>Gestor de Emojis
                            <span class="tooltip-icon"
                                title="Agrega iconos personalizados para representar pa√≠ses">i</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="icon-manager">
                            <div class="mb-3">
                                <label class="form-label">Agregar Nuevo Emoji</label>
                                <div class="custom-icon-input">
                                    <input type="text" class="form-control" id="newEmojiName"
                                        placeholder="Nombre del emoji">
                                    <input type="text" class="form-control" id="newEmojiFile"
                                        placeholder="Archivo (ej: mexico.png)">
                                    <button class="btn btn-primary btn-sm" onclick="addCustomEmoji()">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Emojis Disponibles</label>
                                <div class="emoji-selector" id="customEmojisContainer">
                                    <!-- Se llena din√°micamente -->
                                </div>
                            </div>
                            <button class="btn btn-outline-secondary btn-sm w-100" onclick="clearCustomEmojis()">
                                <i class="fas fa-trash me-2"></i>Limpiar Emojis
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Estad√≠sticas -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Estad√≠sticas</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="stats-card">
                                    <div class="stats-number" id="countriesCount">0</div>
                                    <small>Pa√≠ses</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stats-card">
                                    <div class="stats-number" id="citiesCount">0</div>
                                    <small>Ciudades</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stats-card">
                                    <div class="stats-number" id="routesCount">0</div>
                                    <small>Rutas</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mapa y JSON -->
            <div class="col-lg-8">
                <!-- Mapa -->
                <div class="row">
                    <div class="col-md-8">
                        <!-- Constructor de Rutas -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Constructor de Rutas
                                    <span class="tooltip-icon"
                                        title="Arrastra ciudades aqu√≠ para crear nuevas rutas">i</span>
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <!-- Rutas Terrestres -->
                                        <div class="route-builder">
                                            <h6>üöó Rutas Terrestres</h6>
                                            <div class="drag-container" id="land-routes-container"
                                                ondrop="dropInRouteBuilder(event, 'land')" ondragover="allowDrop(event)"
                                                ondragleave="dragLeave(event)">
                                                Arrastra ciudades aqu√≠ para crear ruta terrestre
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label">Tipo de Transporte</label>
                                                <select class="form-control" id="landTransportType">
                                                    <!-- Se llena din√°micamente -->
                                                </select>
                                            </div>
                                            <button class="btn btn-success btn-sm w-100 mt-2"
                                                onclick="createLandRoute()">
                                                <i class="fas fa-check me-2"></i>Crear Ruta Terrestre
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <!-- Vuelos -->
                                        <div class="flight-builder mt-3">
                                            <h6>‚úàÔ∏è Vuelos</h6>
                                            <div class="drag-container" id="flight-routes-container"
                                                ondrop="dropInRouteBuilder(event, 'flight')"
                                                ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
                                                Arrastra 2 ciudades para crear vuelo (origen ‚Üí destino)
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label">Tipo de Vuelo</label>
                                                <select class="form-control" id="flightTransportType">
                                                    <!-- Se llena din√°micamente -->
                                                </select>
                                            </div>
                                            <button class="btn btn-warning btn-sm w-100 mt-2"
                                                onclick="createFlightRoute()">
                                                <i class="fas fa-plane me-2"></i>Crear Vuelo
                                            </button>
                                        </div>

                                    </div>
                                    <div class="col-md-4">
                                        <!-- Rutas Mar√≠timas -->
                                        <div class="maritime-builder mt-3">
                                            <h6>üö¢ Rutas Mar√≠timas</h6>
                                            <div class="drag-container" id="maritime-routes-container"
                                                ondrop="dropInRouteBuilder(event, 'maritime')"
                                                ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
                                                Arrastra ciudades para crear ruta mar√≠tima
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label">Tipo de Transporte</label>
                                                <select class="form-control" id="maritimeTransportType">
                                                    <!-- Se llena din√°micamente -->
                                                </select>
                                            </div>
                                            <button class="btn btn-info btn-sm w-100 mt-2"
                                                onclick="createMaritimeRoute()">
                                                <i class="fas fa-ship me-2"></i>Crear Ruta Mar√≠tima
                                            </button>
                                        </div>

                                    </div>
                                </div>




                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <!-- Gestor de Rutas -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-route me-2"></i>Gesti√≥n de Rutas
                                    <span class="tooltip-icon"
                                        title="Administra las rutas creadas. Puedes eliminar rutas individualmente">i</span>
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- Lista de Rutas Terrestres -->
                                <div class="mb-3">
                                    <h6><i class="fas fa-road me-2"></i>Rutas Terrestres</h6>
                                    <div class="routes-list" id="land-routes-list">
                                        <!-- Se llena din√°micamente -->
                                    </div>
                                </div>

                                <!-- Lista de Vuelos -->
                                <div class="mb-3">
                                    <h6><i class="fas fa-plane me-2"></i>Vuelos</h6>
                                    <div class="routes-list" id="flight-routes-list">
                                        <!-- Se llena din√°micamente -->
                                    </div>
                                </div>

                                <!-- Lista de Rutas Mar√≠timas -->
                                <div class="mb-3">
                                    <h6><i class="fas fa-ship me-2"></i>Rutas Mar√≠timas</h6>
                                    <div class="routes-list" id="maritime-routes-list">
                                        <!-- Se llena din√°micamente -->
                                    </div>
                                </div>

                                <div class="clean-buttons">
                                    <button class="btn btn-outline-danger" onclick="clearAllRoutes()">
                                        <i class="fas fa-broom me-2"></i>Limpiar Todas las Rutas
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-map me-2"></i>Vista Previa del Mapa
                            <span class="tooltip-icon"
                                title="El mapa muestra las ciudades y rutas que has creado. Haz clic en los marcadores para m√°s informaci√≥n">i</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="previewMap" class="preview-map"></div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <input type="text" class="form-control" id="mapTitle" value="üåè Mapa de Viaje"
                                    placeholder="T√≠tulo del mapa">
                            </div>
                            <div class="col-md-3">
                                <input type="number" class="form-control" id="mapZoom" value="4" min="1" max="18"
                                    placeholder="Zoom">
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-info w-100" onclick="updateMapView()">
                                    <i class="fas fa-sync me-2"></i>Actualizar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- JSON Output -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-code me-2"></i>JSON Generado
                            <span class="tooltip-icon"
                                title="Genera el c√≥digo JSON para usar en tu aplicaci√≥n. Tambi√©n puedes cargar datos desde JSON existente">i</span>
                        </h5>
                        <div>
                            <button class="btn btn-success btn-sm me-2" onclick="generateJSON()">
                                <i class="fas fa-sync me-2"></i>Generar JSON
                            </button>
                            <button class="btn btn-dark btn-sm" onclick="copyToClipboard()">
                                <i class="fas fa-copy me-2"></i>Copiar
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="json-output" id="jsonOutput">
                            // El JSON se generar√° aqu√≠...
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-outline-primary me-2" onclick="loadFromJSON()">
                                <i class="fas fa-upload me-2"></i>Cargar desde JSON
                            </button>
                            <button class="btn btn-outline-info me-2" onclick="saveCountriesToDB()">
                                <i class="fas fa-save me-2"></i>Guardar Pa√≠ses
                            </button>
                            <button class="btn btn-outline-danger" onclick="clearAllData()">
                                <i class="fas fa-trash me-2"></i>Limpiar Todo
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="aboutModal" tabindex="-1" aria-labelledby="aboutModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aboutModalLabel">Acerca del Desarrollador</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img src="https://kevingil12c.github.io/portafolio-kevscl/assets/images/icon.jpeg"
                        alt="Tu foto de perfil" class="profile-img">
                    <h3>Kevin Jes√∫s Coyote Gil</h3>
                    <p class="text-muted">Desarrollador Web</p>

                    <div class="my-4">
                        <p>¬°Hola! Soy un apasionado desarrollador web con experiencia en creaci√≥n de herramientas √∫tiles
                            como este generador de mapas (json).</p>
                        <p>Especializado en frontend con HTML, CSS, JavaScript y frameworks modernos, pero tambi√©n con
                            s√≥lidos conocimientos en backend.</p>
                    </div>

                    <h4 class="mt-4">Mis Habilidades</h4>
                    <div class="mb-4">
                        <span class="badge bg-primary skill-badge">HTML5</span>
                        <span class="badge bg-primary skill-badge">CSS3</span>
                        <span class="badge bg-primary skill-badge">JavaScript</span>
                        <span class="badge bg-primary skill-badge">Bootstrap</span>
                        <span class="badge bg-primary skill-badge">jQuery</span>
                        <span class="badge bg-success skill-badge">React</span>
                        <span class="badge bg-success skill-badge">Node.js</span>
                        <span class="badge bg-success skill-badge">PHP</span>
                        <span class="badge bg-info skill-badge">MySQL</span>
                        <span class="badge bg-info skill-badge">SQLite</span>
                        <span class="badge bg-warning skill-badge">Git</span>
                        <span class="badge bg-warning skill-badge">GitHub</span>
                    </div>

                    <h4 class="mt-4">Con√©ctate Conmigo</h4>
                    <div class="social-links my-3">
                        <!-- Reemplaza los # con tus enlaces reales -->
                        <a href="https://github.com/KevinGil12C" target="_blank" class="social-link" title="GitHub"
                            target="_blank">
                            <i class="fab fa-github"></i>
                        </a>
                        <a href="https://www.linkedin.com/in/kevin-jesus-coyote-gil-030287288/" target="_blank"
                            class="social-link" title="LinkedIn" target="_blank">
                            <i class="fab fa-linkedin"></i>
                        </a>
                        <a href="#" target="_blank" class="social-link" title="Twitter" target="_blank">
                            <i class="fab fa-twitter"></i>
                        </a>
                        <a href="https://kevingil12c.github.io/portafolio-kevscl/" target="_blank" class="social-link"
                            title="Portafolio" target="_blank">
                            <i class="fas fa-briefcase"></i>
                        </a>
                        <a href="https://kevingil12c.github.io/blog_seguridad_informacion/" target="_blank"
                            class="social-link" title="Blog" target="_blank">
                            <i class="fab fa-medium"></i>
                        </a>
                        <a href="mailto:kebo.jcg77@gmail.com" class="social-link" title="Email" target="_blank">
                            <i class="fas fa-envelope"></i>
                        </a>
                    </div>

                    <div class="mt-4">
                        <a href="https://cvdesignr.com/p/6699d06173214" download class="btn btn-primary me-2"
                            target="_blank">
                            <i class="fas fa-download me-1"></i> Descargar CV
                        </a>
                        <a href="https://api.whatsapp.com/send?phone=7221595250" class="btn btn-success"
                            target="_blank">
                            <i class="fab fa-whatsapp me-1"></i> Contactar por WhatsApp
                        </a>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="main-footer footer-gradient text-white py-4">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 mb-4 mb-lg-0">
                    <h5 class="mb-3 fw-bold">
                        <i class="fas fa-map-marked-alt me-2"></i>Generador de Mapas
                    </h5>
                    <p class="mb-3">Herramienta interactiva para crear mapas personalizados con OpenStreetMap. Dise√±a
                        rutas terrestres, a√©reas y mar√≠timas de forma visual.</p>
                    <div class="d-flex">
                        <a href="#" class="btn btn-outline-light btn-sm me-2" data-bs-toggle="modal"
                            data-bs-target="#aboutModal">
                            <i class="fas fa-info-circle me-1"></i> Acerca de
                        </a>
                        <a href="#" class="btn btn-outline-light btn-sm" data-bs-toggle="modal"
                            data-bs-target="#contactModal">
                            <i class="fas fa-envelope me-1"></i> Contacto
                        </a>
                    </div>
                </div>
                <div class="col-lg-4 mb-4 mb-lg-0">
                    <h5 class="mb-3 fw-bold">Enlaces √∫tiles</h5>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <a href="https://github.com/KevinGil12C/generate_map"
                                class="text-white text-decoration-none" target="_blank">
                                <i class="fas fa-external-link-alt me-2"></i>Documentaci√≥n
                            </a>
                        </li>
                        <li class="mb-2">
                            <a href="#" class="text-white text-decoration-none" data-bs-toggle="modal"
                                data-bs-target="#aboutModal">
                                <i class="fas fa-user me-2"></i>Acerca del desarrollador
                            </a>
                        </li>
                        <li class="mb-2">
                            <a href="#" class="text-white text-decoration-none" data-bs-toggle="modal"
                                data-bs-target="#tutorialModal">
                                <i class="fas fa-play-circle me-2"></i>Tutoriales
                            </a>
                        </li>
                        <li>
                            <a href="#" class="text-white text-decoration-none" data-bs-toggle="modal"
                                data-bs-target="#supportModal">
                                <i class="fas fa-life-ring me-2"></i>Soporte
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="col-lg-4">
                    <h5 class="mb-3 fw-bold">Contacto</h5>
                    <p class="mb-2">
                        <i class="fas fa-envelope me-2"></i> kebo.jcg77@gmail.com
                    </p>
                    <p class="mb-3">
                        <i class="fas fa-map-marker-alt me-2"></i> M√©xico
                    </p>
                    <div class="social-icons">
                        <a href="https://github.com/KevinGil12C" target="_blank" class="text-white me-3 fs-5"
                            title="GitHub">
                            <i class="fab fa-github"></i>
                        </a>
                        <a href="https://www.linkedin.com/in/kevin-jesus-coyote-gil-030287288/" target="_blank"
                            class="text-white me-3 fs-5" title="LinkedIn">
                            <i class="fab fa-linkedin"></i>
                        </a>
                        <a href="https://twitter.com/tuusuario" target="_blank" class="text-white me-3 fs-5"
                            title="Twitter">
                            <i class="fab fa-twitter"></i>
                        </a>
                        <a href="https://kevingil12c.github.io/portafolio-kevscl/" target="_blank"
                            class="text-white me-3 fs-5" title="Portafolio">
                            <i class="fas fa-briefcase"></i>
                        </a>
                    </div>
                </div>
            </div>
            <hr class="my-4 bg-light opacity-25">
            <div class="row align-items-center">
                <div class="col-md-6 text-center text-md-start">
                    <p class="mb-0">&copy; 2025 Generador de Mapas. Todos los derechos reservados.</p>
                </div>
                <div class="col-md-6 text-center text-md-end">
                    <p class="mb-0">
                        <a href="#" class="text-white text-decoration-none me-3" data-bs-toggle="modal"
                            data-bs-target="#termsModal">T√©rminos</a>
                        <a href="#" class="text-white text-decoration-none me-3" data-bs-toggle="modal"
                            data-bs-target="#privacyModal">Privacidad</a>
                        <a href="#" class="text-white text-decoration-none" data-bs-toggle="modal"
                            data-bs-target="#cookiesModal">Cookies</a>
                    </p>
                </div>
            </div>
        </div>
    </footer>
    <!-- Modal Pa√≠s -->
    <div class="modal fade" id="countryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nuevo Pa√≠s</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">ID (clave √∫nica)</label>
                        <input type="text" class="form-control" id="countryId" placeholder="mexico, espa√±a, francia">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nombre del Pa√≠s</label>
                        <input type="text" class="form-control" id="countryName" placeholder="M√©xico">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Emoji (Bandera)</label>
                        <div class="emoji-selector" id="countryEmojiSelector">
                            <!-- Se llena din√°micamente -->
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Color</label>
                        <input type="color" class="form-control" id="countryColor" value="#4a6fa5">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="addCountry()">Agregar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ciudad -->
    <div class="modal fade" id="cityModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nueva Ciudad</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Nombre de la Ciudad</label>
                                <input type="text" class="form-control" id="cityName" placeholder="Ciudad de M√©xico">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Pa√≠s</label>
                                <select class="form-control" id="cityCountry">
                                    <!-- Se llena din√°micamente -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Descripci√≥n</label>
                                <textarea class="form-control" id="cityDescription" rows="2"
                                    placeholder="Descripci√≥n de la ciudad..."></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Coordenadas</label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <input type="number" class="form-control" id="cityLat" step="0.0001"
                                            placeholder="Latitud" value="19.4326">
                                    </div>
                                    <div class="col-md-6">
                                        <input type="number" class="form-control" id="cityLng" step="0.0001"
                                            placeholder="Longitud" value="-99.1332">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="addCity()">Agregar Ciudad</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para cargar JSON -->
    <div class="modal fade" id="jsonModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cargar desde JSON</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Pega tu JSON aqu√≠:</label>
                        <textarea class="form-control" id="jsonInput" rows="15"
                            placeholder='{"config": {...}, "cities": [...], "routes": [...], "flights": [...], "maritimeRoutes": [...]}'></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="processJSON()">Cargar Datos</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Ayuda -->
    <div class="modal fade" id="helpModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-question-circle me-2"></i>Ayuda - Generador de Mapas</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="help-section">
                        <h5>¬øC√≥mo usar el Generador de Mapas?</h5>
                        <p>Esta herramienta te permite crear mapas interactivos con pa√≠ses, ciudades y rutas de
                            diferentes tipos.</p>

                        <div class="help-step">
                            <strong>1. Crear Pa√≠ses:</strong> Haz clic en "Agregar Pa√≠s" para definir pa√≠ses con su
                            bandera y color.
                        </div>
                        <div class="help-step">
                            <strong>2. Crear Ciudades:</strong> Agrega ciudades asign√°ndolas a un pa√≠s y especificando
                            sus coordenadas.
                        </div>
                        <div class="help-step">
                            <strong>3. Crear Rutas:</strong> Arrastra ciudades a los contenedores de rutas para crear
                            conexiones terrestres, a√©reas o mar√≠timas.
                        </div>
                        <div class="help-step">
                            <strong>4. Gestionar Rutas:</strong> En la secci√≥n "Gesti√≥n de Rutas" puedes ver y eliminar
                            rutas individualmente.
                        </div>
                        <div class="help-step">
                            <strong>5. Personalizar Emojis:</strong> Agrega iconos personalizados para representar
                            pa√≠ses o tipos de transporte.
                        </div>
                        <div class="help-step">
                            <strong>6. Generar JSON:</strong> Una vez completado tu mapa, genera el c√≥digo JSON para
                            usar en tu aplicaci√≥n.
                        </div>
                    </div>

                    <div class="help-section">
                        <h5>Tipos de Rutas</h5>
                        <div class="help-step">
                            <strong>Rutas Terrestres:</strong> Conectan m√∫ltiples ciudades por tierra. Necesitas al
                            menos 2 ciudades.
                        </div>
                        <div class="help-step">
                            <strong>Vuelos:</strong> Conectan exactamente 2 ciudades (origen y destino).
                        </div>
                        <div class="help-step">
                            <strong>Rutas Mar√≠timas:</strong> Conectan ciudades por mar. Necesitas al menos 2 ciudades.
                        </div>
                    </div>

                    <div class="help-section">
                        <h5>Consejos y Trucos</h5>
                        <div class="help-step">
                            <strong>Eliminar rutas individuales:</strong> Usa el bot√≥n de eliminar (üóëÔ∏è) en cada ruta
                            para quitarla sin afectar las dem√°s.
                        </div>
                        <div class="help-step">
                            <strong>Guardar tu trabajo:</strong> Usa "Guardar Pa√≠ses" para almacenar tus pa√≠ses en el
                            navegador.
                        </div>
                        <div class="help-step">
                            <strong>Cargar desde JSON:</strong> Si tienes datos en formato JSON, puedes cargarlos
                            directamente.
                        </div>
                        <div class="help-step">
                            <strong>Coordenadas:</strong> Usa servicios como Google Maps para obtener coordenadas
                            precisas.
                        </div>
                        <div class="help-step">
                            <strong>Vista previa:</strong> El mapa se actualiza autom√°ticamente mientras trabajas.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal T√©rminos y Condiciones -->
    <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="termsModalLabel">
                        <i class="fas fa-file-contract me-2"></i>T√©rminos y Condiciones
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="terms-content">
                        <h5>1. Aceptaci√≥n de los T√©rminos</h5>
                        <p>Al acceder y utilizar el Generador de Mapas, usted acepta cumplir con estos t√©rminos y
                            condiciones, as√≠ como con nuestra pol√≠tica de privacidad.</p>

                        <h5>2. Uso del Servicio</h5>
                        <p>El Generador de Mapas es una herramienta gratuita para crear mapas personalizados. Usted es
                            responsable del contenido que genere y comparta.</p>

                        <h5>3. Propiedad Intelectual</h5>
                        <p>Los mapas generados son de su propiedad, pero el c√≥digo fuente y la interfaz de la aplicaci√≥n
                            pertenecen al desarrollador.</p>

                        <h5>4. Limitaci√≥n de Responsabilidad</h5>
                        <p>El servicio se proporciona "tal cual" sin garant√≠as de ning√∫n tipo. No nos hacemos
                            responsables por la precisi√≥n de los datos en los mapas generados.</p>

                        <h5>5. Modificaciones</h5>
                        <p>Nos reservamos el derecho de modificar estos t√©rminos en cualquier momento. Los cambios
                            entrar√°n en vigor inmediatamente despu√©s de su publicaci√≥n.</p>

                        <h5>6. Terminaci√≥n</h5>
                        <p>Podemos suspender o terminar su acceso al servicio si viola estos t√©rminos y condiciones.</p>

                        <p class="mt-4"><strong>Fecha de √∫ltima actualizaci√≥n:</strong> Noviembre 2025</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="acceptTerms()">Aceptar T√©rminos</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Pol√≠tica de Privacidad -->
    <div class="modal fade" id="privacyModal" tabindex="-1" aria-labelledby="privacyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="privacyModalLabel">
                        <i class="fas fa-shield-alt me-2"></i>Pol√≠tica de Privacidad
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="terms-content">
                        <h5>1. Informaci√≥n que Recopilamos</h5>
                        <p>El Generador de Mapas recopila √∫nicamente la informaci√≥n necesaria para el funcionamiento de
                            la aplicaci√≥n, como preferencias de usuario y datos de mapas generados.</p>

                        <h5>2. Uso de la Informaci√≥n</h5>
                        <p>Utilizamos la informaci√≥n para mejorar la experiencia del usuario y el funcionamiento de la
                            aplicaci√≥n. No compartimos informaci√≥n personal con terceros.</p>

                        <h5>3. Almacenamiento de Datos</h5>
                        <p>Los datos de los mapas se almacenan localmente en su navegador. No almacenamos informaci√≥n
                            personal en nuestros servidores.</p>

                        <h5>4. Cookies</h5>
                        <p>Utilizamos cookies para mejorar la funcionalidad de la aplicaci√≥n. Puede desactivarlas en la
                            configuraci√≥n de su navegador.</p>

                        <h5>5. Seguridad</h5>
                        <p>Implementamos medidas de seguridad para proteger sus datos, aunque ninguna transmisi√≥n por
                            Internet es 100% segura.</p>

                        <h5>6. Sus Derechos</h5>
                        <p>Usted tiene derecho a acceder, corregir o eliminar sus datos personales. Contacte con
                            nosotros para ejercer estos derechos.</p>

                        <p class="mt-4"><strong>Fecha de √∫ltima actualizaci√≥n:</strong> Noviembre 2025</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Pol√≠tica de Cookies -->
    <div class="modal fade" id="cookiesModal" tabindex="-1" aria-labelledby="cookiesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cookiesModalLabel">
                        <i class="fas fa-cookie me-2"></i>Pol√≠tica de Cookies
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="terms-content">
                        <h5>1. ¬øQu√© son las Cookies?</h5>
                        <p>Las cookies son peque√±os archivos de texto que se almacenan en su dispositivo cuando visita
                            nuestro sitio web.</p>

                        <h5>2. Tipos de Cookies que Utilizamos</h5>
                        <ul>
                            <li><strong>Cookies Esenciales:</strong> Necesarias para el funcionamiento b√°sico del sitio.
                            </li>
                            <li><strong>Cookies de Funcionalidad:</strong> Permiten recordar sus preferencias.</li>
                            <li><strong>Cookies de Rendimiento:</strong> Nos ayudan a mejorar el sitio recopilando
                                informaci√≥n an√≥nima.</li>
                        </ul>

                        <h5>3. C√≥mo Controlar las Cookies</h5>
                        <p>Puede controlar y/o eliminar las cookies seg√∫n desee. Puede eliminar todas las cookies que ya
                            est√°n en su equipo y configurar la mayor√≠a de los navegadores para impedir que se coloquen.
                        </p>

                        <h5>4. Cookies de Terceros</h5>
                        <p>Utilizamos servicios de terceros como Bootstrap, FontAwesome y Leaflet que pueden utilizar
                            cookies para mejorar su experiencia.</p>

                        <h5>5. Cambios en la Pol√≠tica de Cookies</h5>
                        <p>Podemos actualizar esta pol√≠tica ocasionalmente. Le recomendamos revisarla peri√≥dicamente.
                        </p>

                        <p class="mt-4"><strong>Fecha de √∫ltima actualizaci√≥n:</strong> Noviembre 2025</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="acceptCookies()">Aceptar Cookies</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Contacto -->
    <div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="contactModalLabel">
                        <i class="fas fa-envelope me-2"></i>Contacto
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="contactForm">
                        <div class="mb-3">
                            <label for="contactName" class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="contactName" required>
                        </div>
                        <div class="mb-3">
                            <label for="contactEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="contactEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="contactSubject" class="form-label">Asunto</label>
                            <input type="text" class="form-control" id="contactSubject" required>
                        </div>
                        <div class="mb-3">
                            <label for="contactMessage" class="form-label">Mensaje</label>
                            <textarea class="form-control" id="contactMessage" rows="4" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="sendToWhatsApp()">Enviar Mensaje</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Tutoriales -->
    <div class="modal fade" id="tutorialModal" tabindex="-1" aria-labelledby="tutorialModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tutorialModalLabel">
                        <i class="fas fa-play-circle me-2"></i>Tutoriales
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-flag fa-3x text-primary mb-3"></i>
                                    <h5>Crear Pa√≠ses</h5>
                                    <p>Aprende a agregar y personalizar pa√≠ses con banderas y colores.</p>
                                    <button class="btn btn-outline-primary btn-sm">Ver Tutorial</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-city fa-3x text-success mb-3"></i>
                                    <h5>Agregar Ciudades</h5>
                                    <p>Descubre c√≥mo crear ciudades y asignarlas a pa√≠ses.</p>
                                    <button class="btn btn-outline-success btn-sm">Ver Tutorial</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-route fa-3x text-warning mb-3"></i>
                                    <h5>Crear Rutas</h5>
                                    <p>Aprende a conectar ciudades con diferentes tipos de rutas.</p>
                                    <button class="btn btn-outline-warning btn-sm">Ver Tutorial</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-code fa-3x text-info mb-3"></i>
                                    <h5>Exportar JSON</h5>
                                    <p>Genera y utiliza el c√≥digo JSON en tus proyectos.</p>
                                    <button class="btn btn-outline-info btn-sm">Ver Tutorial</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Soporte -->
    <div class="modal fade" id="supportModal" tabindex="-1" aria-labelledby="supportModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="supportModalLabel">
                        <i class="fas fa-life-ring me-2"></i>Soporte
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <i class="fas fa-headset fa-3x text-primary mb-3"></i>
                        <h4>¬øNecesitas ayuda?</h4>
                        <p>Estamos aqu√≠ para ayudarte con cualquier problema o pregunta que tengas sobre el Generador de
                            Mapas.</p>
                    </div>
                    <div class="d-grid gap-2">
                        <a href="mailto:kebo.jcg77@gmail.com" class="btn btn-primary">
                            <i class="fas fa-envelope me-2"></i>Enviar Email
                        </a>
                        <a href="https://api.whatsapp.com/send?phone=7221595250" class="btn btn-success"
                            target="_blank">
                            <i class="fab fa-whatsapp me-2"></i>Contactar por WhatsApp
                        </a>
                        <a href="https://github.com/KevinGil12C/generate_map/issues" class="btn btn-dark"
                            target="_blank">
                            <i class="fab fa-github me-2"></i>Reportar Problema en GitHub
                        </a>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- SweetAlert JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Variables globales
        let countries = {};
        let cities = [];
        let routes = [];
        let flights = [];
        let maritimeRoutes = [];
        let map;
        let currentLandRouteCities = [];
        let currentFlightCities = [];
        let currentMaritimeRouteCities = [];
        let customEmojis = {};
        let routeIndexCounter = 1;

        // Inicializar mapa
        function initMap() {
            map = L.map('previewMap').setView([19.4326, -99.1332], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
        }

        // Sistema de ayuda
        function showHelpModal() {
            new bootstrap.Modal(document.getElementById('helpModal')).show();
        }

        // Inicializar tooltips
        function initTooltips() {
            // Agregar eventos para mostrar tooltips personalizados
            document.querySelectorAll('.tooltip-icon').forEach(icon => {
                icon.addEventListener('mouseenter', function (e) {
                    const title = this.getAttribute('title');
                    if (title) {
                        const tooltip = document.createElement('div');
                        tooltip.className = 'help-tooltip top';
                        tooltip.textContent = title;
                        document.body.appendChild(tooltip);

                        const rect = this.getBoundingClientRect();
                        tooltip.style.top = (rect.top - tooltip.offsetHeight - 10) + 'px';
                        tooltip.style.left = (rect.left + rect.width / 2 - tooltip.offsetWidth / 2) + 'px';

                        this._tooltip = tooltip;
                    }
                });

                icon.addEventListener('mousemove', function (e) {
                    if (this._tooltip) {
                        const rect = this.getBoundingClientRect();
                        this._tooltip.style.top = (rect.top - this._tooltip.offsetHeight - 10) + 'px';
                        this._tooltip.style.left = (rect.left + rect.width / 2 - this._tooltip.offsetWidth / 2) + 'px';
                    }
                });

                icon.addEventListener('mouseleave', function () {
                    if (this._tooltip) {
                        this._tooltip.remove();
                        this._tooltip = null;
                    }
                });
            });
        }

        // Sistema de iconos simplificado para medios de transporte
        function loadCustomIcons() {
            // Solo 3 iconos para los tipos de ruta
            const transportIcons = {
                'terrestre': 'icons/destiny/autobus.png',
                'aereo': 'icons/destiny/vuelo.png',
                'maritimo': 'icons/destiny/barco.png'
            };

            updateTransportSelectors(transportIcons);
        }

        function updateTransportSelectors(icons) {
            const landSelect = document.getElementById('landTransportType');
            const flightSelect = document.getElementById('flightTransportType');
            const maritimeSelect = document.getElementById('maritimeTransportType');

            // Limpiar selectores
            landSelect.innerHTML = '';
            flightSelect.innerHTML = '';
            maritimeSelect.innerHTML = '';

            // Agregar opciones para cada tipo de ruta
            Object.keys(icons).forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type.charAt(0).toUpperCase() + type.slice(1);
                option.dataset.icon = icons[type];

                // Asignar a los selectores correspondientes
                if (type === 'terrestre') {
                    landSelect.appendChild(option);
                } else if (type === 'aereo') {
                    flightSelect.appendChild(option);
                } else if (type === 'maritimo') {
                    maritimeSelect.appendChild(option);
                }
            });
        }

        function loadCustomEmojis() {
            const savedEmojis = localStorage.getItem('mapGeneratorCustomEmojis');
            if (savedEmojis) {
                customEmojis = JSON.parse(savedEmojis);
            } else {
                // Emojis por defecto para banderas - LISTA ACTUALIZADA
                customEmojis = {
                    'abkhazia': 'banderas/Abkhazia.ico',
                    'afghanistan': 'banderas/Afghanistan.ico',
                    'aland': 'banderas/Aland.ico',
                    'albania': 'banderas/Albania.ico',
                    'algeria': 'banderas/Algeria.ico',
                    'american-samoa': 'banderas/American-Samoa.ico',
                    'andorra': 'banderas/Andorra.ico',
                    'angola': 'banderas/Angola.ico',
                    'anguilla': 'banderas/Anguilla.ico',
                    'antarctica': 'banderas/Antarctica.ico',
                    'antigua-and-barbuda': 'banderas/Antigua-and-Barbuda.ico',
                    'argentina': 'banderas/Argentina.ico',
                    'armenia': 'banderas/Armenia.ico',
                    'aruba': 'banderas/Aruba.ico',
                    'australia': 'banderas/Australia.ico',
                    'austria': 'banderas/Austria.ico',
                    'azerbaijan': 'banderas/Azerbaijan.ico',
                    'bahamas': 'banderas/Bahamas.ico',
                    'bahrain': 'banderas/Bahrain.ico',
                    'bangladesh': 'banderas/Bangladesh.ico',
                    'barbados': 'banderas/Barbados.ico',
                    'basque-country': 'banderas/Basque-Country.ico',
                    'belarus': 'banderas/Belarus.ico',
                    'belgium': 'banderas/Belgium.ico',
                    'belize': 'banderas/Belize.ico',
                    'benin': 'banderas/Benin.ico',
                    'bermuda': 'banderas/Bermuda.ico',
                    'bhutan': 'banderas/Bhutan.ico',
                    'bolivia': 'banderas/Bolivia.ico',
                    'bosnia-and-herzegovina': 'banderas/Bosnia-and-Herzegovina.ico',
                    'botswana': 'banderas/Botswana.ico',
                    'brazil': 'banderas/Brazil.ico',
                    'british-antarctic-territory': 'banderas/British-Antarctic-Territory.ico',
                    'british-virgin-islands': 'banderas/British-Virgin-Islands.ico',
                    'brunei': 'banderas/Brunei.ico',
                    'bulgaria': 'banderas/Bulgaria.ico',
                    'burkina-faso': 'banderas/Burkina-Faso.ico',
                    'burundi': 'banderas/Burundi.ico',
                    'cambodia': 'banderas/Cambodia.ico',
                    'cameroon': 'banderas/Cameroon.ico',
                    'canada': 'banderas/Canada.ico',
                    'canary-islands': 'banderas/Canary-Islands.ico',
                    'cape-verde': 'banderas/Cape-Verde.ico',
                    'cayman-islands': 'banderas/Cayman-Islands.ico',
                    'central-african-republic': 'banderas/Central-African-Republic.ico',
                    'chad': 'banderas/Chad.ico',
                    'chile': 'banderas/Chile.ico',
                    'china': 'banderas/China.ico',
                    'christmas-island': 'banderas/Christmas-Island.ico',
                    'cocos-keeling-islands': 'banderas/Cocos-Keeling-Islands.ico',
                    'colombia': 'banderas/Colombia.ico',
                    'commonwealth': 'banderas/Commonwealth.ico',
                    'comoros': 'banderas/Comoros.ico',
                    'cook-islands': 'banderas/Cook-Islands.ico',
                    'costa-rica': 'banderas/Costa-Rica.ico',
                    'cote-divoire': 'banderas/Cote-dIvoire.ico',
                    'croatia': 'banderas/Croatia.ico',
                    'cuba': 'banderas/Cuba.ico',
                    'curacao': 'banderas/Curacao.ico',
                    'cyprus': 'banderas/Cyprus.ico',
                    'czech-republic': 'banderas/Czech-Republic.ico',
                    'democratic-republic-of-the-congo': 'banderas/Democratic-Republic-of-the-Congo.ico',
                    'denmark': 'banderas/Denmark.ico',
                    'djibouti': 'banderas/Djibouti.ico',
                    'dominica': 'banderas/Dominica.ico',
                    'dominican-republic': 'banderas/Dominican-Republic.ico',
                    'east-timor': 'banderas/East-Timor.ico',
                    'ecuador': 'banderas/Ecuador.ico',
                    'egypt': 'banderas/Egypt.ico',
                    'el-salvador': 'banderas/El-Salvador.ico',
                    'england': 'banderas/England.ico',
                    'equatorial-guinea': 'banderas/Equatorial-Guinea.ico',
                    'eritrea': 'banderas/Eritrea.ico',
                    'estonia': 'banderas/Estonia.ico',
                    'ethiopia': 'banderas/Ethiopia.ico',
                    'european-union': 'banderas/European-Union.ico',
                    'falkland-islands': 'banderas/Falkland-Islands.ico',
                    'faroes': 'banderas/Faroes.ico',
                    'fiji': 'banderas/Fiji.ico',
                    'finland': 'banderas/Finland.ico',
                    'france': 'banderas/France.ico',
                    'french-polynesia': 'banderas/French-Polynesia.ico',
                    'french-southern-territories': 'banderas/French-Southern-Territories.ico',
                    'gabon': 'banderas/Gabon.ico',
                    'gambia': 'banderas/Gambia.ico',
                    'georgia': 'banderas/Georgia.ico',
                    'germany': 'banderas/Germany.ico',
                    'ghana': 'banderas/Ghana.ico',
                    'gibraltar': 'banderas/Gibraltar.ico',
                    'gosquared': 'banderas/GoSquared.ico',
                    'greece': 'banderas/Greece.ico',
                    'greenland': 'banderas/Greenland.ico',
                    'grenada': 'banderas/Grenada.ico',
                    'guam': 'banderas/Guam.ico',
                    'guatemala': 'banderas/Guatemala.ico',
                    'guernsey': 'banderas/Guernsey.ico',
                    'guinea-bissau': 'banderas/Guinea-Bissau.ico',
                    'guinea': 'banderas/Guinea.ico',
                    'guyana': 'banderas/Guyana.ico',
                    'haiti': 'banderas/Haiti.ico',
                    'honduras': 'banderas/Honduras.ico',
                    'hong-kong': 'banderas/Hong-Kong.ico',
                    'hungary': 'banderas/Hungary.ico',
                    'iceland': 'banderas/Iceland.ico',
                    'india': 'banderas/India.ico',
                    'indonesia': 'banderas/Indonesia.ico',
                    'iran': 'banderas/Iran.ico',
                    'iraq': 'banderas/Iraq.ico',
                    'ireland': 'banderas/Ireland.ico',
                    'isle-of-man': 'banderas/Isle-of-Man.ico',
                    'israel': 'banderas/Israel.ico',
                    'italy': 'banderas/Italy.ico',
                    'jamaica': 'banderas/Jamaica.ico',
                    'japan': 'banderas/Japan.ico',
                    'jersey': 'banderas/Jersey.ico',
                    'jordan': 'banderas/Jordan.ico',
                    'kazakhstan': 'banderas/Kazakhstan.ico',
                    'kenya': 'banderas/Kenya.ico',
                    'kiribati': 'banderas/Kiribati.ico',
                    'kosovo': 'banderas/Kosovo.ico',
                    'kuwait': 'banderas/Kuwait.ico',
                    'kyrgyzstan': 'banderas/Kyrgyzstan.ico',
                    'laos': 'banderas/Laos.ico',
                    'latvia': 'banderas/Latvia.ico',
                    'lebanon': 'banderas/Lebanon.ico',
                    'lesotho': 'banderas/Lesotho.ico',
                    'liberia': 'banderas/Liberia.ico',
                    'libya': 'banderas/Libya.ico',
                    'liechtenstein': 'banderas/Liechtenstein.ico',
                    'lithuania': 'banderas/Lithuania.ico',
                    'luxembourg': 'banderas/Luxembourg.ico',
                    'macau': 'banderas/Macau.ico',
                    'macedonia': 'banderas/Macedonia.ico',
                    'madagascar': 'banderas/Madagascar.ico',
                    'malawi': 'banderas/Malawi.ico',
                    'malaysia': 'banderas/Malaysia.ico',
                    'maldives': 'banderas/Maldives.ico',
                    'mali': 'banderas/Mali.ico',
                    'malta': 'banderas/Malta.ico',
                    'mars': 'banderas/Mars.ico',
                    'marshall-islands': 'banderas/Marshall-Islands.ico',
                    'martinique': 'banderas/Martinique.ico',
                    'mauritania': 'banderas/Mauritania.ico',
                    'mauritius': 'banderas/Mauritius.ico',
                    'mayotte': 'banderas/Mayotte.ico',
                    'mexico': 'banderas/Mexico.ico',
                    'micronesia': 'banderas/Micronesia.ico',
                    'moldova': 'banderas/Moldova.ico',
                    'monaco': 'banderas/Monaco.ico',
                    'mongolia': 'banderas/Mongolia.ico',
                    'montenegro': 'banderas/Montenegro.ico',
                    'montserrat': 'banderas/Montserrat.ico',
                    'morocco': 'banderas/Morocco.ico',
                    'mozambique': 'banderas/Mozambique.ico',
                    'myanmar': 'banderas/Myanmar.ico',
                    'nagorno-karabakh': 'banderas/Nagorno-Karabakh.ico',
                    'namibia': 'banderas/Namibia.ico',
                    'nato': 'banderas/NATO.ico',
                    'nauru': 'banderas/Nauru.ico',
                    'nepal': 'banderas/Nepal.ico',
                    'netherlands-antilles': 'banderas/Netherlands-Antilles.ico',
                    'netherlands': 'banderas/Netherlands.ico',
                    'new-caledonia': 'banderas/New-Caledonia.ico',
                    'new-zealand': 'banderas/New-Zealand.ico',
                    'nicaragua': 'banderas/Nicaragua.ico',
                    'niger': 'banderas/Niger.ico',
                    'nigeria': 'banderas/Nigeria.ico',
                    'niue': 'banderas/Niue.ico',
                    'norfolk-island': 'banderas/Norfolk-Island.ico',
                    'north-korea': 'banderas/North-Korea.ico',
                    'northern-cyprus': 'banderas/Northern-Cyprus.ico',
                    'northern-mariana-islands': 'banderas/Northern-Mariana-Islands.ico',
                    'norway': 'banderas/Norway.ico',
                    'olympics': 'banderas/Olympics.ico',
                    'oman': 'banderas/Oman.ico',
                    'pakistan': 'banderas/Pakistan.ico',
                    'palau': 'banderas/Palau.ico',
                    'palestine': 'banderas/Palestine.ico',
                    'panama': 'banderas/Panama.ico',
                    'papua-new-guinea': 'banderas/Papua-New-Guinea.ico',
                    'paraguay': 'banderas/Paraguay.ico',
                    'peru': 'banderas/Peru.ico',
                    'philippines': 'banderas/Philippines.ico',
                    'pitcairn-islands': 'banderas/Pitcairn-Islands.ico',
                    'poland': 'banderas/Poland.ico',
                    'portugal': 'banderas/Portugal.ico',
                    'puerto-rico': 'banderas/Puerto-Rico.ico',
                    'qatar': 'banderas/Qatar.ico',
                    'red-cross': 'banderas/Red-Cross.ico',
                    'republic-of-the-congo': 'banderas/Republic-of-the-Congo.ico',
                    'romania': 'banderas/Romania.ico',
                    'russia': 'banderas/Russia.ico',
                    'rwanda': 'banderas/Rwanda.ico',
                    'saint-barthelemy': 'banderas/Saint-Barthelemy.ico',
                    'saint-helena': 'banderas/Saint-Helena.ico',
                    'saint-kitts-and-nevis': 'banderas/Saint-Kitts-and-Nevis.ico',
                    'saint-lucia': 'banderas/Saint-Lucia.ico',
                    'saint-martin': 'banderas/Saint-Martin.ico',
                    'saint-vincent-and-the-grenadines': 'banderas/Saint-Vincent-and-the-Grenadines.ico',
                    'samoa': 'banderas/Samoa.ico',
                    'san-marino': 'banderas/San-Marino.ico',
                    'sao-tome-and-principe': 'banderas/Sao-Tome-and-Principe.ico',
                    'saudi-arabia': 'banderas/Saudi-Arabia.ico',
                    'scotland': 'banderas/Scotland.ico',
                    'senegal': 'banderas/Senegal.ico',
                    'serbia': 'banderas/Serbia.ico',
                    'seychelles': 'banderas/Seychelles.ico',
                    'sierra-leone': 'banderas/Sierra-Leone.ico',
                    'singapore': 'banderas/Singapore.ico',
                    'slovakia': 'banderas/Slovakia.ico',
                    'slovenia': 'banderas/Slovenia.ico',
                    'solomon-islands': 'banderas/Solomon-Islands.ico',
                    'somalia': 'banderas/Somalia.ico',
                    'somaliland': 'banderas/Somaliland.ico',
                    'south-africa': 'banderas/South-Africa.ico',
                    'south-georgia-and-the-south-sandwich-islands': 'banderas/South-Georgia-and-the-South-Sandwich-Islands.ico',
                    'south-korea': 'banderas/South-Korea.ico',
                    'south-ossetia': 'banderas/South-Ossetia.ico',
                    'south-sudan': 'banderas/South-Sudan.ico',
                    'spain': 'banderas/Spain.ico',
                    'sri-lanka': 'banderas/Sri-Lanka.ico',
                    'sudan': 'banderas/Sudan.ico',
                    'suriname': 'banderas/Suriname.ico',
                    'swaziland': 'banderas/Swaziland.ico',
                    'sweden': 'banderas/Sweden.ico',
                    'switzerland': 'banderas/Switzerland.ico',
                    'syria': 'banderas/Syria.ico',
                    'taiwan': 'banderas/Taiwan.ico',
                    'tajikistan': 'banderas/Tajikistan.ico',
                    'tanzania': 'banderas/Tanzania.ico',
                    'thailand': 'banderas/Thailand.ico',
                    'togo': 'banderas/Togo.ico',
                    'tokelau': 'banderas/Tokelau.ico',
                    'tonga': 'banderas/Tonga.ico',
                    'trinidad-and-tobago': 'banderas/Trinidad-and-Tobago.ico',
                    'tunisia': 'banderas/Tunisia.ico',
                    'turkey': 'banderas/Turkey.ico',
                    'turkmenistan': 'banderas/Turkmenistan.ico',
                    'turks-and-caicos-islands': 'banderas/Turks-and-Caicos-Islands.ico',
                    'tuvalu': 'banderas/Tuvalu.ico',
                    'uganda': 'banderas/Uganda.ico',
                    'ukraine': 'banderas/Ukraine.ico',
                    'united-arab-emirates': 'banderas/United-Arab-Emirates.ico',
                    'united-kingdom': 'banderas/United-Kingdom.ico',
                    'united-nations': 'banderas/United-Nations.ico',
                    'united-states': 'banderas/United-States.ico',
                    'unknown': 'banderas/Unknown.ico',
                    'uruguay': 'banderas/Uruguay.ico',
                    'us-virgin-islands': 'banderas/US-Virgin-Islands.ico',
                    'uzbekistan': 'banderas/Uzbekistan.ico',
                    'vanuatu': 'banderas/Vanuatu.ico',
                    'vatican-city': 'banderas/Vatican-City.ico',
                    'venezuela': 'banderas/Venezuela.ico',
                    'vietnam': 'banderas/Vietnam.ico',
                    'wales': 'banderas/Wales.ico',
                    'wallis-and-futuna': 'banderas/Wallis-And-Futuna.ico',
                    'western-sahara': 'banderas/Western-Sahara.ico',
                    'yemen': 'banderas/Yemen.ico',
                    'zambia': 'banderas/Zambia.ico',
                    'zimbabwe': 'banderas/Zimbabwe.ico'
                };
                saveCustomEmojis();
            }
            updateEmojiSelectors();
            renderCustomEmojis();
        }

        // Funci√≥n para buscar emojis por nombre (b√∫squeda mejorada)
        function searchEmoji(query) {
            query = query.toLowerCase().trim();
            const results = [];

            Object.keys(customEmojis).forEach(key => {
                if (key.toLowerCase().includes(query)) {
                    results.push({ key: key, file: customEmojis[key] });
                }
            });

            return results;
        }

        // Actualizar el selector de emojis para mostrar m√°s opciones
        function updateEmojiSelectors() {
            const countryEmojiSelector = document.getElementById('countryEmojiSelector');
            countryEmojiSelector.innerHTML = '';

            // Agregar campo de b√∫squeda
            const searchContainer = document.createElement('div');
            searchContainer.className = 'mb-3';
            searchContainer.innerHTML = `
        <input type="text" class="form-control form-control-sm" id="emojiSearch" 
               placeholder="Buscar bandera...">
    `;
            countryEmojiSelector.appendChild(searchContainer);

            // Contenedor para los emojis
            const emojiGrid = document.createElement('div');
            emojiGrid.className = 'emoji-grid';
            emojiGrid.style.display = 'flex';
            emojiGrid.style.flexWrap = 'wrap';
            emojiGrid.style.gap = '5px';
            emojiGrid.style.maxHeight = '200px';
            emojiGrid.style.overflowY = 'auto';
            emojiGrid.id = 'emojiGrid';

            // Agregar emojis al grid
            Object.keys(customEmojis).forEach(name => {
                const emojiOption = document.createElement('div');
                emojiOption.className = 'emoji-option';
                emojiOption.onclick = function () { selectEmoji(this, customEmojis[name], name); };
                emojiOption.innerHTML = `<img src="${customEmojis[name]}" alt="${name}" class="icon-preview-img" title="${name}">`;
                emojiOption.dataset.emojiName = name;
                emojiGrid.appendChild(emojiOption);
            });

            countryEmojiSelector.appendChild(emojiGrid);

            // Agregar el evento de b√∫squeda despu√©s de crear el elemento
            document.getElementById('emojiSearch').addEventListener('input', filterEmojis);
        }

        // Funci√≥n para filtrar emojis
        function filterEmojis() {
            const searchTerm = document.getElementById('emojiSearch').value.toLowerCase();
            const emojiOptions = document.querySelectorAll('#emojiGrid .emoji-option');

            emojiOptions.forEach(option => {
                const emojiName = option.dataset.emojiName.toLowerCase();
                if (emojiName.includes(searchTerm)) {
                    option.style.display = 'flex';
                } else {
                    option.style.display = 'none';
                }
            });
        }

        // Funci√≥n mejorada para agregar emojis personalizados
        function addCustomEmoji() {
            const name = document.getElementById('newEmojiName').value.trim().toLowerCase();
            const file = document.getElementById('newEmojiFile').value.trim();

            if (!name || !file) {
                Swal.fire({
                    title: 'Error',
                    text: 'Por favor ingresa nombre y archivo del emoji',
                    icon: 'error',
                    confirmButtonText: 'Aceptar'
                });
                return;
            }

            // Verificar si ya existe
            if (customEmojis[name]) {
                Swal.fire({
                    title: '¬øReemplazar?',
                    text: `El emoji "${name}" ya existe. ¬øQuieres reemplazarlo?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'S√≠, reemplazar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        customEmojis[name] = file;
                        saveCustomEmojis();
                        updateEmojiSelectors();
                        renderCustomEmojis();

                        document.getElementById('newEmojiName').value = '';
                        document.getElementById('newEmojiFile').value = '';

                        Swal.fire({
                            title: '√âxito',
                            text: `Emoji "${name}" actualizado correctamente`,
                            icon: 'success',
                            confirmButtonText: 'Aceptar'
                        });
                    }
                });
            } else {
                customEmojis[name] = file;
                saveCustomEmojis();
                updateEmojiSelectors();
                renderCustomEmojis();

                document.getElementById('newEmojiName').value = '';
                document.getElementById('newEmojiFile').value = '';

                Swal.fire({
                    title: '√âxito',
                    text: `Emoji "${name}" agregado correctamente`,
                    icon: 'success',
                    confirmButtonText: 'Aceptar'
                });
            }
        }

        // Funci√≥n para renderizar emojis personalizados en el gestor
        function renderCustomEmojis() {
            const container = document.getElementById('customEmojisContainer');
            container.innerHTML = '';

            // Agregar campo de b√∫squeda
            const searchContainer = document.createElement('div');
            searchContainer.className = 'mb-3';
            searchContainer.innerHTML = `
        <input type="text" class="form-control form-control-sm" id="customEmojiSearch" 
               placeholder="Buscar emojis personalizados...">
    `;
            container.appendChild(searchContainer);

            // Contenedor para emojis
            const emojiGrid = document.createElement('div');
            emojiGrid.className = 'emoji-grid';
            emojiGrid.style.display = 'flex';
            emojiGrid.style.flexWrap = 'wrap';
            emojiGrid.style.gap = '5px';
            emojiGrid.style.maxHeight = '150px';
            emojiGrid.style.overflowY = 'auto';
            emojiGrid.id = 'customEmojiGrid';

            Object.keys(customEmojis).forEach(name => {
                const emojiOption = document.createElement('div');
                emojiOption.className = 'emoji-option';
                emojiOption.innerHTML = `
            <img src="${customEmojis[name]}" alt="${name}" class="icon-preview-img" title="${name}">
            <div class="emoji-name">${name}</div>
        `;
                emojiGrid.appendChild(emojiOption);
            });

            container.appendChild(emojiGrid);

            // Agregar el evento de b√∫squeda despu√©s de crear el elemento
            document.getElementById('customEmojiSearch').addEventListener('input', filterCustomEmojis);
        }
        // Funci√≥n para filtrar emojis personalizados
        function filterCustomEmojis() {
            const searchTerm = document.getElementById('customEmojiSearch').value.toLowerCase();
            const emojiOptions = document.querySelectorAll('#customEmojiGrid .emoji-option');

            emojiOptions.forEach(option => {
                const emojiName = option.querySelector('.emoji-name').textContent.toLowerCase();
                if (emojiName.includes(searchTerm)) {
                    option.style.display = 'flex';
                } else {
                    option.style.display = 'none';
                }
            });
        }


        function saveCustomEmojis() {
            localStorage.setItem('mapGeneratorCustomEmojis', JSON.stringify(customEmojis));
        }

        function addCustomEmoji() {
            const name = document.getElementById('newEmojiName').value.trim();
            const file = document.getElementById('newEmojiFile').value.trim();

            if (!name || !file) {
                Swal.fire({
                    title: 'Error',
                    text: 'Por favor ingresa nombre y archivo del emoji',
                    icon: 'error',
                    confirmButtonText: 'Aceptar'
                });
                return;
            }

            customEmojis[name] = file;
            saveCustomEmojis();
            updateEmojiSelectors();
            renderCustomEmojis();

            document.getElementById('newEmojiName').value = '';
            document.getElementById('newEmojiFile').value = '';

            Swal.fire({
                title: '√âxito',
                text: `Emoji "${name}" agregado correctamente`,
                icon: 'success',
                confirmButtonText: 'Aceptar'
            });
        }

        function clearCustomEmojis() {
            Swal.fire({
                title: '¬øEst√°s seguro?',
                text: "¬øEst√°s seguro de que quieres eliminar todos los emojis personalizados?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'S√≠, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    customEmojis = {};
                    saveCustomEmojis();
                    updateEmojiSelectors();
                    renderCustomEmojis();
                    Swal.fire(
                        'Eliminados',
                        'Todos los emojis personalizados han sido eliminados.',
                        'success'
                    );
                }
            });
        }

        function renderCustomEmojis() {
            const container = document.getElementById('customEmojisContainer');
            container.innerHTML = Object.keys(customEmojis).map(name => `
                <div class="emoji-option" title="${name}">
                    <img src="${customEmojis[name]}" alt="${name}" class="icon-preview-img">
                    <div class="emoji-name">${name}</div>
                </div>
            `).join('');
        }

        function updateEmojiSelectors() {
            const countryEmojiSelector = document.getElementById('countryEmojiSelector');
            countryEmojiSelector.innerHTML = '';

            Object.keys(customEmojis).forEach(name => {
                const emojiOption = document.createElement('div');
                emojiOption.className = 'emoji-option';
                emojiOption.onclick = function () { selectEmoji(this, customEmojis[name], name); };
                emojiOption.innerHTML = `<img src="${customEmojis[name]}" alt="${name}" class="icon-preview-img">`;
                emojiOption.innerHTML += `<div class="emoji-name">${name}</div>`;
                emojiOption.dataset.emojiName = name;
                countryEmojiSelector.appendChild(emojiOption);
            });
        }

        function selectEmoji(element, emojiFile, emojiName) {
            document.querySelectorAll('#countryEmojiSelector .emoji-option').forEach(emoji => {
                emoji.classList.remove('selected');
            });
            element.classList.add('selected');
            element.dataset.selectedEmoji = emojiFile;
            element.dataset.selectedEmojiName = emojiName;
        }

        // Funciones para pa√≠ses con emojis
        function showCountryModal(countryId = null) {
            const isEdit = countryId !== null;

            if (isEdit) {
                const country = countries[countryId];
                document.getElementById('countryId').value = countryId;
                document.getElementById('countryName').value = country.name;
                document.getElementById('countryColor').value = country.color;

                // Seleccionar el emoji correspondiente
                document.querySelectorAll('#countryEmojiSelector .emoji-option').forEach(emoji => {
                    if (emoji.dataset.selectedEmojiName === country.emojiName) {
                        emoji.classList.add('selected');
                    } else {
                        emoji.classList.remove('selected');
                    }
                });

                document.querySelector('#countryModal .modal-title').textContent = 'Editar Pa√≠s';
                document.querySelector('#countryModal .btn-primary').textContent = 'Guardar Cambios';
                document.querySelector('#countryModal .btn-primary').onclick = () => updateCountry(countryId);
            } else {
                document.getElementById('countryId').value = '';
                document.getElementById('countryName').value = '';
                document.getElementById('countryColor').value = '#4a6fa5';

                // Limpiar selecciones
                document.querySelectorAll('#countryEmojiSelector .emoji-option.selected').forEach(el => {
                    el.classList.remove('selected');
                });

                document.querySelector('#countryModal .modal-title').textContent = 'Nuevo Pa√≠s';
                document.querySelector('#countryModal .btn-primary').textContent = 'Agregar';
                document.querySelector('#countryModal .btn-primary').onclick = addCountry;
            }

            new bootstrap.Modal(document.getElementById('countryModal')).show();
        }
        function addCountry() {
            const id = document.getElementById('countryId').value;
            const name = document.getElementById('countryName').value;
            const color = document.getElementById('countryColor').value;

            // Obtener emoji seleccionados
            const selectedEmoji = document.querySelector('#countryEmojiSelector .emoji-option.selected');
            const emojiFile = selectedEmoji ? selectedEmoji.dataset.selectedEmoji : '';
            const emojiName = selectedEmoji ? selectedEmoji.dataset.selectedEmojiName : '';

            if (!id || !name) {
                Swal.fire({
                    title: 'Error',
                    text: 'Por favor completa todos los campos',
                    icon: 'error',
                    confirmButtonText: 'Aceptar'
                });
                return;
            }

            countries[id] = {
                name: name,
                emoji: emojiFile, // Guardamos el archivo del emoji
                emojiName: emojiName, // Guardamos el nombre del emoji
                buttonText: name.substring(0, 10),
                layerText: name,
                color: color
            };

            renderCountries();
            bootstrap.Modal.getInstance(document.getElementById('countryModal')).hide();
            updateStatistics();
        }

        function createLandRoute() {
            if (currentLandRouteCities.length < 2) {
                Swal.fire({
                    title: 'Error',
                    text: 'Se necesitan al menos 2 ciudades para crear una ruta terrestre',
                    icon: 'error',
                    confirmButtonText: 'Aceptar'
                });
                return;
            }

            const coordinates = currentLandRouteCities.map(city => city.coords);
            const cityNames = currentLandRouteCities.map(city => city.name);
            const transportType = document.getElementById('landTransportType').value;

            const route = {
                id: 'land-route-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                type: "land",
                coordinates: coordinates,
                transportType: transportType,
                tooltip: `Ruta terrestre: ${cityNames.join(' ‚Üí ')}`,
                index: routeIndexCounter++,
                cityNames: cityNames // CORRECCI√ìN: Guardar nombres de ciudades
            };

            routes.push(route);
            currentLandRouteCities = [];
            updateLandRouteVisualizer();
            updateMap();
            updateRoutesList();
            saveRoutesToDB();
            updateStatistics();
            renderCities();

            console.log('Nueva ruta terrestre creada:', route);
        }

        function createMaritimeRoute() {
            if (currentMaritimeRouteCities.length < 2) {
                Swal.fire({
                    title: 'Error',
                    text: 'Se necesitan al menos 2 ciudades para crear una ruta mar√≠tima',
                    icon: 'error',
                    confirmButtonText: 'Aceptar'
                });
                return;
            }

            const coordinates = currentMaritimeRouteCities.map(city => city.coords);
            const cityNames = currentMaritimeRouteCities.map(city => city.name);
            const transportType = document.getElementById('maritimeTransportType').value;

            const maritimeRoute = {
                id: 'maritime-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                type: "maritime",
                coordinates: coordinates,
                transportType: transportType,
                tooltip: `Ruta mar√≠tima: ${cityNames.join(' ‚Üí ')}`,
                index: routeIndexCounter++,
                cityNames: cityNames // CORRECCI√ìN: Guardar nombres de ciudades
            };

            maritimeRoutes.push(maritimeRoute);
            currentMaritimeRouteCities = [];
            updateMaritimeRouteVisualizer();
            updateMap();
            updateRoutesList();
            saveRoutesToDB();
            updateStatistics();
            renderCities();

            console.log('Nueva ruta mar√≠tima creada:', maritimeRoute);
        }

        function createFlightRoute() {
            if (currentFlightCities.length !== 2) {
                Swal.fire({
                    title: 'Error',
                    text: 'Los vuelos deben tener exactamente 2 ciudades (origen y destino)',
                    icon: 'error',
                    confirmButtonText: 'Aceptar'
                });
                return;
            }

            const [fromCity, toCity] = currentFlightCities;
            const coordinates = [fromCity.coords, toCity.coords];
            const transportType = document.getElementById('flightTransportType').value;

            const flight = {
                id: 'flight-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                from: fromCity.name,
                to: toCity.name,
                coordinates: coordinates,
                transportType: transportType,
                tooltip: `Vuelo: ${fromCity.name} ‚Üí ${toCity.name}`,
                index: routeIndexCounter++
            };

            flights.push(flight);
            currentFlightCities = [];
            updateFlightRouteVisualizer();
            updateMap();
            updateRoutesList();
            saveRoutesToDB();
            updateStatistics();
            renderCities();

            console.log('Nuevo vuelo creado:', flight);
        }




        function deleteLandRoute(routeId) {
            console.log('Eliminando ruta terrestre con ID:', routeId);
            console.log('Rutas antes:', routes);

            Swal.fire({
                title: '¬øEst√°s seguro?',
                text: "¬øQuieres eliminar esta ruta terrestre?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'S√≠, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    const initialLength = routes.length;
                    routes = routes.filter(route => route.id === routeId ? false : true);

                    console.log('Rutas despu√©s:', routes);
                    console.log('Eliminadas:', initialLength - routes.length);

                    if (initialLength === routes.length) {
                        Swal.fire({
                            title: 'Error',
                            text: 'No se pudo eliminar la ruta. El ID no coincide.',
                            icon: 'error',
                            confirmButtonText: 'Aceptar'
                        });
                        return;
                    }

                    updateMap();
                    updateRoutesList();
                    saveRoutesToDB();
                    updateStatistics();
                    renderCities();

                    Swal.fire(
                        'Eliminada',
                        'La ruta terrestre ha sido eliminada',
                        'success'
                    );
                }
            });
        }

        function deleteFlightRoute(flightId) {
            console.log('Eliminando vuelo con ID:', flightId);
            console.log('Vuelos antes:', flights);

            Swal.fire({
                title: '¬øEst√°s seguro?',
                text: "¬øQuieres eliminar este vuelo?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'S√≠, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    const initialLength = flights.length;
                    flights = flights.filter(flight => flight.id === flightId ? false : true);

                    console.log('Vuelos despu√©s:', flights);
                    console.log('Eliminados:', initialLength - flights.length);

                    if (initialLength === flights.length) {
                        Swal.fire({
                            title: 'Error',
                            text: 'No se pudo eliminar el vuelo. El ID no coincide.',
                            icon: 'error',
                            confirmButtonText: 'Aceptar'
                        });
                        return;
                    }

                    updateMap();
                    updateRoutesList();
                    saveRoutesToDB();
                    updateStatistics();
                    renderCities();

                    Swal.fire(
                        'Eliminado',
                        'El vuelo ha sido eliminado',
                        'success'
                    );
                }
            });
        }

        function deleteMaritimeRoute(routeId) {
            console.log('Eliminando ruta mar√≠tima con ID:', routeId);

            Swal.fire({
                title: '¬øEst√°s seguro?',
                text: "¬øQuieres eliminar esta ruta mar√≠tima?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'S√≠, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    const initialLength = maritimeRoutes.length;
                    maritimeRoutes = maritimeRoutes.filter(route => route.id === routeId ? false : true);

                    console.log('Eliminadas:', initialLength - maritimeRoutes.length);

                    updateMap();
                    updateRoutesList();
                    saveRoutesToDB();
                    updateStatistics();
                    renderCities();

                    Swal.fire(
                        'Eliminada',
                        'La ruta mar√≠tima ha sido eliminada',
                        'success'
                    );
                }
            });
        }

        // Actualizar listas de rutas - CORREGIDO
        function updateRoutesList() {
            console.log('=== ACTUALIZANDO LISTA DE RUTAS ===');
            console.log('Rutas terrestres:', routes);
            console.log('Vuelos:', flights);
            console.log('Rutas mar√≠timas:', maritimeRoutes);

            // Rutas terrestres - CORRECCI√ìN: Manejo seguro de IDs y nombres
            const landRoutesList = document.getElementById('land-routes-list');
            if (routes.length > 0) {
                landRoutesList.innerHTML = routes.map(route => {
                    const displayName = route.cityNames && route.cityNames.length > 0 ?
                        route.cityNames.join(' ‚Üí ') : 'Ruta terrestre';
                    const routeId = route.id || 'sin-id-' + Math.random();
                    const shortId = route.id ? route.id.substring(0, 10) + '...' : 'Sin ID';

                    return `
            <div class="route-item land-route">
                <div class="route-info">
                    <strong>${displayName}</strong>
                    <br>
                    <small>Tipo: ${route.transportType || 'terrestre'}</small>
                    <br>
                    <small class="text-muted">ID: ${shortId}</small>
                </div>
                <div class="route-actions">
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteLandRoute('${routeId}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            `;
                }).join('');
            } else {
                landRoutesList.innerHTML = '<p class="text-muted text-center">No hay rutas terrestres</p>';
            }

            // Vuelos - CORRECCI√ìN: Manejo seguro de IDs
            const flightRoutesList = document.getElementById('flight-routes-list');
            if (flights.length > 0) {
                flightRoutesList.innerHTML = flights.map(flight => {
                    const flightId = flight.id || 'sin-id-' + Math.random();
                    const shortId = flight.id ? flight.id.substring(0, 10) + '...' : 'Sin ID';

                    return `
            <div class="route-item flight-route">
                <div class="route-info">
                    <strong>${flight.from} ‚Üí ${flight.to}</strong>
                    <br>
                    <small>Tipo: ${flight.transportType || 'aereo'}</small>
                    <br>
                    <small class="text-muted">ID: ${shortId}</small>
                </div>
                <div class="route-actions">
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteFlightRoute('${flightId}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            `;
                }).join('');
            } else {
                flightRoutesList.innerHTML = '<p class="text-muted text-center">No hay vuelos</p>';
            }

            // Rutas mar√≠timas - CORRECCI√ìN: Manejo seguro de IDs y nombres
            const maritimeRoutesList = document.getElementById('maritime-routes-list');
            if (maritimeRoutes.length > 0) {
                maritimeRoutesList.innerHTML = maritimeRoutes.map(route => {
                    const displayName = route.cityNames && route.cityNames.length > 0 ?
                        route.cityNames.join(' ‚Üí ') : 'Ruta mar√≠tima';
                    const routeId = route.id || 'sin-id-' + Math.random();
                    const shortId = route.id ? route.id.substring(0, 10) + '...' : 'Sin ID';

                    return `
            <div class="route-item maritime-route">
                <div class="route-info">
                    <strong>${displayName}</strong>
                    <br>
                    <small>Tipo: ${route.transportType || 'maritimo'}</small>
                    <br>
                    <small class="text-muted">ID: ${shortId}</small>
                </div>
                <div class="route-actions">
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteMaritimeRoute('${routeId}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            `;
                }).join('');
            } else {
                maritimeRoutesList.innerHTML = '<p class="text-muted text-center">No hay rutas mar√≠timas</p>';
            }
        }
        function addFixButton() {
            const routeManagementCard = document.querySelector('.card .card-body');

            // Verificar si los botones ya existen
            if (document.getElementById('fixRoutesBtn')) return;

            const fixButton = document.createElement('button');
            fixButton.id = 'fixRoutesBtn';
            fixButton.className = 'btn btn-warning btn-sm w-100 mt-2';
            fixButton.innerHTML = '<i class="fas fa-tools me-2"></i>Corregir Rutas Actuales';
            fixButton.onclick = function () {
                Swal.fire({
                    title: '¬øCorregir rutas?',
                    text: 'Esto intentar√° corregir las rutas existentes. ¬øQuieres continuar?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'S√≠, corregir',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        migrateExistingRoutes();
                    }
                });
            };

            const resetButton = document.createElement('button');
            resetButton.id = 'resetRoutesBtn';
            resetButton.className = 'btn btn-danger btn-sm w-100 mt-2';
            resetButton.innerHTML = '<i class="fas fa-broom me-2"></i>Reiniciar Todas las Rutas';
            resetButton.onclick = function () {
                Swal.fire({
                    title: '¬øReiniciar todo?',
                    text: 'Esto eliminar√° TODAS las rutas existentes. ¬øEst√°s seguro?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'S√≠, reiniciar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        resetAndFixRoutes();
                    }
                });
            };

            routeManagementCard.appendChild(fixButton);
            routeManagementCard.appendChild(resetButton);
        }
        // Renderizado de pa√≠ses con emojis
        function renderCountries() {
            const container = document.getElementById('countries-container');
            container.innerHTML = Object.keys(countries).map(key => {
                const country = countries[key];
                const emojiHtml = country.emoji ?
                    `<img src="${country.emoji}" alt="${country.emojiName}" class="icon-preview-img">` :
                    'üè≥Ô∏è';

                return `
                <div class="draggable-item" draggable="true" ondragstart="dragStart(event, 'country', '${key}')" ondragend="dragEnd(event)">
                    ${emojiHtml}
                    <span class="color-badge" style="background-color: ${country.color}"></span>
                    <div class="d-inline-block">
                        <strong class="editable-field" onclick="editCountryField('${key}', 'name')">${country.name}</strong>
                        <br><small class="editable-field" onclick="editCountryField('${key}', 'id')">ID: ${key}</small>
                    </div>
                    <button class="btn btn-sm btn-outline-primary edit-btn" onclick="showCountryModal('${key}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-btn" onclick="deleteCountry('${key}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `}).join('');
        }
        function editCountryField(countryId, field) {
            const country = countries[countryId];
            if (!country) return;

            const container = document.getElementById('countries-container');
            const countryElement = container.querySelector(`[draggable="true"]:has(strong:contains("${country.name}"))`);

            if (!countryElement) return;

            let currentValue, displayElement, fieldName;

            if (field === 'name') {
                currentValue = country.name;
                displayElement = countryElement.querySelector('strong');
                fieldName = 'nombre';
            } else if (field === 'id') {
                currentValue = countryId;
                displayElement = countryElement.querySelector('small');
                fieldName = 'ID';
            } else {
                return;
            }

            // Crear campo de edici√≥n
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentValue;
            input.className = 'form-control form-control-sm d-inline-block w-auto';

            // Crear botones de guardar y cancelar
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'edit-buttons';

            const saveButton = document.createElement('button');
            saveButton.className = 'btn btn-success btn-sm save-btn';
            saveButton.innerHTML = '<i class="fas fa-check"></i>';
            saveButton.onclick = () => saveCountryField(countryId, field, input.value);

            const cancelButton = document.createElement('button');
            cancelButton.className = 'btn btn-secondary btn-sm cancel-btn';
            cancelButton.innerHTML = '<i class="fas fa-times"></i>';
            cancelButton.onclick = () => cancelEditCountry(countryElement, displayElement, currentValue);

            buttonContainer.appendChild(saveButton);
            buttonContainer.appendChild(cancelButton);

            // Reemplazar el contenido
            displayElement.innerHTML = '';
            displayElement.appendChild(input);
            displayElement.appendChild(buttonContainer);
            displayElement.classList.add('editing');

            // Enfocar el campo
            input.focus();

            // Permitir guardar con Enter
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveCountryField(countryId, field, input.value);
                }
            });
        }

        function saveCountryField(countryId, field, newValue) {
            if (!newValue.trim()) {
                Swal.fire({
                    title: 'Error',
                    text: 'El campo no puede estar vac√≠o',
                    icon: 'error',
                    confirmButtonText: 'Aceptar'
                });
                return;
            }

            if (field === 'name') {
                countries[countryId].name = newValue;
            } else if (field === 'id') {
                // Cambiar el ID requiere crear una nueva entrada y eliminar la anterior
                if (newValue !== countryId) {
                    if (countries[newValue]) {
                        Swal.fire({
                            title: 'Error',
                            text: 'Ya existe un pa√≠s con ese ID',
                            icon: 'error',
                            confirmButtonText: 'Aceptar'
                        });
                        return;
                    }

                    countries[newValue] = countries[countryId];
                    delete countries[countryId];

                    // Actualizar ciudades que usan este pa√≠s
                    cities.forEach(city => {
                        if (city.type === countryId) {
                            city.type = newValue;
                        }
                    });

                    countryId = newValue;
                }
            }

            renderCountries();
            renderCities();
            updateMap();
            saveCountriesToDB();
            saveCitiesToDB();

            Swal.fire({
                title: '√âxito',
                text: 'Pa√≠s actualizado correctamente',
                icon: 'success',
                confirmButtonText: 'Aceptar'
            });
        }

        function cancelEditCountry(countryElement, displayElement, originalValue) {
            displayElement.innerHTML = originalValue;
            displayElement.classList.remove('editing');
        }

        // Funciones de edici√≥n para ciudades
        function editCityField(cityId, field) {
            const city = cities.find(c => c.id === cityId);
            if (!city) return;

            const container = document.getElementById('cities-container');
            const cityElement = container.querySelector(`[draggable="true"]:has(strong:contains("${city.name}"))`);

            if (!cityElement) return;

            let currentValue, displayElement, fieldName;

            if (field === 'name') {
                currentValue = city.name;
                displayElement = cityElement.querySelector('strong');
                fieldName = 'nombre';
            } else if (field === 'description') {
                currentValue = city.description || '';
                displayElement = cityElement.querySelector('small:first-of-type');
                fieldName = 'descripci√≥n';
            } else {
                return;
            }

            // Crear campo de edici√≥n
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentValue;
            input.className = 'form-control form-control-sm d-inline-block w-auto';

            // Crear botones de guardar y cancelar
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'edit-buttons';

            const saveButton = document.createElement('button');
            saveButton.className = 'btn btn-success btn-sm save-btn';
            saveButton.innerHTML = '<i class="fas fa-check"></i>';
            saveButton.onclick = () => saveCityField(cityId, field, input.value);

            const cancelButton = document.createElement('button');
            cancelButton.className = 'btn btn-secondary btn-sm cancel-btn';
            cancelButton.innerHTML = '<i class="fas fa-times"></i>';
            cancelButton.onclick = () => cancelEditCity(cityElement, displayElement, currentValue);

            buttonContainer.appendChild(saveButton);
            buttonContainer.appendChild(cancelButton);

            // Reemplazar el contenido
            displayElement.innerHTML = '';
            displayElement.appendChild(input);
            displayElement.appendChild(buttonContainer);
            displayElement.classList.add('editing');

            // Enfocar el campo
            input.focus();

            // Permitir guardar con Enter
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveCityField(cityId, field, input.value);
                }
            });
        }

        function saveCityField(cityId, field, newValue) {
            const city = cities.find(c => c.id === cityId);
            if (!city) return;

            if (field === 'name') {
                city.name = newValue;
            } else if (field === 'description') {
                city.description = newValue;
            }

            renderCities();
            updateMap();
            saveCitiesToDB();

            Swal.fire({
                title: '√âxito',
                text: 'Ciudad actualizada correctamente',
                icon: 'success',
                confirmButtonText: 'Aceptar'
            });
        }

        function cancelEditCity(cityElement, displayElement, originalValue) {
            displayElement.innerHTML = originalValue;
            displayElement.classList.remove('editing');
        }

        // Funciones Drag & Drop
        function allowDrop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.add('drag-over');
        }

        function dragLeave(ev) {
            ev.currentTarget.classList.remove('drag-over');
        }

        function dragStart(ev, type, id) {
            ev.dataTransfer.setData("type", type);
            ev.dataTransfer.setData("id", id);
            ev.target.classList.add('dragging');
        }

        function dragEnd(ev) {
            ev.target.classList.remove('dragging');
        }

        function dropInContainer(ev, containerType) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drag-over');
        }

        function dropInRouteBuilder(ev, routeType) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drag-over');

            const type = ev.dataTransfer.getData("type");
            const id = ev.dataTransfer.getData("id");

            if (type === 'city') {
                if (routeType === 'land') {
                    addCityToLandRoute(id);
                } else if (routeType === 'flight') {
                    addCityToFlightRoute(id);
                } else if (routeType === 'maritime') {
                    addCityToMaritimeRoute(id);
                }
            }
        }

        // Funciones para rutas terrestres
        function addCityToLandRoute(cityId) {
            const city = cities.find(c => c.id === cityId);
            if (city && !currentLandRouteCities.find(c => c.id === cityId)) {
                currentLandRouteCities.push(city);
                updateLandRouteVisualizer();
            }
        }

        function updateLandRouteVisualizer() {
            const container = document.getElementById('land-routes-container');
            if (currentLandRouteCities.length === 0) {
                container.innerHTML = 'Arrastra ciudades aqu√≠ para crear ruta terrestre';
                return;
            }

            container.innerHTML = currentLandRouteCities.map(city => `
                <div class="draggable-item" draggable="true" ondragstart="dragStart(event, 'city', '${city.id}')" ondragend="dragEnd(event)">
                    <strong>${city.name}</strong>
                    <span class="badge bg-secondary">${getCountryEmoji(city.type)}</span>
                    <button class="btn btn-sm btn-outline-danger delete-btn" onclick="removeCityFromLandRoute('${city.id}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeCityFromLandRoute(cityId) {
            currentLandRouteCities = currentLandRouteCities.filter(c => c.id !== cityId);
            updateLandRouteVisualizer();
        }

        // Funciones para vuelos
        function addCityToFlightRoute(cityId) {
            const city = cities.find(c => c.id === cityId);
            if (city && currentFlightCities.length < 2 && !currentFlightCities.find(c => c.id === cityId)) {
                currentFlightCities.push(city);
                updateFlightRouteVisualizer();
            } else if (currentFlightCities.length >= 2) {
                Swal.fire({
                    title: 'Error',
                    text: 'Los vuelos solo pueden tener 2 ciudades (origen y destino)',
                    icon: 'error',
                    confirmButtonText: 'Aceptar'
                });
            }
        }

        function updateFlightRouteVisualizer() {
            const container = document.getElementById('flight-routes-container');
            if (currentFlightCities.length === 0) {
                container.innerHTML = 'Arrastra 2 ciudades para crear vuelo (origen ‚Üí destino)';
                return;
            }

            container.innerHTML = currentFlightCities.map((city, index) => `
                <div class="draggable-item" draggable="true" ondragstart="dragStart(event, 'city', '${city.id}')" ondragend="dragEnd(event)">
                    <strong>${index === 0 ? 'üõ´ ' : 'üõ¨ '}${city.name}</strong>
                    <span class="badge bg-warning">${getCountryEmoji(city.type)}</span>
                    <button class="btn btn-sm btn-outline-danger delete-btn" onclick="removeCityFromFlightRoute('${city.id}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeCityFromFlightRoute(cityId) {
            currentFlightCities = currentFlightCities.filter(c => c.id !== cityId);
            updateFlightRouteVisualizer();
        }

        // Funciones para rutas mar√≠timas
        function addCityToMaritimeRoute(cityId) {
            const city = cities.find(c => c.id === cityId);
            if (city && !currentMaritimeRouteCities.find(c => c.id === cityId)) {
                currentMaritimeRouteCities.push(city);
                updateMaritimeRouteVisualizer();
            }
        }

        function updateMaritimeRouteVisualizer() {
            const container = document.getElementById('maritime-routes-container');
            if (currentMaritimeRouteCities.length === 0) {
                container.innerHTML = 'Arrastra ciudades aqu√≠ para crear ruta mar√≠tima';
                return;
            }

            container.innerHTML = currentMaritimeRouteCities.map(city => `
                <div class="draggable-item" draggable="true" ondragstart="dragStart(event, 'city', '${city.id}')" ondragend="dragEnd(event)">
                    <strong>${city.name}</strong>
                    <span class="badge bg-info">${getCountryEmoji(city.type)}</span>
                    <button class="btn btn-sm btn-outline-danger delete-btn" onclick="removeCityFromMaritimeRoute('${city.id}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeCityFromMaritimeRoute(cityId) {
            currentMaritimeRouteCities = currentMaritimeRouteCities.filter(c => c.id !== cityId);
            updateMaritimeRouteVisualizer();
        }

        // Funciones de ciudades}
        function updateCountry(countryId) {
            const id = document.getElementById('countryId').value;
            const name = document.getElementById('countryName').value;
            const color = document.getElementById('countryColor').value;

            // Obtener emoji seleccionado
            const selectedEmoji = document.querySelector('#countryEmojiSelector .emoji-option.selected');
            const emojiFile = selectedEmoji ? selectedEmoji.dataset.selectedEmoji : '';
            const emojiName = selectedEmoji ? selectedEmoji.dataset.selectedEmojiName : '';

            if (!id || !name) {
                Swal.fire({
                    title: 'Error',
                    text: 'Por favor completa todos los campos',
                    icon: 'error',
                    confirmButtonText: 'Aceptar'
                });
                return;
            }

            // Si cambi√≥ el ID, crear nueva entrada y eliminar la anterior
            if (id !== countryId) {
                if (countries[id]) {
                    Swal.fire({
                        title: 'Error',
                        text: 'Ya existe un pa√≠s con ese ID',
                        icon: 'error',
                        confirmButtonText: 'Aceptar'
                    });
                    return;
                }

                countries[id] = {
                    name: name,
                    emoji: emojiFile,
                    emojiName: emojiName,
                    buttonText: name.substring(0, 10),
                    layerText: name,
                    color: color
                };

                delete countries[countryId];

                // Actualizar ciudades que usan este pa√≠s
                cities.forEach(city => {
                    if (city.type === countryId) {
                        city.type = id;
                    }
                });
            } else {
                // Actualizar el pa√≠s existente
                countries[countryId] = {
                    name: name,
                    emoji: emojiFile,
                    emojiName: emojiName,
                    buttonText: name.substring(0, 10),
                    layerText: name,
                    color: color
                };
            }

            renderCountries();
            renderCities();
            updateMap();
            saveCountriesToDB();
            saveCitiesToDB();
            bootstrap.Modal.getInstance(document.getElementById('countryModal')).hide();
            updateStatistics();

            Swal.fire({
                title: '√âxito',
                text: 'Pa√≠s actualizado correctamente',
                icon: 'success',
                confirmButtonText: 'Aceptar'
            });
        }

        function showCityModal(cityId = null) {
            const isEdit = cityId !== null;

            updateCountrySelect();

            if (isEdit) {
                const city = cities.find(c => c.id === cityId);
                document.getElementById('cityName').value = city.name;
                document.getElementById('cityCountry').value = city.type;
                document.getElementById('cityDescription').value = city.description || '';
                document.getElementById('cityLat').value = city.coords[0];
                document.getElementById('cityLng').value = city.coords[1];

                document.querySelector('#cityModal .modal-title').textContent = 'Editar Ciudad';
                document.querySelector('#cityModal .btn-primary').textContent = 'Guardar Cambios';
                document.querySelector('#cityModal .btn-primary').onclick = () => updateCity(cityId);
            } else {
                document.getElementById('cityName').value = '';
                document.getElementById('cityDescription').value = '';
                document.getElementById('cityLat').value = '';
                document.getElementById('cityLng').value = '';

                document.querySelector('#cityModal .modal-title').textContent = 'Nueva Ciudad';
                document.querySelector('#cityModal .btn-primary').textContent = 'Agregar Ciudad';
                document.querySelector('#cityModal .btn-primary').onclick = addCity;
            }

            new bootstrap.Modal(document.getElementById('cityModal')).show();
        }
        function updateCity(cityId) {
            const name = document.getElementById('cityName').value;
            const countryId = document.getElementById('cityCountry').value;
            const description = document.getElementById('cityDescription').value;
            const lat = parseFloat(document.getElementById('cityLat').value);
            const lng = parseFloat(document.getElementById('cityLng').value);

            if (!name || !countryId || isNaN(lat) || isNaN(lng)) {
                Swal.fire({
                    title: 'Error',
                    text: 'Por favor completa todos los campos correctamente',
                    icon: 'error',
                    confirmButtonText: 'Aceptar'
                });
                return;
            }

            const cityIndex = cities.findIndex(c => c.id === cityId);
            if (cityIndex !== -1) {
                cities[cityIndex] = {
                    id: cityId,
                    name: name,
                    country: countries[countryId]?.name || countryId,
                    coords: [lat, lng],
                    type: countryId,
                    description: description
                };
            }

            renderCities();
            updateMap();
            saveCitiesToDB();
            bootstrap.Modal.getInstance(document.getElementById('cityModal')).hide();
            updateStatistics();

            Swal.fire({
                title: '√âxito',
                text: 'Ciudad actualizada correctamente',
                icon: 'success',
                confirmButtonText: 'Aceptar'
            });
        }
        function updateCountrySelect() {
            const select = document.getElementById('cityCountry');
            select.innerHTML = Object.keys(countries).map(key =>
                `<option value="${key}">${getCountryEmojiDisplay(key)} ${countries[key].name}</option>`
            ).join('');
        }

        function addCity() {
            const name = document.getElementById('cityName').value;
            const countryId = document.getElementById('cityCountry').value;
            const description = document.getElementById('cityDescription').value;
            const lat = parseFloat(document.getElementById('cityLat').value);
            const lng = parseFloat(document.getElementById('cityLng').value);

            if (!name || !countryId || isNaN(lat) || isNaN(lng)) {
                Swal.fire({
                    title: 'Error',
                    text: 'Por favor completa todos los campos correctamente',
                    icon: 'error',
                    confirmButtonText: 'Aceptar'
                });
                return;
            }

            const city = {
                id: 'city-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                name: name,
                country: countries[countryId]?.name || countryId,
                coords: [lat, lng],
                type: countryId,
                description: description
            };

            cities.push(city);
            renderCities();
            updateMap();
            saveCitiesToDB(); // Guardar autom√°ticamente
            bootstrap.Modal.getInstance(document.getElementById('cityModal')).hide();
            updateStatistics();
        }

        // Renderizado de ciudades
        function renderCities() {
            const container = document.getElementById('cities-container');
            container.innerHTML = cities.map(city => {
                const isInRoute = isCityInAnyRoute(city);
                const cityClass = isInRoute ? 'city-in-route' : '';

                return `
                <div class="draggable-item ${cityClass}" draggable="true" ondragstart="dragStart(event, 'city', '${city.id}')" ondragend="dragEnd(event)">
                    <div class="d-inline-block">
                        <strong class="editable-field" onclick="editCityField('${city.id}', 'name')">${city.name}</strong>
                        <span class="badge" style="background-color: ${getCountryColor(city.type)}">${getCountryEmoji(city.type)}</span>
                        <br>
                        <small class="editable-field" onclick="editCityField('${city.id}', 'description')">${city.description || 'Sin descripci√≥n'}</small>
                        <br>
                        <small>${city.coords[0].toFixed(4)}, ${city.coords[1].toFixed(4)}</small>
                        ${isInRoute ? '<span class="badge bg-success ms-2">En ruta</span>' : ''}
                    </div>
                    <button class="btn btn-sm btn-outline-primary edit-btn" onclick="showCityModal('${city.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-btn" onclick="deleteCity('${city.id}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `}).join('');
        }


        // Funci√≥n para verificar si una ciudad est√° en alguna ruta
        function isCityInAnyRoute(city) {
            // Verificar en rutas terrestres
            const inLandRoute = routes.some(route =>
                route.coordinates.some(coord =>
                    coord[0] === city.coords[0] && coord[1] === city.coords[1]
                )
            );

            // Verificar en vuelos
            const inFlight = flights.some(flight =>
                flight.coordinates.some(coord =>
                    coord[0] === city.coords[0] && coord[1] === city.coords[1]
                )
            );

            // Verificar en rutas mar√≠timas
            const inMaritimeRoute = maritimeRoutes.some(route =>
                route.coordinates.some(coord =>
                    coord[0] === city.coords[0] && coord[1] === city.coords[1]
                )
            );

            return inLandRoute || inFlight || inMaritimeRoute;
        }

        // Funciones de eliminaci√≥n
        function deleteCountry(countryId) {
            Swal.fire({
                title: '¬øEst√°s seguro?',
                text: `¬øEliminar pa√≠s ${countries[countryId]?.name} y todas sus ciudades?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'S√≠, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    delete countries[countryId];
                    cities = cities.filter(c => c.type !== countryId);
                    routes = routes.filter(r => r.country !== countryId);
                    renderCountries();
                    renderCities();
                    updateMap();
                    updateStatistics();
                    Swal.fire(
                        'Eliminado',
                        'El pa√≠s y sus ciudades han sido eliminados.',
                        'success'
                    );
                }
            });
        }

        function deleteCity(cityId) {
            cities = cities.filter(c => c.id !== cityId);
            renderCities();
            updateMap();
            updateStatistics();
        }

        // Actualizar mapa - SOLO muestra ciudades que est√°n en rutas
        function updateMap() {
            // Limpiar mapa
            map.eachLayer(layer => {
                if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                    map.removeLayer(layer);
                }
            });

            // Obtener ciudades que est√°n en rutas
            const citiesInRoutes = getCitiesInRoutes();

            // Agregar marcadores de ciudades que est√°n en rutas
            citiesInRoutes.forEach(city => {
                const country = countries[city.type];
                if (country) {
                    const icon = L.icon({
                        iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
                        iconSize: [25, 25],
                        iconAnchor: [12, 12],
                        popupAnchor: [0, -12]
                    });

                    const marker = L.marker(city.coords, { icon: icon }).addTo(map)
                        .bindPopup(`
                            <div class="popup-title" style="border-left-color: ${country.color};">
                                <strong>${city.name}</strong>
                            </div>
                            <div class="popup-country" style="background: ${country.color};">${getCountryEmojiDisplay(city.type)} ${country.name}</div>
                            <div>${city.description || 'Sin descripci√≥n'}</div>
                        `);
                }
            });

            // Agregar rutas terrestres
            routes.forEach(route => {
                if (route.coordinates.length >= 2) {
                    const color = route.color || '#666666';
                    const polyline = L.polyline(route.coordinates, {
                        color: color,
                        weight: 5,
                        opacity: 0.8
                    }).addTo(map).bindTooltip(route.tooltip);

                    // Agregar n√∫mero de √≠ndice a la ruta
                    if (route.index) {
                        const midPoint = getMidPoint(route.coordinates);
                        L.marker(midPoint, {
                            icon: L.divIcon({
                                className: 'route-index-marker',
                                html: `<div class="route-order">${route.index}</div>`,
                                iconSize: [25, 25],
                                iconAnchor: [12, 12]
                            })
                        }).addTo(map);
                    }
                }
            });

            // Agregar vuelos
            flights.forEach(flight => {
                if (flight.coordinates.length === 2) {
                    const polyline = L.polyline(flight.coordinates, {
                        color: '#6a0dad',
                        weight: 3,
                        opacity: 0.6,
                        dashArray: '10, 10'
                    }).addTo(map).bindTooltip(flight.tooltip);

                    // Agregar n√∫mero de √≠ndice al vuelo
                    if (flight.index) {
                        const midPoint = getMidPoint(flight.coordinates);
                        L.marker(midPoint, {
                            icon: L.divIcon({
                                className: 'route-index-marker',
                                html: `<div class="route-order">${flight.index}</div>`,
                                iconSize: [25, 25],
                                iconAnchor: [12, 12]
                            })
                        }).addTo(map);
                    }
                }
            });

            // Agregar rutas mar√≠timas
            maritimeRoutes.forEach(route => {
                if (route.coordinates.length >= 2) {
                    const polyline = L.polyline(route.coordinates, {
                        color: '#17a2b8',
                        weight: 4,
                        opacity: 0.7,
                        dashArray: '5, 10'
                    }).addTo(map).bindTooltip(route.tooltip);

                    // Agregar n√∫mero de √≠ndice a la ruta mar√≠tima
                    if (route.index) {
                        const midPoint = getMidPoint(route.coordinates);
                        L.marker(midPoint, {
                            icon: L.divIcon({
                                className: 'route-index-marker',
                                html: `<div class="route-order">${route.index}</div>`,
                                iconSize: [25, 25],
                                iconAnchor: [12, 12]
                            })
                        }).addTo(map);
                    }
                }
            });
        }

        // Funci√≥n para obtener las ciudades que est√°n en rutas
        function getCitiesInRoutes() {
            const citiesInRoutes = [];

            // Agregar ciudades de rutas terrestres
            routes.forEach(route => {
                route.coordinates.forEach(coord => {
                    const city = cities.find(c =>
                        c.coords[0] === coord[0] && c.coords[1] === coord[1]
                    );
                    if (city && !citiesInRoutes.find(c => c.id === city.id)) {
                        citiesInRoutes.push(city);
                    }
                });
            });

            // Agregar ciudades de vuelos
            flights.forEach(flight => {
                flight.coordinates.forEach(coord => {
                    const city = cities.find(c =>
                        c.coords[0] === coord[0] && c.coords[1] === coord[1]
                    );
                    if (city && !citiesInRoutes.find(c => c.id === city.id)) {
                        citiesInRoutes.push(city);
                    }
                });
            });

            // Agregar ciudades de rutas mar√≠timas
            maritimeRoutes.forEach(route => {
                route.coordinates.forEach(coord => {
                    const city = cities.find(c =>
                        c.coords[0] === coord[0] && c.coords[1] === coord[1]
                    );
                    if (city && !citiesInRoutes.find(c => c.id === city.id)) {
                        citiesInRoutes.push(city);
                    }
                });
            });

            return citiesInRoutes;
        }

        // Funci√≥n para calcular el punto medio de una ruta
        function getMidPoint(coordinates) {
            if (coordinates.length === 0) return [0, 0];

            const sumLat = coordinates.reduce((sum, coord) => sum + coord[0], 0);
            const sumLng = coordinates.reduce((sum, coord) => sum + coord[1], 0);

            return [sumLat / coordinates.length, sumLng / coordinates.length];
        }

        function updateMapView() {
            const zoom = parseInt(document.getElementById('mapZoom').value);
            map.setZoom(zoom);
        }

        // Utilidades
        function getCountryColor(countryId) {
            if (countries[countryId] && countries[countryId].color) {
                return countries[countryId].color;
            }
            return '#666666';
        }

        function getCountryEmoji(countryId) {
            if (countries[countryId] && countries[countryId].emoji) {
                return `<img src="${countries[countryId].emoji}" alt="${countries[countryId].emojiName}" class="transport-icon">`;
            }
            return 'üè≥Ô∏è';
        }

        function getCountryEmojiDisplay(countryId) {
            if (countries[countryId] && countries[countryId].emoji) {
                return `<img src="${countries[countryId].emoji}" alt="${countries[countryId].emojiName}" style="width: 20px; height: 20px; object-fit: contain;">`;
            }
            return 'üè≥Ô∏è';
        }

        function updateStatistics() {
            document.getElementById('countriesCount').textContent = Object.keys(countries).length;
            document.getElementById('citiesCount').textContent = cities.length;
            document.getElementById('routesCount').textContent = routes.length + flights.length + maritimeRoutes.length;
        }
        function migrateExistingRoutes() {
            console.log('Migrando rutas existentes...');

            let needsMigration = false;

            // Migrar rutas terrestres
            const migratedLandRoutes = routes.map(route => {
                let needsUpdate = false;
                const updatedRoute = { ...route };

                // CORRECCI√ìN: Si no tiene ID, generar uno
                if (!route.id || route.id.includes('sin-id')) {
                    updatedRoute.id = 'land-route-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                    needsUpdate = true;
                    needsMigration = true;
                }

                // CORRECCI√ìN: Si no tiene cityNames, intentar obtenerlos
                if (!route.cityNames || route.cityNames.length === 0) {
                    let cityNames = [];

                    // Intentar extraer del tooltip
                    if (route.tooltip && route.tooltip.includes('‚Üí')) {
                        const tooltipText = route.tooltip.replace('Ruta terrestre: ', '');
                        cityNames = tooltipText.split(' ‚Üí ');
                    }
                    // Buscar por coordenadas
                    else if (route.coordinates) {
                        route.coordinates.forEach(coord => {
                            const city = cities.find(c =>
                                Math.abs(c.coords[0] - coord[0]) < 0.001 &&
                                Math.abs(c.coords[1] - coord[1]) < 0.001
                            );
                            if (city) {
                                cityNames.push(city.name);
                            }
                        });
                    }

                    // Si se encontraron nombres, actualizar
                    if (cityNames.length > 0) {
                        updatedRoute.cityNames = cityNames;
                        needsUpdate = true;
                        needsMigration = true;
                    }
                }

                return needsUpdate ? updatedRoute : route;
            });

            // Migrar vuelos
            const migratedFlights = flights.map(flight => {
                if (!flight.id || flight.id.includes('sin-id')) {
                    needsMigration = true;
                    return {
                        ...flight,
                        id: 'flight-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9)
                    };
                }
                return flight;
            });

            // Migrar rutas mar√≠timas
            const migratedMaritimeRoutes = maritimeRoutes.map(route => {
                let needsUpdate = false;
                const updatedRoute = { ...route };

                if (!route.id || route.id.includes('sin-id')) {
                    updatedRoute.id = 'maritime-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                    needsUpdate = true;
                    needsMigration = true;
                }

                if (!route.cityNames || route.cityNames.length === 0) {
                    let cityNames = [];

                    if (route.tooltip && route.tooltip.includes('‚Üí')) {
                        const tooltipText = route.tooltip.replace('Ruta mar√≠tima: ', '');
                        cityNames = tooltipText.split(' ‚Üí ');
                    }
                    else if (route.coordinates) {
                        route.coordinates.forEach(coord => {
                            const city = cities.find(c =>
                                Math.abs(c.coords[0] - coord[0]) < 0.001 &&
                                Math.abs(c.coords[1] - coord[1]) < 0.001
                            );
                            if (city) {
                                cityNames.push(city.name);
                            }
                        });
                    }

                    if (cityNames.length > 0) {
                        updatedRoute.cityNames = cityNames;
                        needsUpdate = true;
                        needsMigration = true;
                    }
                }

                return needsUpdate ? updatedRoute : route;
            });

            if (needsMigration) {
                routes = migratedLandRoutes;
                flights = migratedFlights;
                maritimeRoutes = migratedMaritimeRoutes;

                saveRoutesToDB();
                updateRoutesList();

                console.log('Migraci√≥n completada:', {
                    rutasTerrestres: routes.length,
                    vuelos: flights.length,
                    rutasMaritimas: maritimeRoutes.length
                });

                Swal.fire({
                    title: 'Migraci√≥n Completada',
                    text: 'Las rutas existentes han sido corregidas.',
                    icon: 'success',
                    confirmButtonText: 'Aceptar'
                });
            } else {
                Swal.fire({
                    title: 'Sin Cambios',
                    text: 'No se encontraron rutas que necesiten correcci√≥n.',
                    icon: 'info',
                    confirmButtonText: 'Aceptar'
                });
            }
        }

        // Funciones para limpiar rutas
        function clearAllRoutes() {
            Swal.fire({
                title: '¬øEst√°s seguro?',
                text: "¬øEst√°s seguro de que quieres eliminar TODAS las rutas?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'S√≠, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    routes = [];
                    flights = [];
                    maritimeRoutes = [];
                    routeIndexCounter = 1;
                    updateMap();
                    updateRoutesList();
                    saveRoutesToDB();
                    updateStatistics();
                    renderCities();
                    Swal.fire(
                        'Eliminadas',
                        'Todas las rutas han sido eliminadas',
                        'success'
                    );
                }
            });
        }

        // Generar JSON
        function generateJSON() {
            const config = {
                title: document.getElementById('mapTitle').value,
                subtitle: "Mapa generado",
                initialView: {
                    lat: map.getCenter().lat,
                    lng: map.getCenter().lng,
                    zoom: parseInt(document.getElementById('mapZoom').value)
                },
                controls: {
                    enabled: true,
                    position: "topright"
                },
                showRoutes: true,
                showFlights: true,
                showMaritimeRoutes: true,
                colors: {
                    flight: "#6a0dad",
                    maritime: "#17a2b8"
                },
                countries: {}
            };

            // Agregar pa√≠ses
            Object.keys(countries).forEach(key => {
                config.countries[key] = {
                    name: countries[key].name,
                    emoji: countries[key].emoji,
                    emojiName: countries[key].emojiName,
                    buttonText: countries[key].buttonText,
                    layerText: countries[key].layerText,
                    color: countries[key].color
                };
            });

            const finalJSON = {
                config: config,
                cities: cities.map(c => ({
                    id: c.id,
                    name: c.name,
                    country: c.country,
                    coords: c.coords,
                    type: c.type,
                    description: c.description
                })),
                routes: routes,
                flights: flights,
                maritimeRoutes: maritimeRoutes
            };

            document.getElementById('jsonOutput').textContent = JSON.stringify(finalJSON, null, 2);
        }
        function resetAndFixRoutes() {
            console.log('Reiniciando y corrigiendo todas las rutas...');

            // Limpiar todas las rutas existentes
            routes = [];
            flights = [];
            maritimeRoutes = [];

            // Limpiar localStorage
            localStorage.removeItem('mapGeneratorRoutes');

            // Actualizar la interfaz
            updateMap();
            updateRoutesList();
            updateStatistics();
            renderCities();

            Swal.fire({
                title: 'Rutas Reiniciadas',
                text: 'Todas las rutas han sido limpiadas. Ahora puedes crear nuevas rutas que funcionar√°n correctamente.',
                icon: 'success',
                confirmButtonText: 'Aceptar'
            });
        }

        function copyToClipboard() {
            const jsonOutput = document.getElementById('jsonOutput');
            navigator.clipboard.writeText(jsonOutput.textContent).then(() => {
                Swal.fire({
                    title: '√âxito',
                    text: 'JSON copiado al portapapeles!',
                    icon: 'success',
                    confirmButtonText: 'Aceptar'
                });
            });
        }
        // CORREGIR: Eliminar la funci√≥n duplicada deleteLandRoute y arreglar el cierre de llaves

        // Busca esta l√≠nea (alrededor de la l√≠nea 1800) y ELIM√çNALA:


        // Y reemplaza todo desde esa l√≠nea hasta el final del script con esto:

        function copyToClipboard() {
            const jsonOutput = document.getElementById('jsonOutput');
            navigator.clipboard.writeText(jsonOutput.textContent).then(() => {
                Swal.fire({
                    title: '√âxito',
                    text: 'JSON copiado al portapapeles!',
                    icon: 'success',
                    confirmButtonText: 'Aceptar'
                });
            });
        }

        // Cargar desde JSON
        function loadFromJSON() {
            new bootstrap.Modal(document.getElementById('jsonModal')).show();
        }

        function processJSON() {
            try {
                const jsonInput = document.getElementById('jsonInput').value;
                const data = JSON.parse(jsonInput);

                // Limpiar datos actuales
                countries = {};
                cities = [];
                routes = [];
                flights = [];
                maritimeRoutes = [];
                routeIndexCounter = 1;

                // Cargar configuraci√≥n
                if (data.config) {
                    document.getElementById('mapTitle').value = data.config.title || 'üåè Mapa de Viaje';
                    if (data.config.initialView) {
                        map.setView([data.config.initialView.lat, data.config.initialView.lng], data.config.initialView.zoom);
                        document.getElementById('mapZoom').value = data.config.initialView.zoom;
                    }

                    // Cargar pa√≠ses desde config
                    if (data.config.countries) {
                        countries = data.config.countries;
                    }
                }

                // Cargar ciudades
                if (data.cities) {
                    cities = data.cities.map(city => ({
                        ...city,
                        id: city.id || 'city-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9)
                    }));
                }

                // Cargar rutas terrestres - CORRECCI√ìN: Extraer nombres de ciudades del tooltip
                if (data.routes) {
                    routes = data.routes.map(route => {
                        let cityNames = [];

                        // Intentar extraer nombres del tooltip
                        if (route.tooltip && route.tooltip.includes('‚Üí')) {
                            const tooltipText = route.tooltip.replace('Ruta terrestre: ', '');
                            cityNames = tooltipText.split(' ‚Üí ');
                        }
                        // Si no hay tooltip, buscar ciudades por coordenadas
                        else if (route.coordinates) {
                            route.coordinates.forEach(coord => {
                                const city = cities.find(c =>
                                    Math.abs(c.coords[0] - coord[0]) < 0.001 &&
                                    Math.abs(c.coords[1] - coord[1]) < 0.001
                                );
                                if (city) {
                                    cityNames.push(city.name);
                                }
                            });
                        }

                        // Si no se encontraron nombres, usar gen√©rico
                        if (cityNames.length === 0) {
                            cityNames = ['Ruta terrestre'];
                        }

                        return {
                            ...route,
                            id: route.id || 'land-route-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                            cityNames: cityNames
                        };
                    });
                }

                // Cargar vuelos
                if (data.flights) {
                    flights = data.flights.map(flight => ({
                        ...flight,
                        id: flight.id || 'flight-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9)
                    }));
                }

                // Cargar rutas mar√≠timas
                if (data.maritimeRoutes) {
                    maritimeRoutes = data.maritimeRoutes.map(route => {
                        let cityNames = [];

                        // Intentar extraer nombres del tooltip
                        if (route.tooltip && route.tooltip.includes('‚Üí')) {
                            const tooltipText = route.tooltip.replace('Ruta mar√≠tima: ', '');
                            cityNames = tooltipText.split(' ‚Üí ');
                        }
                        // Si no hay tooltip, buscar ciudades por coordenadas
                        else if (route.coordinates) {
                            route.coordinates.forEach(coord => {
                                const city = cities.find(c =>
                                    Math.abs(c.coords[0] - coord[0]) < 0.001 &&
                                    Math.abs(c.coords[1] - coord[1]) < 0.001
                                );
                                if (city) {
                                    cityNames.push(city.name);
                                }
                            });
                        }

                        // Si no se encontraron nombres, usar gen√©rico
                        if (cityNames.length === 0) {
                            cityNames = ['Ruta mar√≠tima'];
                        }

                        return {
                            ...route,
                            id: route.id || 'maritime-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                            cityNames: cityNames
                        };
                    });
                }

                // Actualizar contador de √≠ndices
                const allRoutes = [...routes, ...flights, ...maritimeRoutes];
                allRoutes.forEach(route => {
                    if (route.index && route.index >= routeIndexCounter) {
                        routeIndexCounter = route.index + 1;
                    }
                });

                // Actualizar interfaz
                renderCountries();
                renderCities();
                updateMap();
                updateRoutesList();
                updateStatistics();

                bootstrap.Modal.getInstance(document.getElementById('jsonModal')).hide();
                Swal.fire({
                    title: '√âxito',
                    text: 'Datos cargados correctamente desde JSON!',
                    icon: 'success',
                    confirmButtonText: 'Aceptar'
                });

            } catch (error) {
                Swal.fire({
                    title: 'Error',
                    text: 'Error al procesar el JSON: ' + error.message,
                    icon: 'error',
                    confirmButtonText: 'Aceptar'
                });
            }
        }

        // Guardar pa√≠ses en localStorage
        function saveCountriesToDB() {
            const countriesToSave = {};

            Object.keys(countries).forEach(key => {
                countriesToSave[key] = {
                    name: countries[key].name,
                    emoji: countries[key].emoji,
                    emojiName: countries[key].emojiName,
                    buttonText: countries[key].buttonText,
                    layerText: countries[key].layerText,
                    color: countries[key].color
                };
            });

            localStorage.setItem('mapGeneratorCountries', JSON.stringify(countriesToSave));
            Swal.fire({
                title: '√âxito',
                text: 'Pa√≠ses guardados en la base de datos local!',
                icon: 'success',
                confirmButtonText: 'Aceptar'
            });
        }

        // Cargar pa√≠ses desde localStorage
        function loadCountriesFromDB() {
            const savedCountries = localStorage.getItem('mapGeneratorCountries');

            if (savedCountries) {
                const parsedCountries = JSON.parse(savedCountries);

                Object.keys(parsedCountries).forEach(key => {
                    if (!countries[key]) {
                        countries[key] = parsedCountries[key];
                    }
                });

                renderCountries();
                updateStatistics();
            }
        }

        function clearAllData() {
            Swal.fire({
                title: '¬øEst√°s seguro?',
                text: "¬øEst√°s seguro de que quieres limpiar todos los datos?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'S√≠, limpiar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    countries = {};
                    cities = [];
                    routes = [];
                    flights = [];
                    maritimeRoutes = [];
                    currentLandRouteCities = [];
                    currentFlightCities = [];
                    currentMaritimeRouteCities = [];
                    routeIndexCounter = 1;

                    // Limpiar localStorage
                    localStorage.removeItem('mapGeneratorCities');
                    localStorage.removeItem('mapGeneratorRoutes');

                    renderCountries();
                    renderCities();
                    updateLandRouteVisualizer();
                    updateFlightRouteVisualizer();
                    updateMaritimeRouteVisualizer();
                    updateMap();
                    updateRoutesList();
                    updateStatistics();

                    document.getElementById('jsonOutput').textContent = '// El JSON se generar√° aqu√≠...';
                }
            });
        }

        function saveCitiesToDB() {
            const citiesToSave = cities.map(city => ({
                id: city.id,
                name: city.name,
                country: city.country,
                coords: city.coords,
                type: city.type,
                description: city.description
            }));

            localStorage.setItem('mapGeneratorCities', JSON.stringify(citiesToSave));
        }

        function loadCitiesFromDB() {
            const savedCities = localStorage.getItem('mapGeneratorCities');

            if (savedCities) {
                const parsedCities = JSON.parse(savedCities);
                cities = parsedCities;
                renderCities();
                updateMap();
                updateStatistics();
            }
        }

        // Guardar rutas en localStorage
        function saveRoutesToDB() {
            const routesToSave = {
                routes: routes,
                flights: flights,
                maritimeRoutes: maritimeRoutes
            };

            localStorage.setItem('mapGeneratorRoutes', JSON.stringify(routesToSave));
        }

        // Cargar rutas desde localStorage
        function loadRoutesFromDB() {
            const savedRoutes = localStorage.getItem('mapGeneratorRoutes');

            if (savedRoutes) {
                const parsedRoutes = JSON.parse(savedRoutes);
                routes = parsedRoutes.routes || [];
                flights = parsedRoutes.flights || [];
                maritimeRoutes = parsedRoutes.maritimeRoutes || [];

                // Actualizar contador de √≠ndices
                routeIndexCounter = 1;
                const allRoutes = [...routes, ...flights, ...maritimeRoutes];
                allRoutes.forEach(route => {
                    if (route.index && route.index >= routeIndexCounter) {
                        routeIndexCounter = route.index + 1;
                    }
                });

                updateMap();
                updateRoutesList();
                updateStatistics();
                renderCities();
            }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', function () {
            initMap();
            loadCustomIcons();
            loadCustomEmojis();
            loadCountriesFromDB();
            loadCitiesFromDB();
            loadRoutesFromDB();
            updateStatistics();
            updateRoutesList();
            initTooltips();
            updateEmojiSelectors();

        });

        // Funciones para los nuevos modales
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function acceptTerms() {
            localStorage.setItem('termsAccepted', 'true');
            Swal.fire({
                title: '¬°T√©rminos Aceptados!',
                text: 'Has aceptado nuestros t√©rminos y condiciones.',
                icon: 'success',
                confirmButtonText: 'Continuar'
            }).then(() => {
                $('#termsModal').modal('hide');
            });
        }

        function acceptCookies() {
            localStorage.setItem('cookiesAccepted', 'true');
            Swal.fire({
                title: 'Cookies Aceptadas',
                text: 'Has aceptado nuestra pol√≠tica de cookies.',
                icon: 'success',
                confirmButtonText: 'Continuar'
            }).then(() => {
                $('#cookiesModal').modal('hide');
            });
        }

        // Funci√≥n para enviar formulario por WhatsApp
        function sendToWhatsApp() {
            const name = document.getElementById('contactName').value;
            const email = document.getElementById('contactEmail').value;
            const subject = document.getElementById('contactSubject').value;
            const message = document.getElementById('contactMessage').value;

            // Validar campos obligatorios
            if (!name || !email || !subject || !message) {
                Swal.fire({
                    title: 'Campos Incompletos',
                    text: 'Por favor, completa todos los campos obligatorios del formulario.',
                    icon: 'warning',
                    confirmButtonText: 'Entendido'
                });
                return;
            }

            // Validar formato de email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                Swal.fire({
                    title: 'Email Inv√°lido',
                    text: 'Por favor, ingresa una direcci√≥n de correo electr√≥nico v√°lida.',
                    icon: 'warning',
                    confirmButtonText: 'Entendido'
                });
                return;
            }

            // Formatear el mensaje para WhatsApp
            const whatsappMessage = `Hola, me gustar√≠a contactarlos desde el Generador de Mapas:

*Nombre:* ${name}
*Email:* ${email}
*Asunto:* ${subject}
*Mensaje:*
${message}

Espero su respuesta. ¬°Gracias!`;

            // Codificar el mensaje para URL
            const encodedMessage = encodeURIComponent(whatsappMessage);

            // N√∫mero de WhatsApp (reemplaza con tu n√∫mero)
            const phoneNumber = "7221595250"; // Tu n√∫mero sin el + ni espacios

            // Crear URL de WhatsApp
            const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;

            // Mostrar confirmaci√≥n antes de redirigir
            Swal.fire({
                title: '¬øListo para enviar?',
                html: `Ser√°s redirigido a WhatsApp para enviar tu mensaje.<br><br>
                      <strong>Resumen:</strong><br>
                      <strong>Nombre:</strong> ${name}<br>
                      <strong>Email:</strong> ${email}<br>
                      <strong>Asunto:</strong> ${subject}`,
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: 'S√≠, enviar por WhatsApp',
                cancelButtonText: 'Revisar mensaje',
                confirmButtonColor: '#25D366'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Redirigir a WhatsApp
                    window.open(whatsappURL, '_blank');

                    // Cerrar modal
                    $('#contactModal').modal('hide');

                    // Limpiar formulario
                    document.getElementById('contactForm').reset();

                    // Mostrar mensaje de √©xito
                    setTimeout(() => {
                        Swal.fire({
                            title: '¬°Mensaje Listo!',
                            text: 'Has sido redirigido a WhatsApp. Completa el env√≠o del mensaje all√≠.',
                            icon: 'success',
                            confirmButtonText: 'Entendido'
                        });
                    }, 1000);
                }
            });
        }



        // Permitir enviar formulario con Enter
        document.getElementById('contactForm').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendToWhatsApp();
            }
        });
    </script>
</body>

</html>
