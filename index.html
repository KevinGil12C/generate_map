<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Mapas - Drag & Drop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .container-fluid {
            max-width: 1800px;
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.95);
        }

        .card-header {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 15px 20px;
        }

        .drag-container {
            min-height: 150px;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 15px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .drag-container.drag-over {
            border-color: #1a2a6c;
            background: #e3f2fd;
            box-shadow: 0 0 20px rgba(26, 42, 108, 0.2);
        }

        .draggable-item {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: move;
            transition: all 0.3s ease;
            position: relative;
        }

        .draggable-item:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .draggable-item.dragging {
            opacity: 0.6;
            background: #e3f2fd;
            border-color: #1a2a6c;
        }

        .delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .delete-btn:hover {
            opacity: 1;
        }

        .color-badge {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .preview-map {
            height: 400px;
            border-radius: 10px;
            overflow: hidden;
            border: 3px solid #dee2e6;
        }

        .json-output {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            min-height: 400px;
            border-radius: 8px;
            padding: 15px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 13px;
            line-height: 1.4;
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            margin-bottom: 15px;
        }

        .stats-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .route-builder {
            background: #f8f9fa;
            border: 2px dashed #6c757d;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .flight-builder {
            background: #fff3cd;
            border: 2px dashed #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .maritime-builder {
            background: #d1ecf1;
            border: 2px dashed #17a2b8;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .icon-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
        }

        .icon-option {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.2em;
        }

        .icon-option:hover {
            border-color: #1a2a6c;
            transform: scale(1.1);
        }

        .icon-option.selected {
            border-color: #1a2a6c;
            background-color: #e3f2fd;
        }

        .icon-preview-img {
            width: 24px;
            height: 24px;
            margin-right: 8px;
            object-fit: contain;
        }

        .transport-icon {
            width: 20px;
            height: 20px;
            margin-right: 5px;
            object-fit: contain;
        }

        .custom-icon-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .icon-manager {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .emoji-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
            max-height: 100px;
            overflow-y: auto;
        }

        .emoji-option {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.2em;
        }

        .emoji-option:hover {
            border-color: #1a2a6c;
            transform: scale(1.1);
        }

        .emoji-option.selected {
            border-color: #1a2a6c;
            background-color: #e3f2fd;
        }

        .itinerary-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            background: #f8f9fa;
        }

        .itinerary-day {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .itinerary-day-header {
            font-weight: bold;
            color: #1a2a6c;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }

        .itinerary-day-content {
            font-size: 0.9em;
            color: #495057;
        }

        .route-order {
            background: #ff4444;
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            position: absolute;
            top: -10px;
            left: -10px;
            z-index: 1000;
        }

        .popup-title {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 8px;
            padding-left: 10px;
            border-left: 4px solid;
        }

        .popup-country {
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            margin-top: 5px;
            display: inline-block;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Panel de Control -->
            <div class="col-lg-4">
                <!-- Itinerario -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-route me-2"></i>Itinerario del Viaje</h5>
                    </div>
                    <div class="card-body">
                        <div class="itinerary-container" id="itinerary-container">
                            <!-- Se llena din√°micamente -->
                        </div>
                        <button class="btn btn-primary btn-sm w-100 mt-3" onclick="loadItineraryFromJSON()">
                            <i class="fas fa-upload me-2"></i>Cargar Itinerario
                        </button>
                    </div>
                </div>

                <!-- Pa√≠ses -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-flag me-2"></i>Pa√≠ses</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex gap-2 mb-3">
                            <button class="btn btn-primary btn-sm flex-fill" onclick="showCountryModal()">
                                <i class="fas fa-plus me-2"></i>Agregar Pa√≠s
                            </button>
                            <button class="btn btn-outline-info btn-sm flex-fill" onclick="loadCountriesFromDB()">
                                <i class="fas fa-database me-2"></i>Cargar BD
                            </button>
                        </div>
                        <div class="drag-container" id="countries-container" ondrop="dropInContainer(event, 'country')"
                            ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
                            Arrastra pa√≠ses aqu√≠ o crea nuevos
                        </div>
                    </div>
                </div>

                <!-- Ciudades -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-city me-2"></i>Ciudades</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary btn-sm w-100 mb-3" onclick="showCityModal()">
                            <i class="fas fa-plus me-2"></i>Agregar Ciudad
                        </button>

                        <div class="drag-container" id="cities-container" ondrop="dropInContainer(event, 'city')"
                            ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
                            Arrastra ciudades aqu√≠ o crea nuevas
                        </div>
                    </div>
                </div>

                <!-- Gestor de Iconos -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-icons me-2"></i>Gestor de Iconos</h5>
                    </div>
                    <div class="card-body">
                        <div class="icon-manager">
                            <div class="mb-3">
                                <label class="form-label">Agregar Nuevo Icono</label>
                                <div class="custom-icon-input">
                                    <input type="text" class="form-control" id="newIconName"
                                        placeholder="Nombre del icono">
                                    <input type="text" class="form-control" id="newIconFile"
                                        placeholder="Archivo (ej: tren.png)">
                                    <button class="btn btn-primary btn-sm" onclick="addCustomIcon()">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Iconos Disponibles</label>
                                <div class="icon-selector" id="customIconsContainer">
                                    <!-- Se llena din√°micamente -->
                                </div>
                            </div>
                            <button class="btn btn-outline-secondary btn-sm w-100" onclick="clearCustomIcons()">
                                <i class="fas fa-trash me-2"></i>Limpiar Iconos
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Gestor de Emojis -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-smile me-2"></i>Gestor de Emojis</h5>
                    </div>
                    <div class="card-body">
                        <div class="icon-manager">
                            <div class="mb-3">
                                <label class="form-label">Agregar Nuevo Emoji</label>
                                <div class="custom-icon-input">
                                    <input type="text" class="form-control" id="newEmojiName"
                                        placeholder="Nombre del emoji">
                                    <input type="text" class="form-control" id="newEmojiFile"
                                        placeholder="Archivo (ej: mexico.png)">
                                    <button class="btn btn-primary btn-sm" onclick="addCustomEmoji()">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Emojis Disponibles</label>
                                <div class="emoji-selector" id="customEmojisContainer">
                                    <!-- Se llena din√°micamente -->
                                </div>
                            </div>
                            <button class="btn btn-outline-secondary btn-sm w-100" onclick="clearCustomEmojis()">
                                <i class="fas fa-trash me-2"></i>Limpiar Emojis
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Estad√≠sticas -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Estad√≠sticas</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="stats-card">
                                    <div class="stats-number" id="countriesCount">0</div>
                                    <small>Pa√≠ses</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stats-card">
                                    <div class="stats-number" id="citiesCount">0</div>
                                    <small>Ciudades</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stats-card">
                                    <div class="stats-number" id="routesCount">0</div>
                                    <small>Rutas</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mapa y JSON -->
            <div class="col-lg-8">
                <!-- Constructor de Rutas -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-route me-2"></i>Constructor de Rutas</h5>
                    </div>
                    <div class="card-body">
                        <!-- Rutas Terrestres -->
                        <div class="route-builder">
                            <h6>üöó Rutas Terrestres</h6>
                            <div class="drag-container" id="land-routes-container"
                                ondrop="dropInRouteBuilder(event, 'land')" ondragover="allowDrop(event)"
                                ondragleave="dragLeave(event)">
                                Arrastra ciudades aqu√≠ para crear ruta terrestre
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Tipo de Transporte</label>
                                <select class="form-control" id="landTransportType">
                                    <!-- Se llena din√°micamente -->
                                </select>
                            </div>
                            <button class="btn btn-success btn-sm w-100 mt-2" onclick="createLandRoute()">
                                <i class="fas fa-check me-2"></i>Crear Ruta Terrestre
                            </button>
                        </div>

                        <!-- Vuelos -->
                        <div class="flight-builder mt-3">
                            <h6>‚úàÔ∏è Vuelos</h6>
                            <div class="drag-container" id="flight-routes-container"
                                ondrop="dropInRouteBuilder(event, 'flight')" ondragover="allowDrop(event)"
                                ondragleave="dragLeave(event)">
                                Arrastra 2 ciudades para crear vuelo (origen ‚Üí destino)
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Tipo de Vuelo</label>
                                <select class="form-control" id="flightTransportType">
                                    <!-- Se llena din√°micamente -->
                                </select>
                            </div>
                            <button class="btn btn-warning btn-sm w-100 mt-2" onclick="createFlightRoute()">
                                <i class="fas fa-plane me-2"></i>Crear Vuelo
                            </button>
                        </div>

                        <!-- Rutas Mar√≠timas -->
                        <div class="maritime-builder mt-3">
                            <h6>üö¢ Rutas Mar√≠timas</h6>
                            <div class="drag-container" id="maritime-routes-container"
                                ondrop="dropInRouteBuilder(event, 'maritime')" ondragover="allowDrop(event)"
                                ondragleave="dragLeave(event)">
                                Arrastra ciudades para crear ruta mar√≠tima
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Tipo de Transporte</label>
                                <select class="form-control" id="maritimeTransportType">
                                    <!-- Se llena din√°micamente -->
                                </select>
                            </div>
                            <button class="btn btn-info btn-sm w-100 mt-2" onclick="createMaritimeRoute()">
                                <i class="fas fa-ship me-2"></i>Crear Ruta Mar√≠tima
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Mapa -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-map me-2"></i>Vista Previa del Mapa</h5>
                    </div>
                    <div class="card-body">
                        <div id="previewMap" class="preview-map"></div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <input type="text" class="form-control" id="mapTitle" value="üåè Mapa de Viaje"
                                    placeholder="T√≠tulo del mapa">
                            </div>
                            <div class="col-md-3">
                                <input type="number" class="form-control" id="mapZoom" value="4" min="1" max="18"
                                    placeholder="Zoom">
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-info w-100" onclick="updateMapView()">
                                    <i class="fas fa-sync me-2"></i>Actualizar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- JSON Output -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-code me-2"></i>JSON Generado</h5>
                        <div>
                            <button class="btn btn-success btn-sm me-2" onclick="generateJSON()">
                                <i class="fas fa-sync me-2"></i>Generar JSON
                            </button>
                            <button class="btn btn-dark btn-sm" onclick="copyToClipboard()">
                                <i class="fas fa-copy me-2"></i>Copiar
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="json-output" id="jsonOutput">
                            // El JSON se generar√° aqu√≠...
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-outline-primary me-2" onclick="loadFromJSON()">
                                <i class="fas fa-upload me-2"></i>Cargar desde JSON
                            </button>
                            <button class="btn btn-outline-info me-2" onclick="saveCountriesToDB()">
                                <i class="fas fa-save me-2"></i>Guardar Pa√≠ses
                            </button>
                            <button class="btn btn-outline-danger" onclick="clearAllData()">
                                <i class="fas fa-trash me-2"></i>Limpiar Todo
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Pa√≠s -->
    <div class="modal fade" id="countryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nuevo Pa√≠s</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">ID (clave √∫nica)</label>
                        <input type="text" class="form-control" id="countryId" placeholder="mexico, espa√±a, francia">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nombre del Pa√≠s</label>
                        <input type="text" class="form-control" id="countryName" placeholder="M√©xico">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Emoji (Bandera)</label>
                        <div class="emoji-selector" id="countryEmojiSelector">
                            <!-- Se llena din√°micamente -->
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Color</label>
                        <input type="color" class="form-control" id="countryColor" value="#4a6fa5">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Icono del Pa√≠s</label>
                        <div class="icon-selector" id="countryIconSelector">
                            <!-- Se llena din√°micamente -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="addCountry()">Agregar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ciudad -->
    <div class="modal fade" id="cityModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nueva Ciudad</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Nombre de la Ciudad</label>
                                <input type="text" class="form-control" id="cityName" placeholder="Ciudad de M√©xico">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Pa√≠s</label>
                                <select class="form-control" id="cityCountry">
                                    <!-- Se llena din√°micamente -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Descripci√≥n</label>
                                <textarea class="form-control" id="cityDescription" rows="2"
                                    placeholder="Descripci√≥n de la ciudad..."></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Coordenadas</label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <input type="number" class="form-control" id="cityLat" step="0.0001"
                                            placeholder="Latitud" value="19.4326">
                                    </div>
                                    <div class="col-md-6">
                                        <input type="number" class="form-control" id="cityLng" step="0.0001"
                                            placeholder="Longitud" value="-99.1332">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="addCity()">Agregar Ciudad</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para cargar JSON -->
    <div class="modal fade" id="jsonModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cargar desde JSON</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Pega tu JSON aqu√≠:</label>
                        <textarea class="form-control" id="jsonInput" rows="15"
                            placeholder='{"config": {...}, "cities": [...], "routes": [...], "flights": [...], "maritimeRoutes": [...]}'></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="processJSON()">Cargar Datos</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Variables globales
        let countries = {};
        let cities = [];
        let routes = [];
        let flights = [];
        let maritimeRoutes = [];
        let map;
        let currentLandRouteCities = [];
        let currentFlightCities = [];
        let currentMaritimeRouteCities = [];
        let customIcons = {};
        let customEmojis = {};
        let itinerary = [];

        // Inicializar mapa
        function initMap() {
            map = L.map('previewMap').setView([19.4326, -99.1332], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
        }

        // Sistema de iconos locales (para medios de transporte)
        function loadCustomIcons() {
            const savedIcons = localStorage.getItem('mapGeneratorCustomIcons');
            if (savedIcons) {
                customIcons = JSON.parse(savedIcons);
            } else {
                // Iconos por defecto para medios de transporte - rutas corregidas
                customIcons = {
                    'autobus': 'iconos/autobus.png',
                    'barco': 'iconos/barco.png',
                    'chepe': 'iconos/chepe.png',
                    'crucero': 'iconos/crucero.png',
                    'ferry': 'iconos/ferry.png',
                    'gondola': 'iconos/gondola.png',
                    'lancha': 'iconos/lancha.png',
                    'teleferico': 'iconos/teleferico.png',
                    'tren-alta-velocidad': 'iconos/tren-alta-velocidad.png',
                    'tren-transiberiano': 'iconos/tren-transiberiano.png',
                    'trineo': 'iconos/trineo.png',
                    'vaporeto': 'iconos/vaporeto.png',
                    'vaporetto': 'iconos/vaporetto.png',
                    'vuelo': 'iconos/vuelo.png'
                };
                saveCustomIcons();
            }
            updateIconSelectors();
            renderCustomIcons();
        }

        // Sistema de emojis locales (para banderas de pa√≠ses)
        function loadCustomEmojis() {
            const savedEmojis = localStorage.getItem('mapGeneratorCustomEmojis');
            if (savedEmojis) {
                customEmojis = JSON.parse(savedEmojis);
            } else {
                // Emojis por defecto para banderas - rutas corregidas
                customEmojis = {
                    'mexico': 'banderas/Mexico.ico',
                    'espa√±a': 'banderas/Spain.ico',
                    'francia': 'banderas/France.ico',
                    'italia': 'banderas/Italy.ico',
                    'alemania': 'banderas/Germany.ico',
                    'reino-unido': 'banderas/United-Kingdom.ico',
                    'usa': 'banderas/United-States.ico',
                    'canada': 'banderas/Canada.ico',
                    'japon': 'banderas/Japan.ico',
                    'china': 'banderas/China.ico'
                };
                saveCustomEmojis();
            }
            updateEmojiSelectors();
            renderCustomEmojis();
        }

        function saveCustomIcons() {
            localStorage.setItem('mapGeneratorCustomIcons', JSON.stringify(customIcons));
        }

        function saveCustomEmojis() {
            localStorage.setItem('mapGeneratorCustomEmojis', JSON.stringify(customEmojis));
        }

        function addCustomIcon() {
            const name = document.getElementById('newIconName').value.trim();
            const file = document.getElementById('newIconFile').value.trim();

            if (!name || !file) {
                alert('Por favor ingresa nombre y archivo del icono');
                return;
            }

            customIcons[name] = file;
            saveCustomIcons();
            updateIconSelectors();
            renderCustomIcons();

            document.getElementById('newIconName').value = '';
            document.getElementById('newIconFile').value = '';

            alert(`Icono "${name}" agregado correctamente`);
        }

        function addCustomEmoji() {
            const name = document.getElementById('newEmojiName').value.trim();
            const file = document.getElementById('newEmojiFile').value.trim();

            if (!name || !file) {
                alert('Por favor ingresa nombre y archivo del emoji');
                return;
            }

            customEmojis[name] = file;
            saveCustomEmojis();
            updateEmojiSelectors();
            renderCustomEmojis();

            document.getElementById('newEmojiName').value = '';
            document.getElementById('newEmojiFile').value = '';

            alert(`Emoji "${name}" agregado correctamente`);
        }

        function clearCustomIcons() {
            if (confirm('¬øEst√°s seguro de que quieres eliminar todos los iconos personalizados?')) {
                customIcons = {};
                saveCustomIcons();
                updateIconSelectors();
                renderCustomIcons();
            }
        }

        function clearCustomEmojis() {
            if (confirm('¬øEst√°s seguro de que quieres eliminar todos los emojis personalizados?')) {
                customEmojis = {};
                saveCustomEmojis();
                updateEmojiSelectors();
                renderCustomEmojis();
            }
        }

        function renderCustomIcons() {
            const container = document.getElementById('customIconsContainer');
            container.innerHTML = Object.keys(customIcons).map(name => `
                <div class="icon-option" title="${name}">
                    <img src="${customIcons[name]}" alt="${name}" class="icon-preview-img">
                </div>
            `).join('');
        }

        function renderCustomEmojis() {
            const container = document.getElementById('customEmojisContainer');
            container.innerHTML = Object.keys(customEmojis).map(name => `
                <div class="emoji-option" title="${name}">
                    <img src="${customEmojis[name]}" alt="${name}" class="icon-preview-img">
                </div>
            `).join('');
        }

        function updateIconSelectors() {
            const landSelect = document.getElementById('landTransportType');
            const flightSelect = document.getElementById('flightTransportType');
            const maritimeSelect = document.getElementById('maritimeTransportType');
            const countryIconSelector = document.getElementById('countryIconSelector');

            landSelect.innerHTML = '';
            flightSelect.innerHTML = '';
            maritimeSelect.innerHTML = '';
            countryIconSelector.innerHTML = '';

            Object.keys(customIcons).forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                option.dataset.icon = customIcons[name];

                // Clasificar iconos por tipo de transporte
                if (name.includes('vuelo')) {
                    flightSelect.appendChild(option.cloneNode(true));
                } else if (name.includes('barco') || name.includes('ferry') || name.includes('lancha') ||
                    name.includes('crucero') || name.includes('vaporeto')) {
                    maritimeSelect.appendChild(option.cloneNode(true));
                } else {
                    landSelect.appendChild(option);
                }

                // Agregar al selector de iconos de pa√≠ses
                const iconOption = document.createElement('div');
                iconOption.className = 'icon-option';
                iconOption.onclick = function () { selectIcon(this, customIcons[name], name); };
                iconOption.innerHTML = `<img src="${customIcons[name]}" alt="${name}" class="icon-preview-img">`;
                iconOption.dataset.iconName = name;
                countryIconSelector.appendChild(iconOption);
            });
        }

        function updateEmojiSelectors() {
            const countryEmojiSelector = document.getElementById('countryEmojiSelector');
            countryEmojiSelector.innerHTML = '';

            Object.keys(customEmojis).forEach(name => {
                const emojiOption = document.createElement('div');
                emojiOption.className = 'emoji-option';
                emojiOption.onclick = function () { selectEmoji(this, customEmojis[name], name); };
                emojiOption.innerHTML = `<img src="${customEmojis[name]}" alt="${name}" class="icon-preview-img">`;
                emojiOption.dataset.emojiName = name;
                countryEmojiSelector.appendChild(emojiOption);
            });
        }

        function selectIcon(element, iconFile, iconName) {
            document.querySelectorAll('#countryIconSelector .icon-option').forEach(icon => {
                icon.classList.remove('selected');
            });
            element.classList.add('selected');
            element.dataset.selectedIcon = iconFile;
            element.dataset.selectedIconName = iconName;
        }

        function selectEmoji(element, emojiFile, emojiName) {
            document.querySelectorAll('#countryEmojiSelector .emoji-option').forEach(emoji => {
                emoji.classList.remove('selected');
            });
            element.classList.add('selected');
            element.dataset.selectedEmoji = emojiFile;
            element.dataset.selectedEmojiName = emojiName;
        }

        // Funciones para pa√≠ses con emojis e iconos
        function showCountryModal() {
            document.getElementById('countryId').value = '';
            document.getElementById('countryName').value = '';
            document.getElementById('countryColor').value = '#4a6fa5';

            // Limpiar selecciones
            document.querySelectorAll('.icon-option.selected, .emoji-option.selected').forEach(el => {
                el.classList.remove('selected');
            });

            new bootstrap.Modal(document.getElementById('countryModal')).show();
        }

        function addCountry() {
            const id = document.getElementById('countryId').value;
            const name = document.getElementById('countryName').value;
            const color = document.getElementById('countryColor').value;

            // Obtener emoji seleccionado
            const selectedEmoji = document.querySelector('#countryEmojiSelector .emoji-option.selected');
            const emojiFile = selectedEmoji ? selectedEmoji.dataset.selectedEmoji : '';
            const emojiName = selectedEmoji ? selectedEmoji.dataset.selectedEmojiName : '';

            // Obtener icono seleccionado
            const selectedIcon = document.querySelector('#countryIconSelector .icon-option.selected');
            const iconFile = selectedIcon ? selectedIcon.dataset.selectedIcon : '';
            const iconName = selectedIcon ? selectedIcon.dataset.selectedIconName : '';

            if (!id || !name) {
                alert('Por favor completa todos los campos');
                return;
            }

            countries[id] = {
                name: name,
                emoji: emojiFile, // Guardamos el archivo del emoji
                emojiName: emojiName, // Guardamos el nombre del emoji
                buttonText: name.substring(0, 10),
                layerText: name,
                color: color,
                iconUrl: iconFile, // Guardamos el archivo del icono
                iconName: iconName // Guardamos el nombre del icono
            };

            renderCountries();
            bootstrap.Modal.getInstance(document.getElementById('countryModal')).hide();
            updateStatistics();
        }

        // Funciones para rutas con iconos personalizados
        function createLandRoute() {
            if (currentLandRouteCities.length < 2) {
                alert('Se necesitan al menos 2 ciudades para crear una ruta terrestre');
                return;
            }

            const coordinates = currentLandRouteCities.map(city => city.coords);
            const cityNames = currentLandRouteCities.map(city => city.name);
            const transportType = document.getElementById('landTransportType').value;
            const selectedOption = document.getElementById('landTransportType').selectedOptions[0];
            const transportIcon = selectedOption ? selectedOption.dataset.icon : '';

            const route = {
                type: "land",
                coordinates: coordinates,
                transportType: transportType,
                transportIcon: transportIcon,
                tooltip: `Ruta terrestre: ${cityNames.join(' ‚Üí ')}`
            };

            routes.push(route);
            currentLandRouteCities = [];
            updateLandRouteVisualizer();
            updateMap();
            saveRoutesToDB(); // Guardar autom√°ticamente
            updateStatistics();
        }

        function createFlightRoute() {
            if (currentFlightCities.length !== 2) {
                alert('Los vuelos deben tener exactamente 2 ciudades (origen y destino)');
                return;
            }

            const [fromCity, toCity] = currentFlightCities;
            const coordinates = [fromCity.coords, toCity.coords];
            const transportType = document.getElementById('flightTransportType').value;
            const selectedOption = document.getElementById('flightTransportType').selectedOptions[0];
            const transportIcon = selectedOption ? selectedOption.dataset.icon : '';

            const flight = {
                from: fromCity.name,
                to: toCity.name,
                coordinates: coordinates,
                transportType: transportType,
                transportIcon: transportIcon,
                tooltip: `Vuelo: ${fromCity.name} ‚Üí ${toCity.name}`
            };

            flights.push(flight);
            currentFlightCities = [];
            updateFlightRouteVisualizer();
            updateMap();
            saveRoutesToDB(); // Guardar autom√°ticamente
            updateStatistics();
        }

        function createMaritimeRoute() {
            if (currentMaritimeRouteCities.length < 2) {
                alert('Se necesitan al menos 2 ciudades para crear una ruta mar√≠tima');
                return;
            }

            const coordinates = currentMaritimeRouteCities.map(city => city.coords);
            const cityNames = currentMaritimeRouteCities.map(city => city.name);
            const transportType = document.getElementById('maritimeTransportType').value;
            const selectedOption = document.getElementById('maritimeTransportType').selectedOptions[0];
            const transportIcon = selectedOption ? selectedOption.dataset.icon : '';

            const maritimeRoute = {
                type: "maritime",
                coordinates: coordinates,
                transportType: transportType,
                transportIcon: transportIcon,
                tooltip: `Ruta mar√≠tima: ${cityNames.join(' ‚Üí ')}`
            };

            maritimeRoutes.push(maritimeRoute);
            currentMaritimeRouteCities = [];
            updateMaritimeRouteVisualizer();
            updateMap();
            saveRoutesToDB(); // Guardar autom√°ticamente
            updateStatistics();
        }

        // Renderizado de pa√≠ses con emojis e iconos
        function renderCountries() {
            const container = document.getElementById('countries-container');
            container.innerHTML = Object.keys(countries).map(key => {
                const country = countries[key];
                const emojiHtml = country.emoji ?
                    `<img src="${country.emoji}" alt="${country.emojiName}" class="icon-preview-img">` :
                    'üè≥Ô∏è';
                const iconHtml = country.iconUrl ?
                    `<img src="${country.iconUrl}" alt="${country.iconName}" class="icon-preview-img">` :
                    '';

                return `
                <div class="draggable-item" draggable="true" ondragstart="dragStart(event, 'country', '${key}')" ondragend="dragEnd(event)">
                    ${emojiHtml}
                    ${iconHtml}
                    <span class="color-badge" style="background-color: ${country.color}"></span>
                    <strong>${country.name}</strong>
                    <br><small>ID: ${key}</small>
                    <button class="btn btn-sm btn-outline-danger delete-btn" onclick="deleteCountry('${key}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `}).join('');
        }

        // Funciones Drag & Drop
        function allowDrop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.add('drag-over');
        }

        function dragLeave(ev) {
            ev.currentTarget.classList.remove('drag-over');
        }

        function dragStart(ev, type, id) {
            ev.dataTransfer.setData("type", type);
            ev.dataTransfer.setData("id", id);
            ev.target.classList.add('dragging');
        }

        function dragEnd(ev) {
            ev.target.classList.remove('dragging');
        }

        function dropInContainer(ev, containerType) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drag-over');
        }

        function dropInRouteBuilder(ev, routeType) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drag-over');

            const type = ev.dataTransfer.getData("type");
            const id = ev.dataTransfer.getData("id");

            if (type === 'city') {
                if (routeType === 'land') {
                    addCityToLandRoute(id);
                } else if (routeType === 'flight') {
                    addCityToFlightRoute(id);
                } else if (routeType === 'maritime') {
                    addCityToMaritimeRoute(id);
                }
            }
        }

        // Funciones para rutas terrestres
        function addCityToLandRoute(cityId) {
            const city = cities.find(c => c.id === cityId);
            if (city && !currentLandRouteCities.find(c => c.id === cityId)) {
                currentLandRouteCities.push(city);
                updateLandRouteVisualizer();
            }
        }

        function updateLandRouteVisualizer() {
            const container = document.getElementById('land-routes-container');
            if (currentLandRouteCities.length === 0) {
                container.innerHTML = 'Arrastra ciudades aqu√≠ para crear ruta terrestre';
                return;
            }

            container.innerHTML = currentLandRouteCities.map(city => `
                <div class="draggable-item" draggable="true" ondragstart="dragStart(event, 'city', '${city.id}')" ondragend="dragEnd(event)">
                    <strong>${city.name}</strong>
                    <span class="badge bg-secondary">${getCountryEmoji(city.type)}</span>
                    <button class="btn btn-sm btn-outline-danger delete-btn" onclick="removeCityFromLandRoute('${city.id}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeCityFromLandRoute(cityId) {
            currentLandRouteCities = currentLandRouteCities.filter(c => c.id !== cityId);
            updateLandRouteVisualizer();
        }

        // Funciones para vuelos
        function addCityToFlightRoute(cityId) {
            const city = cities.find(c => c.id === cityId);
            if (city && currentFlightCities.length < 2 && !currentFlightCities.find(c => c.id === cityId)) {
                currentFlightCities.push(city);
                updateFlightRouteVisualizer();
            } else if (currentFlightCities.length >= 2) {
                alert('Los vuelos solo pueden tener 2 ciudades (origen y destino)');
            }
        }

        function updateFlightRouteVisualizer() {
            const container = document.getElementById('flight-routes-container');
            if (currentFlightCities.length === 0) {
                container.innerHTML = 'Arrastra 2 ciudades para crear vuelo (origen ‚Üí destino)';
                return;
            }

            container.innerHTML = currentFlightCities.map((city, index) => `
                <div class="draggable-item" draggable="true" ondragstart="dragStart(event, 'city', '${city.id}')" ondragend="dragEnd(event)">
                    <strong>${index === 0 ? 'üõ´ ' : 'üõ¨ '}${city.name}</strong>
                    <span class="badge bg-warning">${getCountryEmoji(city.type)}</span>
                    <button class="btn btn-sm btn-outline-danger delete-btn" onclick="removeCityFromFlightRoute('${city.id}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeCityFromFlightRoute(cityId) {
            currentFlightCities = currentFlightCities.filter(c => c.id !== cityId);
            updateFlightRouteVisualizer();
        }

        // Funciones para rutas mar√≠timas
        function addCityToMaritimeRoute(cityId) {
            const city = cities.find(c => c.id === cityId);
            if (city && !currentMaritimeRouteCities.find(c => c.id !== cityId)) {
                currentMaritimeRouteCities.push(city);
                updateMaritimeRouteVisualizer();
            }
        }

        function updateMaritimeRouteVisualizer() {
            const container = document.getElementById('maritime-routes-container');
            if (currentMaritimeRouteCities.length === 0) {
                container.innerHTML = 'Arrastra ciudades aqu√≠ para crear ruta mar√≠tima';
                return;
            }

            container.innerHTML = currentMaritimeRouteCities.map(city => `
                <div class="draggable-item" draggable="true" ondragstart="dragStart(event, 'city', '${city.id}')" ondragend="dragEnd(event)">
                    <strong>${city.name}</strong>
                    <span class="badge bg-info">${getCountryEmoji(city.type)}</span>
                    <button class="btn btn-sm btn-outline-danger delete-btn" onclick="removeCityFromMaritimeRoute('${city.id}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeCityFromMaritimeRoute(cityId) {
            currentMaritimeRouteCities = currentMaritimeRouteCities.filter(c => c.id !== cityId);
            updateMaritimeRouteVisualizer();
        }

        // Funciones de ciudades
        function showCityModal() {
            updateCountrySelect();
            document.getElementById('cityName').value = '';
            document.getElementById('cityDescription').value = '';
            document.getElementById('cityLat').value = '';
            document.getElementById('cityLng').value = '';
            new bootstrap.Modal(document.getElementById('cityModal')).show();
        }

        function updateCountrySelect() {
            const select = document.getElementById('cityCountry');
            select.innerHTML = Object.keys(countries).map(key =>
                `<option value="${key}">${getCountryEmojiDisplay(key)} ${countries[key].name}</option>`
            ).join('');
        }

        function addCity() {
            const name = document.getElementById('cityName').value;
            const countryId = document.getElementById('cityCountry').value;
            const description = document.getElementById('cityDescription').value;
            const lat = parseFloat(document.getElementById('cityLat').value);
            const lng = parseFloat(document.getElementById('cityLng').value);

            if (!name || !countryId || isNaN(lat) || isNaN(lng)) {
                alert('Por favor completa todos los campos correctamente');
                return;
            }

            const city = {
                id: 'city-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                name: name,
                country: countries[countryId]?.name || countryId,
                coords: [lat, lng],
                type: countryId,
                description: description
            };

            cities.push(city);
            renderCities();
            updateMap();
            saveCitiesToDB(); // Guardar autom√°ticamente
            bootstrap.Modal.getInstance(document.getElementById('cityModal')).hide();
            updateStatistics();
        }

        // Renderizado
        function renderCities() {
            const container = document.getElementById('cities-container');
            container.innerHTML = cities.map(city => {
                return `
                <div class="draggable-item" draggable="true" ondragstart="dragStart(event, 'city', '${city.id}')" ondragend="dragEnd(event)">
                    <strong>${city.name}</strong>
                    <span class="badge" style="background-color: ${getCountryColor(city.type)}">${getCountryEmoji(city.type)}</span>
                    <br>
                    <small>${city.coords[0].toFixed(4)}, ${city.coords[1].toFixed(4)}</small>
                    <button class="btn btn-sm btn-outline-danger delete-btn" onclick="deleteCity('${city.id}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `}).join('');
        }

        // Funciones de eliminaci√≥n
        function deleteCountry(countryId) {
            if (confirm(`¬øEliminar pa√≠s ${countries[countryId]?.name} y todas sus ciudades?`)) {
                delete countries[countryId];
                cities = cities.filter(c => c.type !== countryId);
                routes = routes.filter(r => r.country !== countryId);
                renderCountries();
                renderCities();
                updateMap();
                updateStatistics();
            }
        }

        function deleteCity(cityId) {
            cities = cities.filter(c => c.id !== cityId);
            renderCities();
            updateMap();
            updateStatistics();
        }

        // Actualizar mapa
        function updateMap() {
            // Limpiar mapa
            map.eachLayer(layer => {
                if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                    map.removeLayer(layer);
                }
            });

            // Obtener el orden de las ciudades seg√∫n el itinerario
            const cityOrder = getCityItineraryOrder();

            // Agregar marcadores de ciudades con n√∫meros de orden
            cities.forEach(city => {
                const country = countries[city.type];
                if (country) {
                    const orderNumber = cityOrder[city.name] || '';
                    
                    let icon;
                    if (country.iconUrl) {
                        icon = L.icon({
                            iconUrl: country.iconUrl,
                            iconSize: [25, 25],
                            iconAnchor: [12, 12],
                            popupAnchor: [0, -12]
                        });
                    } else {
                        icon = L.icon({
                            iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
                            iconSize: [25, 25],
                            iconAnchor: [12, 12],
                            popupAnchor: [0, -12]
                        });
                    }

                    const marker = L.marker(city.coords, { icon: icon }).addTo(map)
                        .bindPopup(`
                            <div class="popup-title" style="border-left-color: ${country.color};">
                                ${orderNumber ? `<span class="route-order">${orderNumber}</span>` : ''}
                                <strong>${city.name}</strong>
                            </div>
                            <div class="popup-country" style="background: ${country.color};">${country.name}</div>
                            <div>${city.description || 'Sin descripci√≥n'}</div>
                        `);
                }
            });

            // Agregar rutas terrestres
            routes.forEach(route => {
                if (route.coordinates.length >= 2) {
                    const color = route.color || '#666666';
                    L.polyline(route.coordinates, {
                        color: color,
                        weight: 5,
                        opacity: 0.8
                    }).addTo(map).bindTooltip(route.tooltip);
                }
            });

            // Agregar vuelos
            flights.forEach(flight => {
                if (flight.coordinates.length === 2) {
                    L.polyline(flight.coordinates, {
                        color: '#6a0dad',
                        weight: 3,
                        opacity: 0.6,
                        dashArray: '10, 10'
                    }).addTo(map).bindTooltip(flight.tooltip);
                }
            });

            // Agregar rutas mar√≠timas
            maritimeRoutes.forEach(route => {
                if (route.coordinates.length >= 2) {
                    L.polyline(route.coordinates, {
                        color: '#17a2b8',
                        weight: 4,
                        opacity: 0.7,
                        dashArray: '5, 10'
                    }).addTo(map).bindTooltip(route.tooltip);
                }
            });
        }

        function updateMapView() {
            const zoom = parseInt(document.getElementById('mapZoom').value);
            map.setZoom(zoom);
        }

        // Utilidades
        function getCountryColor(countryId) {
            if (countries[countryId] && countries[countryId].color) {
                return countries[countryId].color;
            }
            return '#666666';
        }

        function getCountryEmoji(countryId) {
            if (countries[countryId] && countries[countryId].emoji) {
                return `<img src="${countries[countryId].emoji}" alt="${countries[countryId].emojiName}" class="transport-icon">`;
            }
            return 'üè≥Ô∏è';
        }

        function getCountryEmojiDisplay(countryId) {
            if (countries[countryId] && countries[countryId].emoji) {
                return `<img src="${countries[countryId].emoji}" alt="${countries[countryId].emojiName}" style="width: 20px; height: 20px; object-fit: contain;">`;
            }
            return 'üè≥Ô∏è';
        }

        function updateStatistics() {
            document.getElementById('countriesCount').textContent = Object.keys(countries).length;
            document.getElementById('citiesCount').textContent = cities.length;
            document.getElementById('routesCount').textContent = routes.length + flights.length + maritimeRoutes.length;
        }

        // Generar JSON
        function generateJSON() {
            const config = {
                title: document.getElementById('mapTitle').value,
                subtitle: "Mapa generado",
                initialView: {
                    lat: map.getCenter().lat,
                    lng: map.getCenter().lng,
                    zoom: parseInt(document.getElementById('mapZoom').value)
                },
                controls: {
                    enabled: true,
                    position: "topright"
                },
                showRoutes: true,
                showFlights: true,
                showMaritimeRoutes: true,
                colors: {
                    flight: "#6a0dad",
                    maritime: "#17a2b8"
                },
                countries: {}
            };

            // Agregar pa√≠ses
            Object.keys(countries).forEach(key => {
                config.countries[key] = {
                    name: countries[key].name,
                    emoji: countries[key].emoji,
                    emojiName: countries[key].emojiName,
                    buttonText: countries[key].buttonText,
                    layerText: countries[key].layerText,
                    color: countries[key].color,
                    iconUrl: countries[key].iconUrl,
                    iconName: countries[key].iconName
                };
            });

            const finalJSON = {
                config: config,
                cities: cities.map(c => ({
                    id: c.id,
                    name: c.name,
                    country: c.country,
                    coords: c.coords,
                    type: c.type,
                    description: c.description
                })),
                routes: routes,
                flights: flights,
                maritimeRoutes: maritimeRoutes,
                itinerary: itinerary
            };

            document.getElementById('jsonOutput').textContent = JSON.stringify(finalJSON, null, 2);
        }

        function copyToClipboard() {
            const jsonOutput = document.getElementById('jsonOutput');
            navigator.clipboard.writeText(jsonOutput.textContent).then(() => {
                alert('JSON copiado al portapapeles!');
            });
        }

        // Cargar desde JSON
        function loadFromJSON() {
            new bootstrap.Modal(document.getElementById('jsonModal')).show();
        }

        function processJSON() {
            try {
                const jsonInput = document.getElementById('jsonInput').value;
                const data = JSON.parse(jsonInput);

                // Limpiar datos actuales
                clearAllData();

                // Cargar configuraci√≥n
                if (data.config) {
                    document.getElementById('mapTitle').value = data.config.title || 'üåè Mapa de Viaje';
                    if (data.config.initialView) {
                        map.setView([data.config.initialView.lat, data.config.initialView.lng], data.config.initialView.zoom);
                        document.getElementById('mapZoom').value = data.config.initialView.zoom;
                    }

                    // Cargar pa√≠ses desde config
                    if (data.config.countries) {
                        countries = data.config.countries;
                    }
                }

                // Cargar ciudades
                if (data.cities) {
                    cities = data.cities.map(city => ({
                        ...city,
                        id: city.id || 'city-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9)
                    }));
                }

                // Cargar rutas
                if (data.routes) routes = data.routes;
                if (data.flights) flights = data.flights;
                if (data.maritimeRoutes) maritimeRoutes = data.maritimeRoutes;
                
                // Cargar itinerario
                if (data.itinerary) itinerary = data.itinerary;

                // Actualizar interfaz
                renderCountries();
                renderCities();
                updateMap();
                updateStatistics();
                renderItinerary();

                bootstrap.Modal.getInstance(document.getElementById('jsonModal')).hide();
                alert('Datos cargados correctamente desde JSON!');

            } catch (error) {
                alert('Error al procesar el JSON: ' + error.message);
            }
        }

        // Guardar pa√≠ses en localStorage
        function saveCountriesToDB() {
            const countriesToSave = {};

            Object.keys(countries).forEach(key => {
                countriesToSave[key] = {
                    name: countries[key].name,
                    emoji: countries[key].emoji,
                    emojiName: countries[key].emojiName,
                    buttonText: countries[key].buttonText,
                    layerText: countries[key].layerText,
                    color: countries[key].color,
                    iconUrl: countries[key].iconUrl,
                    iconName: countries[key].iconName
                };
            });

            localStorage.setItem('mapGeneratorCountries', JSON.stringify(countriesToSave));
            alert('Pa√≠ses guardados en la base de datos local!');
        }

        // Cargar pa√≠ses desde localStorage
        function loadCountriesFromDB() {
            const savedCountries = localStorage.getItem('mapGeneratorCountries');

            if (savedCountries) {
                const parsedCountries = JSON.parse(savedCountries);

                Object.keys(parsedCountries).forEach(key => {
                    if (!countries[key]) {
                        countries[key] = parsedCountries[key];
                    }
                });

                renderCountries();
                updateStatistics();
            }
        }

        function clearAllData() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar todos los datos?')) {
                countries = {};
                cities = [];
                routes = [];
                flights = [];
                maritimeRoutes = [];
                currentLandRouteCities = [];
                currentFlightCities = [];
                currentMaritimeRouteCities = [];
                itinerary = [];

                // Limpiar localStorage
                localStorage.removeItem('mapGeneratorCities');
                localStorage.removeItem('mapGeneratorRoutes');

                renderCountries();
                renderCities();
                updateLandRouteVisualizer();
                updateFlightRouteVisualizer();
                updateMaritimeRouteVisualizer();
                updateMap();
                updateStatistics();
                renderItinerary();

                document.getElementById('jsonOutput').textContent = '// El JSON se generar√° aqu√≠...';
            }
        }

        // Calcular zoom √≥ptimo autom√°ticamente
        function calculateOptimalZoom() {
            if (cities.length === 0) {
                alert('No hay ciudades para calcular el zoom');
                return;
            }

            const group = L.featureGroup(
                cities.map(city => L.marker(city.coords))
            );

            const bounds = group.getBounds();
            map.fitBounds(bounds, { padding: [50, 50] });

            const optimalZoom = map.getZoom();
            document.getElementById('mapZoom').value = optimalZoom;
        }
        
        function saveCitiesToDB() {
            const citiesToSave = cities.map(city => ({
                id: city.id,
                name: city.name,
                country: city.country,
                coords: city.coords,
                type: city.type,
                description: city.description
            }));

            localStorage.setItem('mapGeneratorCities', JSON.stringify(citiesToSave));
        }
        
        function loadCitiesFromDB() {
            const savedCities = localStorage.getItem('mapGeneratorCities');

            if (savedCities) {
                const parsedCities = JSON.parse(savedCities);
                cities = parsedCities;
                renderCities();
                updateMap();
                updateStatistics();
            }
        }

        // Guardar rutas en localStorage
        function saveRoutesToDB() {
            const routesToSave = {
                routes: routes,
                flights: flights,
                maritimeRoutes: maritimeRoutes
            };

            localStorage.setItem('mapGeneratorRoutes', JSON.stringify(routesToSave));
        }

        // Cargar rutas desde localStorage
        function loadRoutesFromDB() {
            const savedRoutes = localStorage.getItem('mapGeneratorRoutes');

            if (savedRoutes) {
                const parsedRoutes = JSON.parse(savedRoutes);
                routes = parsedRoutes.routes || [];
                flights = parsedRoutes.flights || [];
                maritimeRoutes = parsedRoutes.maritimeRoutes || [];
                updateMap();
                updateStatistics();
            }
        }

        // Funci√≥n para obtener el orden de las ciudades seg√∫n el itinerario
        function getCityItineraryOrder() {
            const cityOrder = {};
            
            // Si hay un itinerario definido, usar ese orden
            if (itinerary.length > 0) {
                let counter = 1;
                itinerary.forEach(day => {
                    // Buscar ciudades mencionadas en el itinerario
                    cities.forEach(city => {
                        if (day.content.toLowerCase().includes(city.name.toLowerCase()) && !cityOrder[city.name]) {
                            cityOrder[city.name] = counter++;
                        }
                    });
                });
            } else {
                // Si no hay itinerario, usar el orden de las rutas
                let counter = 1;
                
                // Procesar rutas terrestres
                routes.forEach(route => {
                    route.coordinates.forEach(coord => {
                        const city = cities.find(c =>
                            c.coords[0] === coord[0] && c.coords[1] === coord[1]
                        );
                        if (city && !cityOrder[city.name]) {
                            cityOrder[city.name] = counter++;
                        }
                    });
                });

                // Procesar vuelos
                flights.forEach(flight => {
                    flight.coordinates.forEach(coord => {
                        const city = cities.find(c =>
                            c.coords[0] === coord[0] && c.coords[1] === coord[1]
                        );
                        if (city && !cityOrder[city.name]) {
                            cityOrder[city.name] = counter++;
                        }
                    });
                });

                // Procesar rutas mar√≠timas
                maritimeRoutes.forEach(route => {
                    route.coordinates.forEach(coord => {
                        const city = cities.find(c =>
                            c.coords[0] === coord[0] && c.coords[1] === coord[1]
                        );
                        if (city && !cityOrder[city.name]) {
                            cityOrder[city.name] = counter++;
                        }
                    });
                });
            }

            return cityOrder;
        }

        // Funciones para el itinerario
        function loadItineraryFromJSON() {
            // Cargar el itinerario proporcionado
            itinerary = [
                {
                    day: "D√çA 1",
                    title: "MEXICO - LA PAZ",
                    content: "Cita en el Aeropuerto Internacional Benito Ju√°rez de la Ciudad de M√©xico para tomar el vuelo rumbo a La Paz, llegada y recibimiento por nuestro gu√≠a. Tarde libre. Alojamiento."
                },
                {
                    day: "D√çA 2",
                    title: "LA PAZ",
                    content: "Desayuno. Iniciaremos con un City Tour por el centro y malec√≥n de este bello lugar. A continuaci√≥n, nos dirigiremos a PLAYA BALANDRA una de las playas m√°s hermosas de M√©xico, realizaremos una caminata para conocer la famosa formaci√≥n rocosa nombrada ¬®Hongo de Balandra¬®, tiempo libre para disfrutar de este maravilloso lugar. M√°s tarde nos dirigiremos a la bella PLAYA EL COROMUEL donde podremos nadar. Tarde libre. Alojamiento."
                },
                {
                    day: "D√çA 3",
                    title: "LA PAZ",
                    content: "Desayuno, d√≠a libre para disfrutar del lugar o si lo desea realizar una excursi√≥n opcional (con costo adicional) a la ISLA ESPIRITU SANTO; isla declarada patrimonio de la humanidad por la UNESCO debido a sus paisajes √∫nicos que combinan el mar con el desierto y su enorme biodiversidad que alberga, tiene una duraci√≥n aproximada de 6 horas, donde podr√°n visitar el santuario de las aves, colonia de lobos marinos, las ruinas de la madre Perla y realizar snorkel. (El nado, el buceo libre y aut√≥nomo est√°n prohibidos del 01 de junio al 31 de agosto de cada a√±o)"
                },
                {
                    day: "D√çA 4",
                    title: "LA PAZ - TODO SANTOS - LOS CABOS - LA PAZ",
                    content: "Despu√©s del desayuno salida a Los Cabos pasando por el pueblo m√°gico de TODOS SANTOS, ah√≠ se encuentra el Hotel California (mito de la canci√≥n Welcome to the Hotel California del grupo Eagles). Todos Santos es una misi√≥n fundada por jesuitas en 1737 con el objetivo de cristianizar a los nativos, al mismo tiempo es un oasis espectacular en el desierto. A continuaci√≥n, hacia CABO SAN LUCAS. Traslado al embarcadero donde daremos un recorrido en lancha con fondo de cristal, donde apreciaremos la famosa formaci√≥n rocosa de Cabo San Lucas denominada 'El Arco', junto con otros puntos atractivos de la zona como son: La colonia de leones marinos, La roca del Pelicano, el dedo de Neptuno, la playa del amor y del divorcio. Comida libre. M√°s tarde nos trasladaremos a SAN JOS√â DEL CABO para realizar una visita por este hist√≥rico poblado. A la hora indicada regreso a La Paz. Alojamiento."
                },
                {
                    day: "D√çA 5",
                    title: "LA PAZ - MEXICO",
                    content: "Desayuno, tiempo libre hasta la hora indicada del traslado al aeropuerto para abordar el vuelo de regreso a la Ciudad de M√©xico."
                }
            ];
            
            renderItinerary();
            updateMap(); // Actualizar el mapa para mostrar los n√∫meros de orden
            alert('Itinerario cargado correctamente!');
        }

        function renderItinerary() {
            const container = document.getElementById('itinerary-container');
            if (itinerary.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No hay itinerario cargado. Haz clic en "Cargar Itinerario" para cargar el itinerario de ejemplo.</p>';
                return;
            }

            container.innerHTML = itinerary.map(day => `
                <div class="itinerary-day">
                    <div class="itinerary-day-header">
                        <i class="fas fa-calendar-day me-2"></i>${day.day} - ${day.title}
                    </div>
                    <div class="itinerary-day-content">
                        ${day.content}
                    </div>
                </div>
            `).join('');
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', function () {
            initMap();
            loadCustomIcons();
            loadCustomEmojis();
            loadCountriesFromDB();
            loadCitiesFromDB();
            loadRoutesFromDB();
            updateStatistics();
            renderItinerary();
        });
    </script>
</body>

</html>