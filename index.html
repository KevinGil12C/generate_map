<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Mapas - Drag & Drop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container-fluid {
            max-width: 1800px;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            background: rgba(255,255,255,0.95);
        }
        .card-header {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 15px 20px;
        }
        /* Drag & Drop Styles */
        .drag-container {
            min-height: 150px;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 15px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }
        .drag-container.drag-over {
            border-color: #1a2a6c;
            background: #e3f2fd;
            box-shadow: 0 0 20px rgba(26, 42, 108, 0.2);
        }
        .draggable-item {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: move;
            transition: all 0.3s ease;
            position: relative;
        }
        .draggable-item:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .draggable-item.dragging {
            opacity: 0.6;
            background: #e3f2fd;
            border-color: #1a2a6c;
        }
        .delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            opacity: 0.7;
            transition: opacity 0.3s;
        }
        .delete-btn:hover {
            opacity: 1;
        }
        .color-badge {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .preview-map {
            height: 400px;
            border-radius: 10px;
            overflow: hidden;
            border: 3px solid #dee2e6;
        }
        .json-output {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            min-height: 400px;
            border-radius: 8px;
            padding: 15px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 13px;
            line-height: 1.4;
        }
        .section-title {
            color: #1a2a6c;
            border-bottom: 3px solid #1a2a6c;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            margin-bottom: 15px;
        }
        .stats-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .route-builder {
            background: #f8f9fa;
            border: 2px dashed #6c757d;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        .flight-builder {
            background: #fff3cd;
            border: 2px dashed #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        .tab-content {
            padding: 20px 0;
        }
        .btn-primary {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            border: none;
            font-weight: 600;
        }
        .btn-success {
            background: linear-gradient(135deg, #00b09b, #96c93d);
            border: none;
            font-weight: 600;
        }
        .zone-badge {
            font-size: 0.7em;
            padding: 2px 6px;
            border-radius: 8px;
            background: #6c757d;
            color: white;
            margin-left: 5px;
        }
        .zone-badge.norte { background: #dc3545; }
        .zone-badge.sur { background: #28a745; }
        .zone-badge.este { background: #007bff; }
        .zone-badge.oeste { background: #6f42c1; }
        .zone-badge.centro { background: #fd7e14; }
        .search-status {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9em;
        }
        .progress-container {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Panel de Control -->
            <div class="col-lg-4">
                <!-- Pa√≠ses -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-flag me-2"></i>Pa√≠ses</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary btn-sm w-100 mb-3" onclick="showCountryModal()">
                            <i class="fas fa-plus me-2"></i>Agregar Pa√≠s
                        </button>
                        <div class="drag-container" id="countries-container" 
                             ondrop="dropInContainer(event, 'country')" 
                             ondragover="allowDrop(event)" 
                             ondragleave="dragLeave(event)">
                            Arrastra pa√≠ses aqu√≠ o crea nuevos
                        </div>
                    </div>
                </div>

                <!-- Ciudades -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-city me-2"></i>Ciudades</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary btn-sm w-100 mb-3" onclick="showCityModal()">
                            <i class="fas fa-plus me-2"></i>Agregar Ciudad
                        </button>
                        
                        <div class="search-status" id="zoneSearchStatus" style="display: none;">
                            <i class="fas fa-search me-2"></i>
                            <span id="zoneStatusText">Detectando zonas geogr√°ficas...</span>
                        </div>

                        <div class="drag-container" id="cities-container" 
                             ondrop="dropInContainer(event, 'city')" 
                             ondragover="allowDrop(event)" 
                             ondragleave="dragLeave(event)">
                            Arrastra ciudades aqu√≠ o crea nuevas
                        </div>
                    </div>
                </div>

                <!-- Constructor de Rutas -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-route me-2"></i>Constructor de Rutas</h5>
                    </div>
                    <div class="card-body">
                        <!-- Rutas Terrestres -->
                        <div class="route-builder">
                            <h6>üöó Rutas Terrestres</h6>
                            <div class="drag-container" id="land-routes-container" 
                                 ondrop="dropInRouteBuilder(event, 'land')" 
                                 ondragover="allowDrop(event)" 
                                 ondragleave="dragLeave(event)">
                                Arrastra ciudades aqu√≠ para crear ruta terrestre
                            </div>
                            <button class="btn btn-success btn-sm w-100 mt-2" onclick="createLandRoute()">
                                <i class="fas fa-check me-2"></i>Crear Ruta Terrestre
                            </button>
                        </div>

                        <!-- Vuelos -->
                        <div class="flight-builder mt-3">
                            <h6>‚úàÔ∏è Vuelos</h6>
                            <div class="drag-container" id="flight-routes-container" 
                                 ondrop="dropInRouteBuilder(event, 'flight')" 
                                 ondragover="allowDrop(event)" 
                                 ondragleave="dragLeave(event)">
                                Arrastra 2 ciudades para crear vuelo (origen ‚Üí destino)
                            </div>
                            <button class="btn btn-warning btn-sm w-100 mt-2" onclick="createFlightRoute()">
                                <i class="fas fa-plane me-2"></i>Crear Vuelo
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Estad√≠sticas -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Estad√≠sticas</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="stats-card">
                                    <div class="stats-number" id="countriesCount">0</div>
                                    <small>Pa√≠ses</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stats-card">
                                    <div class="stats-number" id="citiesCount">0</div>
                                    <small>Ciudades</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stats-card">
                                    <div class="stats-number" id="routesCount">0</div>
                                    <small>Rutas</small>
                                </div>
                            </div>
                        </div>
                        <div class="row text-center mt-2">
                            <div class="col-6">
                                <div class="stats-card">
                                    <div class="stats-number" id="zonesCount">0</div>
                                    <small>Zonas</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stats-card">
                                    <div class="stats-number" id="optimalZoom">4</div>
                                    <small>Zoom √ìptimo</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mapa y JSON -->
            <div class="col-lg-8">
                <!-- Mapa -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-map me-2"></i>Vista Previa del Mapa</h5>
                    </div>
                    <div class="card-body">
                        <div id="previewMap" class="preview-map"></div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <input type="text" class="form-control" id="mapTitle" value="üåè Mapa de Viaje" placeholder="T√≠tulo del mapa">
                            </div>
                            <div class="col-md-3">
                                <input type="number" class="form-control" id="mapZoom" value="4" min="1" max="18" placeholder="Zoom">
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-info w-100" onclick="updateMapView()">
                                    <i class="fas fa-sync me-2"></i>Actualizar
                                </button>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-12">
                                <button class="btn btn-outline-primary btn-sm w-100" onclick="calculateOptimalZoom()">
                                    <i class="fas fa-crosshairs me-2"></i>Calcular Zoom √ìptimo Autom√°ticamente
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- JSON Output -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-code me-2"></i>JSON Generado</h5>
                        <div>
                            <button class="btn btn-success btn-sm me-2" onclick="generateJSON()">
                                <i class="fas fa-sync me-2"></i>Generar JSON
                            </button>
                            <button class="btn btn-dark btn-sm" onclick="copyToClipboard()">
                                <i class="fas fa-copy me-2"></i>Copiar
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="json-output" id="jsonOutput">
                            // El JSON se generar√° aqu√≠...
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-outline-primary me-2" onclick="loadExampleData()">
                                <i class="fas fa-download me-2"></i>Cargar Ejemplo Asia
                            </button>
                            <button class="btn btn-outline-warning me-2" onclick="detectAllZones()">
                                <i class="fas fa-map-marker-alt me-2"></i>Detectar Zonas
                            </button>
                            <button class="btn btn-outline-danger" onclick="clearAllData()">
                                <i class="fas fa-trash me-2"></i>Limpiar Todo
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modales -->
    <div class="modal fade" id="countryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nuevo Pa√≠s</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">ID (clave √∫nica)</label>
                        <input type="text" class="form-control" id="countryId" placeholder="korea, japan, china">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nombre del Pa√≠s</label>
                        <input type="text" class="form-control" id="countryName" placeholder="Corea del Sur">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Emoji</label>
                        <input type="text" class="form-control" id="countryEmoji" placeholder="üá∞üá∑">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Color</label>
                        <input type="color" class="form-control" id="countryColor" value="#4a6fa5">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="addCountry()">Agregar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="cityModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nueva Ciudad</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Nombre de la Ciudad</label>
                                <input type="text" class="form-control" id="cityName" placeholder="Se√∫l">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Pa√≠s</label>
                                <select class="form-control" id="cityCountry">
                                    {/* Se llena din√°micamente */}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Descripci√≥n</label>
                                <textarea class="form-control" id="cityDescription" rows="2" placeholder="Descripci√≥n de la ciudad..."></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Coordenadas</label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <input type="number" class="form-control" id="cityLat" step="0.0001" placeholder="Latitud" value="37.5665">
                                    </div>
                                    <div class="col-md-6">
                                        <input type="number" class="form-control" id="cityLng" step="0.0001" placeholder="Longitud" value="126.9780">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Zona Geogr√°fica</label>
                                <select class="form-control" id="cityZone">
                                    <option value="">Detectar autom√°ticamente</option>
                                    <option value="norte">Norte</option>
                                    <option value="sur">Sur</option>
                                    <option value="este">Este</option>
                                    <option value="oeste">Oeste</option>
                                    <option value="centro">Centro</option>
                                    <option value="noreste">Noreste</option>
                                    <option value="noroeste">Noroeste</option>
                                    <option value="sureste">Sureste</option>
                                    <option value="suroeste">Suroeste</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <button type="button" class="btn btn-outline-primary w-100" onclick="detectCityZone()">
                                    <i class="fas fa-map-marker-alt me-2"></i>Detectar Zona Autom√°ticamente
                                </button>
                            </div>
                            <div id="zoneResult" class="alert alert-info" style="display: none;">
                                <i class="fas fa-info-circle me-2"></i>
                                <span id="zoneResultText"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="addCity()">Agregar Ciudad</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Variables globales
        let countries = {};
        let cities = [];
        let routes = [];
        let flights = [];
        let map;
        let currentLandRouteCities = [];
        let currentFlightCities = [];

        // Base de datos de zonas geogr√°ficas por pa√≠s
        const countryZones = {
            "m√©xico": {
                "norte": { lat: [25, 32], lng: [-117, -103] },
                "centro": { lat: [19, 25], lng: [-103, -96] },
                "sur": { lat: [14, 19], lng: [-96, -86] },
                "este": { lat: [18, 25], lng: [-96, -86] },
                "oeste": { lat: [18, 32], lng: [-117, -106] }
            },
            "estados unidos": {
                "noreste": { lat: [38, 47], lng: [-83, -67] },
                "sureste": { lat: [24, 38], lng: [-91, -75] },
                "medio oeste": { lat: [36, 49], lng: [-104, -83] },
                "sudoeste": { lat: [31, 38], lng: [-120, -103] },
                "oeste": { lat: [32, 49], lng: [-124, -114] }
            },
            "china": {
                "norte": { lat: [35, 45], lng: [110, 125] },
                "sur": { lat: [18, 35], lng: [105, 120] },
                "este": { lat: [25, 40], lng: [115, 125] },
                "oeste": { lat: [25, 40], lng: [75, 105] },
                "centro": { lat: [28, 36], lng: [105, 118] }
            },
            "jap√≥n": {
                "hokkaido": { lat: [41, 46], lng: [139, 146] },
                "honshu": { lat: [34, 41], lng: [135, 142] },
                "shikoku": { lat: [32, 34], lng: [132, 135] },
                "kyushu": { lat: [31, 34], lng: [129, 132] }
            },
            "corea del sur": {
                "norte": { lat: [37, 38], lng: [126, 129] },
                "sur": { lat: [34, 37], lng: [126, 129] },
                "este": { lat: [35, 38], lng: [128, 130] },
                "oeste": { lat: [35, 38], lng: [126, 127] }
            },
            "espa√±a": {
                "norte": { lat: [41, 44], lng: [-10, 3] },
                "sur": { lat: [36, 38], lng: [-7, 2] },
                "este": { lat: [38, 42], lng: [0, 4] },
                "oeste": { lat: [37, 43], lng: [-9, -6] },
                "centro": { lat: [39, 41], lng: [-6, -2] }
            },
            "francia": {
                "norte": { lat: [48, 51], lng: [-2, 6] },
                "sur": { lat: [42, 44], lng: [-1, 9] },
                "este": { lat: [45, 49], lng: [4, 8] },
                "oeste": { lat: [44, 48], lng: [-5, -1] }
            },
            "italia": {
                "norte": { lat: [44, 47], lng: [6, 13] },
                "centro": { lat: [41, 44], lng: [10, 15] },
                "sur": { lat: [37, 41], lng: [13, 18] }
            },
            "reino unido": {
                "inglaterra": { lat: [50, 56], lng: [-6, 2] },
                "escocia": { lat: [55, 59], lng: [-8, -1] },
                "gales": { lat: [51, 53], lng: [-5, -3] },
                "irlanda del norte": { lat: [54, 55], lng: [-8, -6] }
            }
        };

        // Inicializar mapa
        function initMap() {
            map = L.map('previewMap').setView([36, 125], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
        }

        // Funciones Drag & Drop
        function allowDrop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.add('drag-over');
        }

        function dragLeave(ev) {
            ev.currentTarget.classList.remove('drag-over');
        }

        function dragStart(ev, type, id) {
            ev.dataTransfer.setData("type", type);
            ev.dataTransfer.setData("id", id);
            ev.target.classList.add('dragging');
        }

        function dragEnd(ev) {
            ev.target.classList.remove('dragging');
        }

        function dropInContainer(ev, containerType) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drag-over');
        }

        function dropInRouteBuilder(ev, routeType) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drag-over');
            
            const type = ev.dataTransfer.getData("type");
            const id = ev.dataTransfer.getData("id");
            
            if (type === 'city') {
                if (routeType === 'land') {
                    addCityToLandRoute(id);
                } else if (routeType === 'flight') {
                    addCityToFlightRoute(id);
                }
            }
        }

        // Funciones para rutas terrestres
        function addCityToLandRoute(cityId) {
            const city = cities.find(c => c.id === cityId);
            if (city && !currentLandRouteCities.find(c => c.id === cityId)) {
                currentLandRouteCities.push(city);
                updateLandRouteVisualizer();
            }
        }

        function updateLandRouteVisualizer() {
            const container = document.getElementById('land-routes-container');
            if (currentLandRouteCities.length === 0) {
                container.innerHTML = 'Arrastra ciudades aqu√≠ para crear ruta terrestre';
                return;
            }

            container.innerHTML = currentLandRouteCities.map(city => `
                <div class="draggable-item" draggable="true" ondragstart="dragStart(event, 'city', '${city.id}')" ondragend="dragEnd(event)">
                    <strong>${city.name}</strong>
                    <span class="badge bg-secondary">${countries[city.type]?.emoji || ''}</span>
                    <button class="btn btn-sm btn-outline-danger delete-btn" onclick="removeCityFromLandRoute('${city.id}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeCityFromLandRoute(cityId) {
            currentLandRouteCities = currentLandRouteCities.filter(c => c.id !== cityId);
            updateLandRouteVisualizer();
        }

        function createLandRoute() {
            if (currentLandRouteCities.length < 2) {
                alert('Se necesitan al menos 2 ciudades para crear una ruta terrestre');
                return;
            }

            const countriesInRoute = [...new Set(currentLandRouteCities.map(c => c.type))];
            if (countriesInRoute.length > 1) {
                alert('Las rutas terrestres deben ser dentro del mismo pa√≠s');
                return;
            }

            const countryId = countriesInRoute[0];
            const coordinates = currentLandRouteCities.map(city => city.coords);
            const cityNames = currentLandRouteCities.map(city => city.name);

            const route = {
                type: "land",
                country: countryId,
                coordinates: coordinates,
                tooltip: `Ruta por ${countries[countryId]?.name}: ${cityNames.join(' ‚Üí ')}`
            };

            routes.push(route);
            currentLandRouteCities = [];
            updateLandRouteVisualizer();
            updateMap();
            updateStatistics();
        }

        // Funciones para vuelos
        function addCityToFlightRoute(cityId) {
            const city = cities.find(c => c.id === cityId);
            if (city && currentFlightCities.length < 2 && !currentFlightCities.find(c => c.id === cityId)) {
                currentFlightCities.push(city);
                updateFlightRouteVisualizer();
            } else if (currentFlightCities.length >= 2) {
                alert('Los vuelos solo pueden tener 2 ciudades (origen y destino)');
            }
        }

        function updateFlightRouteVisualizer() {
            const container = document.getElementById('flight-routes-container');
            if (currentFlightCities.length === 0) {
                container.innerHTML = 'Arrastra 2 ciudades para crear vuelo (origen ‚Üí destino)';
                return;
            }

            container.innerHTML = currentFlightCities.map((city, index) => `
                <div class="draggable-item" draggable="true" ondragstart="dragStart(event, 'city', '${city.id}')" ondragend="dragEnd(event)">
                    <strong>${index === 0 ? 'üõ´ ' : 'üõ¨ '}${city.name}</strong>
                    <span class="badge bg-warning">${countries[city.type]?.emoji || ''}</span>
                    <button class="btn btn-sm btn-outline-danger delete-btn" onclick="removeCityFromFlightRoute('${city.id}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeCityFromFlightRoute(cityId) {
            currentFlightCities = currentFlightCities.filter(c => c.id !== cityId);
            updateFlightRouteVisualizer();
        }

        function createFlightRoute() {
            if (currentFlightCities.length !== 2) {
                alert('Los vuelos deben tener exactamente 2 ciudades (origen y destino)');
                return;
            }

            const [fromCity, toCity] = currentFlightCities;
            const coordinates = [fromCity.coords, toCity.coords];

            const flight = {
                from: fromCity.name,
                to: toCity.name,
                coordinates: coordinates,
                tooltip: `‚úàÔ∏è Vuelo: ${fromCity.name} (${countries[fromCity.type]?.name}) ‚Üí ${toCity.name} (${countries[toCity.type]?.name})`
            };

            flights.push(flight);
            currentFlightCities = [];
            updateFlightRouteVisualizer();
            updateMap();
            updateStatistics();
        }

        // Funciones de los modales
        function showCountryModal() {
            document.getElementById('countryId').value = '';
            document.getElementById('countryName').value = '';
            document.getElementById('countryEmoji').value = '';
            document.getElementById('countryColor').value = '#4a6fa5';
            new bootstrap.Modal(document.getElementById('countryModal')).show();
        }

        function showCityModal() {
            updateCountrySelect();
            document.getElementById('cityName').value = '';
            document.getElementById('cityDescription').value = '';
            document.getElementById('cityLat').value = '';
            document.getElementById('cityLng').value = '';
            document.getElementById('cityZone').value = '';
            document.getElementById('zoneResult').style.display = 'none';
            new bootstrap.Modal(document.getElementById('cityModal')).show();
        }

        function updateCountrySelect() {
            const select = document.getElementById('cityCountry');
            select.innerHTML = Object.keys(countries).map(key => 
                `<option value="${key}">${countries[key].emoji} ${countries[key].name}</option>`
            ).join('');
        }

        // Detecci√≥n de zona geogr√°fica
        async function detectCityZone() {
            const lat = parseFloat(document.getElementById('cityLat').value);
            const lng = parseFloat(document.getElementById('cityLng').value);
            const country = document.getElementById('cityCountry').value;
            
            if (isNaN(lat) || isNaN(lng) || !country) {
                alert('Por favor ingresa coordenadas y selecciona un pa√≠s primero');
                return;
            }

            const zone = await detectGeographicZone(lat, lng, country);
            document.getElementById('cityZone').value = zone;
            
            const zoneResult = document.getElementById('zoneResult');
            const zoneResultText = document.getElementById('zoneResultText');
            zoneResultText.textContent = `Zona detectada: ${zone.toUpperCase()}`;
            zoneResult.style.display = 'block';
        }

        async function detectGeographicZone(lat, lng, countryKey) {
            // Primero intentar con la base de datos local
            const countryName = countries[countryKey]?.name?.toLowerCase() || countryKey.toLowerCase();
            
            if (countryZones[countryName]) {
                for (const [zone, bounds] of Object.entries(countryZones[countryName])) {
                    if (lat >= bounds.lat[0] && lat <= bounds.lat[1] && 
                        lng >= bounds.lng[0] && lng <= bounds.lng[1]) {
                        return zone;
                    }
                }
            }

            // Si no se encuentra en la base local, usar API de geocoding inversa
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`
                );
                const data = await response.json();
                
                if (data.address) {
                    // Intentar extraer informaci√≥n regional de la respuesta
                    const region = data.address.state || data.address.region || data.address.county;
                    if (region) {
                        return mapRegionToZone(region, countryName);
                    }
                }
            } catch (error) {
                console.log('Error en geocoding inverso:', error);
            }

            // Fallback: determinar zona por coordenadas
            return determineZoneByCoordinates(lat, lng, countryName);
        }

        function mapRegionToZone(region, country) {
            const regionLower = region.toLowerCase();
            
            // Mapeo de regiones a zonas para diferentes pa√≠ses
            const regionMappings = {
                'm√©xico': {
                    'norte': ['baja california', 'sonora', 'chihuahua', 'coahuila', 'nuevo le√≥n', 'tamaulipas'],
                    'centro': ['ciudad de m√©xico', 'm√©xico', 'morelos', 'puebla', 'tlaxcala', 'hidalgo'],
                    'sur': ['oaxaca', 'chiapas', 'guerrero', 'tabasco', 'yucat√°n', 'quintana roo']
                },
                'estados unidos': {
                    'noreste': ['new york', 'massachusetts', 'pennsylvania', 'new jersey', 'connecticut'],
                    'sureste': ['florida', 'georgia', 'alabama', 'mississippi', 'louisiana'],
                    'medio oeste': ['illinois', 'ohio', 'michigan', 'indiana', 'wisconsin'],
                    'oeste': ['california', 'washington', 'oregon', 'nevada', 'arizona']
                },
                'espa√±a': {
                    'norte': ['galicia', 'asturias', 'cantabria', 'pa√≠s vasco', 'navarra'],
                    'sur': ['andaluc√≠a', 'murcia', 'extremadura'],
                    'este': ['catalu√±a', 'comunidad valenciana', 'baleares'],
                    'centro': ['madrid', 'castilla-la mancha', 'castilla y le√≥n']
                }
            };

            if (regionMappings[country]) {
                for (const [zone, regions] of Object.entries(regionMappings[country])) {
                    if (regions.some(r => regionLower.includes(r))) {
                        return zone;
                    }
                }
            }

            return 'centro';
        }

        function determineZoneByCoordinates(lat, lng, country) {
            // L√≥gica general basada en coordenadas
            if (lng < -100) { // Am√©ricas
                if (lat > 30) return 'norte';
                if (lat < 10) return 'sur';
                return 'centro';
            } else if (lng > 100) { // Asia Oriental
                if (lat > 35) return 'norte';
                if (lat < 20) return 'sur';
                return 'centro';
            } else { // Europa, √Åfrica, etc.
                if (lat > 50) return 'norte';
                if (lat < 35) return 'sur';
                return 'centro';
            }
        }

        // Detectar zonas para todas las ciudades
        async function detectAllZones() {
            if (cities.length === 0) {
                alert('No hay ciudades para analizar');
                return;
            }

            document.getElementById('zoneSearchStatus').style.display = 'block';
            document.getElementById('zoneStatusText').textContent = `Analizando ${cities.length} ciudades...`;

            let zonesDetected = 0;
            const uniqueZones = new Set();

            for (let i = 0; i < cities.length; i++) {
                const city = cities[i];
                document.getElementById('zoneStatusText').textContent = 
                    `Analizando: ${city.name} (${i + 1}/${cities.length})`;

                if (!city.zone) {
                    const zone = await detectGeographicZone(city.coords[0], city.coords[1], city.type);
                    city.zone = zone;
                    zonesDetected++;
                }
                
                uniqueZones.add(city.zone);

                // Peque√±a pausa para no saturar
                await new Promise(resolve => setTimeout(resolve, 300));
            }

            document.getElementById('zoneSearchStatus').style.display = 'none';
            renderCities();
            updateStatistics();
            
            alert(`¬°Zonas detectadas! Se analizaron ${zonesDetected} ciudades en ${uniqueZones.size} zonas diferentes.`);
        }

        function addCountry() {
            const id = document.getElementById('countryId').value;
            const name = document.getElementById('countryName').value;
            const emoji = document.getElementById('countryEmoji').value;
            const color = document.getElementById('countryColor').value;

            if (!id || !name) {
                alert('Por favor completa todos los campos');
                return;
            }

            countries[id] = {
                name: name,
                emoji: emoji,
                buttonText: name.substring(0, 10),
                layerText: `üìç ${name}`
            };

            renderCountries();
            bootstrap.Modal.getInstance(document.getElementById('countryModal')).hide();
            updateStatistics();
        }

        function addCity() {
            const name = document.getElementById('cityName').value;
            const countryId = document.getElementById('cityCountry').value;
            const description = document.getElementById('cityDescription').value;
            const lat = parseFloat(document.getElementById('cityLat').value);
            const lng = parseFloat(document.getElementById('cityLng').value);
            const zone = document.getElementById('cityZone').value;

            if (!name || !countryId || isNaN(lat) || isNaN(lng)) {
                alert('Por favor completa todos los campos correctamente');
                return;
            }

            const city = {
                id: 'city-' + Date.now(),
                name: name,
                country: countries[countryId]?.name || countryId,
                coords: [lat, lng],
                type: countryId,
                description: description,
                zone: zone || 'por detectar'
            };

            cities.push(city);
            renderCities();
            updateMap();
            bootstrap.Modal.getInstance(document.getElementById('cityModal')).hide();
            updateStatistics();
        }

        // Renderizado
        function renderCountries() {
            const container = document.getElementById('countries-container');
            container.innerHTML = Object.keys(countries).map(key => `
                <div class="draggable-item" draggable="true" ondragstart="dragStart(event, 'country', '${key}')" ondragend="dragEnd(event)">
                    <span class="color-badge" style="background-color: ${getCountryColor(key)}"></span>
                    <strong>${countries[key].emoji} ${countries[key].name}</strong>
                    <br><small>ID: ${key}</small>
                    <button class="btn btn-sm btn-outline-danger delete-btn" onclick="deleteCountry('${key}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function renderCities() {
            const container = document.getElementById('cities-container');
            container.innerHTML = cities.map(city => {
                const zoneBadge = city.zone && city.zone !== 'por detectar' ? 
                    `<span class="zone-badge ${city.zone}">${city.zone.toUpperCase()}</span>` : '';
                
                return `
                <div class="draggable-item" draggable="true" ondragstart="dragStart(event, 'city', '${city.id}')" ondragend="dragEnd(event)">
                    <strong>${city.name}</strong>
                    <span class="badge" style="background-color: ${getCountryColor(city.type)}">${countries[city.type]?.emoji || ''}</span>
                    ${zoneBadge}
                    <br>
                    <small>${city.coords[0].toFixed(4)}, ${city.coords[1].toFixed(4)}</small>
                    <button class="btn btn-sm btn-outline-danger delete-btn" onclick="deleteCity('${city.id}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `}).join('');
        }

        // Funciones de eliminaci√≥n
        function deleteCountry(countryId) {
            if (confirm(`¬øEliminar pa√≠s ${countries[countryId]?.name} y todas sus ciudades?`)) {
                delete countries[countryId];
                cities = cities.filter(c => c.type !== countryId);
                routes = routes.filter(r => r.country !== countryId);
                renderCountries();
                renderCities();
                updateMap();
                updateStatistics();
            }
        }

        function deleteCity(cityId) {
            cities = cities.filter(c => c.id !== cityId);
            renderCities();
            updateMap();
            updateStatistics();
        }

        // Actualizar mapa
        function updateMap() {
            // Limpiar mapa
            map.eachLayer(layer => {
                if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                    map.removeLayer(layer);
                }
            });

            // Agregar marcadores de ciudades
            cities.forEach(city => {
                const country = countries[city.type];
                if (country) {
                    const marker = L.marker(city.coords).addTo(map)
                        .bindPopup(`
                            <strong>${city.name}</strong><br>
                            ${country.emoji} ${city.country}<br>
                            ${city.zone ? `<small>Zona: ${city.zone.toUpperCase()}</small><br>` : ''}
                            <small>${city.description}</small>
                        `);
                }
            });

            // Agregar rutas terrestres
            routes.forEach(route => {
                if (route.coordinates.length >= 2) {
                    const color = getCountryColor(route.country);
                    L.polyline(route.coordinates, {
                        color: color,
                        weight: 5,
                        opacity: 0.8
                    }).addTo(map).bindTooltip(route.tooltip);
                }
            });

            // Agregar vuelos
            flights.forEach(flight => {
                if (flight.coordinates.length === 2) {
                    L.polyline(flight.coordinates, {
                        color: '#6a0dad',
                        weight: 3,
                        opacity: 0.6,
                        dashArray: '10, 10'
                    }).addTo(map).bindTooltip(flight.tooltip);
                }
            });
        }

        function updateMapView() {
            const zoom = parseInt(document.getElementById('mapZoom').value);
            map.setZoom(zoom);
        }

        // Calcular zoom √≥ptimo autom√°ticamente
        function calculateOptimalZoom() {
            if (cities.length === 0) {
                alert('No hay ciudades para calcular el zoom');
                return 4;
            }
            
            const group = L.featureGroup(
                cities.map(city => L.marker(city.coords))
            );
            
            const bounds = group.getBounds();
            map.fitBounds(bounds, { padding: [50, 50] });
            
            const optimalZoom = map.getZoom();
            document.getElementById('mapZoom').value = optimalZoom;
            document.getElementById('optimalZoom').textContent = optimalZoom;
            
            return optimalZoom;
        }

        // Utilidades
        function getCountryColor(countryId) {
            const defaultColors = {
                'korea': '#4a6fa5',
                'japan': '#bc002d', 
                'china': '#de2910',
                'custom': '#6a0dad'
            };
            return defaultColors[countryId] || '#666666';
        }

        function updateStatistics() {
            const uniqueZones = new Set(cities.map(c => c.zone).filter(zone => zone && zone !== 'por detectar'));
            
            document.getElementById('countriesCount').textContent = Object.keys(countries).length;
            document.getElementById('citiesCount').textContent = cities.length;
            document.getElementById('routesCount').textContent = routes.length + flights.length;
            document.getElementById('zonesCount').textContent = uniqueZones.size;
        }

        // Generar JSON
        function generateJSON() {
            const optimalZoom = calculateOptimalZoom();
            
            const config = {
                title: document.getElementById('mapTitle').value,
                subtitle: "Mapa generado con detecci√≥n de zonas",
                initialView: {
                    lat: map.getCenter().lat,
                    lng: map.getCenter().lng,
                    zoom: optimalZoom
                },
                controls: {
                    enabled: true,
                    position: "topright"
                },
                showRoutes: true,
                showFlights: true,
                colors: {
                    flight: "#6a0dad",
                    custom: "#6a0dad"
                },
                countries: countries
            };

            // Agregar colores de pa√≠ses
            Object.keys(countries).forEach(key => {
                config.colors[key] = getCountryColor(key);
            });

            const finalJSON = {
                config: config,
                cities: cities.map(c => ({
                    name: c.name,
                    country: c.country,
                    coords: c.coords,
                    type: c.type,
                    description: c.description,
                    zone: c.zone
                })),
                routes: routes,
                flights: flights
            };

            document.getElementById('jsonOutput').textContent = JSON.stringify(finalJSON, null, 2);
        }

        function copyToClipboard() {
            const jsonOutput = document.getElementById('jsonOutput');
            navigator.clipboard.writeText(jsonOutput.textContent).then(() => {
                alert('JSON copiado al portapapeles!');
            });
        }

        function clearAllData() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar todos los datos?')) {
                countries = {};
                cities = [];
                routes = [];
                flights = [];
                currentLandRouteCities = [];
                currentFlightCities = [];
                
                renderCountries();
                renderCities();
                updateLandRouteVisualizer();
                updateFlightRouteVisualizer();
                updateMap();
                updateStatistics();
                
                document.getElementById('jsonOutput').textContent = '// El JSON se generar√° aqu√≠...';
            }
        }

        // Cargar datos de ejemplo
        function loadExampleData() {
            clearAllData();
            
            // Pa√≠ses de ejemplo
            countries = {
                korea: {
                    name: "Corea del Sur",
                    emoji: "üá∞üá∑",
                    buttonText: "Corea",
                    layerText: "üìç Corea del Sur"
                },
                japan: {
                    name: "Jap√≥n",
                    emoji: "üáØüáµ",
                    buttonText: "Jap√≥n",
                    layerText: "üìç Jap√≥n"
                },
                china: {
                    name: "China",
                    emoji: "üá®üá≥",
                    buttonText: "China",
                    layerText: "üìç China"
                },
                custom: {
                    name: "Otros Destinos",
                    emoji: "üåç",
                    buttonText: "Otros",
                    layerText: "üìç Otros Destinos"
                }
            };

            // Ciudades de ejemplo con zonas
            cities = [
                {
                    id: 'city-1',
                    name: "Se√∫l",
                    country: "Corea del Sur",
                    coords: [37.5665, 126.9780],
                    type: "korea",
                    description: "La vibrante capital donde la tradici√≥n se encuentra con la modernidad.",
                    zone: "norte"
                },
                {
                    id: 'city-2', 
                    name: "Gyeongju",
                    country: "Corea del Sur",
                    coords: [35.8562, 129.2247],
                    type: "korea",
                    description: "Antigua capital del Reino Silla, conocida como 'el museo sin muros'.",
                    zone: "este"
                },
                {
                    id: 'city-3',
                    name: "Busan",
                    country: "Corea del Sur", 
                    coords: [35.1796, 129.0756],
                    type: "korea",
                    description: "Ciudad portuaria famosa por sus playas y mariscos frescos.",
                    zone: "sur"
                },
                {
                    id: 'city-4',
                    name: "Tokio",
                    country: "Jap√≥n",
                    coords: [35.6762, 139.6503],
                    type: "japan",
                    description: "La metr√≥polis m√°s poblada del mundo, centro de cultura y tecnolog√≠a.",
                    zone: "este"
                },
                {
                    id: 'city-5',
                    name: "Osaka",
                    country: "Jap√≥n",
                    coords: [34.6937, 135.5023],
                    type: "japan",
                    description: "Conocida por su comida callejera y castillo hist√≥rico.",
                    zone: "oeste"
                },
                {
                    id: 'city-6',
                    name: "Shangh√°i",
                    country: "China",
                    coords: [31.2304, 121.4737],
                    type: "china",
                    description: "Centro financiero global con rascacielos futuristas.",
                    zone: "este"
                },
                {
                    id: 'city-7',
                    name: "Xi'an",
                    country: "China",
                    coords: [34.3416, 108.9398],
                    type: "china", 
                    description: "Antigua capital imperial y hogar de los Guerreros de Terracota.",
                    zone: "centro"
                },
                {
                    id: 'city-8',
                    name: "Beijing",
                    country: "China",
                    coords: [39.9042, 116.4074],
                    type: "china",
                    description: "Capital de China con siglos de historia imperial.",
                    zone: "norte"
                }
            ];

            // Rutas de ejemplo
            routes = [
                {
                    type: "land",
                    country: "korea", 
                    coordinates: [
                        [37.5665, 126.9780],
                        [35.8562, 129.2247],
                        [35.1796, 129.0756]
                    ],
                    tooltip: "Ruta por Corea: Se√∫l ‚Üí Gyeongju ‚Üí Busan"
                }
            ];

            // Vuelos de ejemplo
            flights = [
                {
                    from: "Busan",
                    to: "Tokio",
                    coordinates: [
                        [35.1796, 129.0756],
                        [35.6762, 139.6503]
                    ],
                    tooltip: "‚úàÔ∏è Vuelo: Busan (Corea) ‚Üí Tokio (Jap√≥n)"
                }
            ];

            renderCountries();
            renderCities();
            updateMap();
            updateStatistics();
            calculateOptimalZoom();
            
            alert('Datos de ejemplo de Asia cargados correctamente!');
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            updateStatistics();
        });
    </script>
</body>
</html>
